<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°©ë¬¸ í†µê³„</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 20px;
        }
        h1 {
            font-size: 28px;
            color: #333;
            margin-bottom: 8px;
        }
        .subtitle {
            color: #666;
            font-size: 14px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 24px;
            text-align: center;
        }
        .stat-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }
        .stat-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        .stat-change {
            font-size: 12px;
            margin-top: 8px;
        }
        .stat-change.up {
            color: #10b981;
        }
        .stat-change.down {
            color: #ef4444;
        }
        .chart-section {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }
        .bottom-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .list-item:last-child {
            border-bottom: none;
        }
        .list-label {
            font-size: 14px;
            color: #555;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .list-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        .link-icon {
            font-size: 18px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .empty-message {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        .back-link {
            display: inline-block;
            margin-top: 20px;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .back-link:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .chart-section {
                grid-template-columns: 1fr;
            }
            .bottom-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="pageTitle">ğŸ“Š í†µê³„ ë¡œë”© ì¤‘...</h1>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-label">ì „ì²´ ë°©ë¬¸ì</div>
                <div class="stat-value" id="totalVisitors">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“„</div>
                <div class="stat-label">ëˆ„ì  ë°©ë¬¸ íšŸìˆ˜</div>
                <div class="stat-value" id="totalPageViews">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“…</div>
                <div class="stat-label">ì¼ì¼ ë°©ë¬¸ íšŸìˆ˜</div>
                <div class="stat-value" id="dailyPageViews">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">â±ï¸</div>
                <div class="stat-label">ì²´ë¥˜ ì‹œê°„</div>
                <div class="stat-value" id="totalDuration">-</div>
            </div>
        </div>

        <div class="chart-section">
            <div class="chart-card">
                <div class="chart-title">ğŸ–¥ï¸ ì£¼ìš” OS</div>
                <canvas id="osChart"></canvas>
            </div>
            <div class="chart-card">
                <div class="chart-title">ğŸŒ ë¸Œë¼ìš°ì €</div>
                <canvas id="browserChart"></canvas>
            </div>
            <div class="chart-card">
                <div class="chart-title">ğŸ“± ê¸°ê¸°ë³„</div>
                <canvas id="deviceChart"></canvas>
            </div>
        </div>

        <div class="bottom-grid">
            <div class="chart-card">
                <div class="chart-title">ğŸ”— ë°”ë¡œê°€ê¸° ë§í¬ í´ë¦­</div>
                <div id="linkClickList" class="loading">ë¡œë”© ì¤‘...</div>
            </div>
            <div class="chart-card">
                <div class="chart-title">ğŸ“Š í†µê³„ ìš”ì•½</div>
                <div id="statsSummary" class="loading">ë¡œë”© ì¤‘...</div>
            </div>
        </div>

        <a href="/" class="back-link">â† í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>

    <script>
        // URLì—ì„œ subdomain íŒŒë¼ë¯¸í„° ì¶”ì¶œ
        const urlParams = new URLSearchParams(window.location.search);
        const subdomain = urlParams.get('subdomain');
        const days = parseInt(urlParams.get('days')) || 30;

        if (!subdomain) {
            alert('ê±°ë˜ì²˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤');
            window.location.href = '/';
        }

        // ë§í¬ íƒ€ì…ë³„ ì•„ì´ì½˜
        const linkIcons = {
            naver_blog: 'ğŸ“',
            instagram: 'ğŸ“·',
            facebook: 'ğŸ‘¥',
            youtube: 'â–¶ï¸',
            naver_place: 'ğŸ“',
            smartstore: 'ğŸ›’',
            kakaotalk: 'ğŸ’¬',
            phone: 'ğŸ“',
            email: 'âœ‰ï¸',
            other: 'ğŸ”—'
        };

        // ë§í¬ íƒ€ì…ë³„ í•œê¸€ ì´ë¦„
        const linkLabels = {
            naver_blog: 'ë„¤ì´ë²„ ë¸”ë¡œê·¸',
            instagram: 'ì¸ìŠ¤íƒ€ê·¸ë¨',
            facebook: 'í˜ì´ìŠ¤ë¶',
            youtube: 'ìœ íŠœë¸Œ',
            naver_place: 'ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤',
            smartstore: 'ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´',
            kakaotalk: 'ì¹´ì¹´ì˜¤í†¡',
            phone: 'ì „í™”',
            email: 'ì´ë©”ì¼',
            other: 'ê¸°íƒ€'
        };

        // URLì—ì„œ ë§í¬ íƒ€ì… ê°ì§€
        function detectLinkType(url) {
            if (url.includes('blog.naver.com')) return 'naver_blog';
            if (url.includes('instagram.com')) return 'instagram';
            if (url.includes('facebook.com')) return 'facebook';
            if (url.includes('youtube.com') || url.includes('youtu.be')) return 'youtube';
            if (url.includes('map.naver.com') || url.includes('place.map')) return 'naver_place';
            if (url.includes('smartstore.naver.com')) return 'smartstore';
            if (url.includes('kakaotalk') || url.includes('kakao.com')) return 'kakaotalk';
            if (url.includes('tel:')) return 'phone';
            if (url.includes('mailto:')) return 'email';
            return 'other';
        }

        // ì‹œíŠ¸ì—ì„œ ê±°ë˜ì²˜ ë°”ë¡œê°€ê¸° ë§í¬ ì¡°íšŒ
        async function fetchClientLinks() {
            try {
                const sheetUrl = `https://docs.google.com/spreadsheets/d/1KrzLFi8Wt9GTGT97gcMoXnbZ3OJ04NsP4lncJyIdyhU/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent('ê´€ë¦¬ì')}`;
                const response = await fetch(sheetUrl);
                const csv = await response.text();

                const lines = csv.split('\n').filter(line => line.trim());
                if (lines.length < 2) return { name: subdomain, links: [] };

                const headers = lines[0].split(',').map(h => h.replace(/^"|"$/g, '').trim());
                const linksIndex = headers.indexOf('ê±°ë˜ì²˜ ë°”ë¡œê°€ê¸°');
                const nameIndex = headers.indexOf('ê±°ë˜ì²˜ ìƒí˜¸ëª…');
                const domainIndex = headers.indexOf('ë„ë©”ì¸');

                if (linksIndex === -1) return { name: subdomain, links: [] };

                for (let i = 1; i < lines.length; i++) {
                    const cells = lines[i].split(',').map(c => c.replace(/^"|"$/g, '').trim());
                    const domain = cells[domainIndex] || '';

                    if (domain.startsWith(subdomain)) {
                        const linksStr = cells[linksIndex] || '';
                        const name = cells[nameIndex] || subdomain;

                        const links = linksStr
                            .split(',')
                            .map(url => url.trim())
                            .filter(url => url && url.startsWith('http'))
                            .filter(url => !url.includes('umami.is')); // ìš°ë§ˆë¯¸ ì œì™¸

                        return { name, links };
                    }
                }

                return { name: subdomain, links: [] };
            } catch (error) {
                console.error('Failed to fetch client links:', error);
                return { name: subdomain, links: [] };
            }
        }

        // Firestore í†µê³„ ë°ì´í„° ì¡°íšŒ
        async function fetchStatsData() {
            try {
                const response = await fetch(`/api/stats-data?subdomain=${subdomain}&days=${days}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Failed to fetch stats data:', error);
                return null;
            }
        }

        // í†µê³„ ë Œë”ë§
        async function renderStats() {
            // ë³‘ë ¬ë¡œ ë°ì´í„° ì¡°íšŒ
            const [clientData, statsData] = await Promise.all([
                fetchClientLinks(),
                fetchStatsData()
            ]);

            if (!statsData) {
                alert('í†µê³„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            const { visitStats, linkClickStats } = statsData;

            // ì œëª© ì—…ë°ì´íŠ¸
            document.getElementById('pageTitle').textContent = `ğŸ“Š ${clientData.name} - ë°©ë¬¸ í†µê³„`;

            // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
            document.getElementById('totalVisitors').textContent = visitStats.uniqueVisitors.toLocaleString();
            document.getElementById('totalPageViews').textContent = visitStats.totalPageViews.toLocaleString();
            document.getElementById('dailyPageViews').textContent = visitStats.dailyPageViews.toLocaleString();

            // ì²´ë¥˜ ì‹œê°„ í¬ë§· (ë¶„ â†’ ì‹œ:ë¶„)
            const hours = Math.floor(visitStats.totalDurationMinutes / 60);
            const minutes = visitStats.totalDurationMinutes % 60;
            const durationText = hours > 0 ? `${hours}ì‹œê°„ ${minutes}ë¶„` : `${minutes}ë¶„`;
            document.getElementById('totalDuration').textContent = durationText;

            // OS ì°¨íŠ¸
            const osLabels = ['Android', 'iOS', 'Windows', 'macOS', 'Linux', 'ê¸°íƒ€'];
            const osData = osLabels.map(label =>
                label === 'ê¸°íƒ€' ? (visitStats.osStats.other || 0) : (visitStats.osStats[label] || 0)
            );

            const osCtx = document.getElementById('osChart').getContext('2d');
            new Chart(osCtx, {
                type: 'doughnut',
                data: {
                    labels: osLabels,
                    datasets: [{
                        data: osData,
                        backgroundColor: ['#34d399', '#60a5fa', '#fbbf24', '#a78bfa', '#f87171', '#94a3b8']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 11 } } }
                    }
                }
            });

            // ë¸Œë¼ìš°ì € ì°¨íŠ¸
            const browserLabels = ['Chrome', 'Safari', 'Edge', 'Firefox', 'Samsung Internet', 'ê¸°íƒ€'];
            const browserData = browserLabels.map(label =>
                label === 'ê¸°íƒ€' ? (visitStats.browserStats.other || 0) : (visitStats.browserStats[label] || 0)
            );

            const browserCtx = document.getElementById('browserChart').getContext('2d');
            new Chart(browserCtx, {
                type: 'doughnut',
                data: {
                    labels: browserLabels,
                    datasets: [{
                        data: browserData,
                        backgroundColor: ['#667eea', '#764ba2', '#06b6d4', '#f59e0b', '#ec4899', '#94a3b8']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 11 } } }
                    }
                }
            });

            // ê¸°ê¸°ë³„ ì°¨íŠ¸
            const deviceLabels = ['ëª¨ë°”ì¼', 'íƒœë¸”ë¦¿', 'PC', 'ê¸°íƒ€'];
            const deviceData = [
                visitStats.deviceStats.mobile || 0,
                visitStats.deviceStats.tablet || 0,
                visitStats.deviceStats.pc || 0,
                visitStats.deviceStats.other || 0
            ];

            const deviceCtx = document.getElementById('deviceChart').getContext('2d');
            new Chart(deviceCtx, {
                type: 'doughnut',
                data: {
                    labels: deviceLabels,
                    datasets: [{
                        data: deviceData,
                        backgroundColor: ['#667eea', '#f093fb', '#764ba2', '#94a3b8']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 11 } } }
                    }
                }
            });

            // ë§í¬ë³„ í´ë¦­ í†µê³„ ë§¤í•‘
            const clicksMap = {};
            linkClickStats.linkStats.forEach(stat => {
                clicksMap[stat.type] = stat.clicks;
            });

            // ë°”ë¡œê°€ê¸° ë§í¬ í´ë¦­ í†µê³„ ë Œë”ë§
            const linkClickList = document.getElementById('linkClickList');
            if (clientData.links.length > 0) {
                const linkItems = clientData.links.map(url => {
                    const type = detectLinkType(url);
                    const label = linkLabels[type] || type;
                    const icon = linkIcons[type] || 'ğŸ”—';
                    const clicks = clicksMap[type] || 0;

                    return `
                        <div class="list-item">
                            <span class="list-label">
                                <span class="link-icon">${icon}</span>
                                ${label}
                            </span>
                            <span class="list-value">${clicks}íšŒ</span>
                        </div>
                    `;
                }).join('');
                linkClickList.innerHTML = linkItems;
            } else {
                linkClickList.innerHTML = '<div class="empty-message">ë°”ë¡œê°€ê¸° ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            }

            // í†µê³„ ìš”ì•½ ë Œë”ë§
            const statsSummary = document.getElementById('statsSummary');
            statsSummary.innerHTML = `
                <div class="list-item">
                    <span class="list-label">ì´ ë°©ë¬¸ì</span>
                    <span class="list-value">${visitStats.uniqueVisitors.toLocaleString()}</span>
                </div>
                <div class="list-item">
                    <span class="list-label">ì´ í˜ì´ì§€ë·°</span>
                    <span class="list-value">${visitStats.totalPageViews.toLocaleString()}</span>
                </div>
                <div class="list-item">
                    <span class="list-label">ì´ ë§í¬ í´ë¦­</span>
                    <span class="list-value">${linkClickStats.totalClicks.toLocaleString()}</span>
                </div>
                <div class="list-item">
                    <span class="list-label">ì§‘ê³„ ê¸°ê°„</span>
                    <span class="list-value">${days}ì¼</span>
                </div>
            `;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        renderStats();
    </script>
</body>
</html>
