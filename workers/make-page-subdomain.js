{
  "name": "make-page-subdomain.js",
  "path": "workers/make-page-subdomain.js",
  "sha": "8237cf1368ceb6189926772598ad32b5ceeb8ef2",
  "size": 97325,
  "url": "https://api.github.com/repos/jeonwoohyun85/content-factory/contents/workers/make-page-subdomain.js?ref=main",
  "html_url": "https://github.com/jeonwoohyun85/content-factory/blob/main/workers/make-page-subdomain.js",
  "git_url": "https://api.github.com/repos/jeonwoohyun85/content-factory/git/blobs/8237cf1368ceb6189926772598ad32b5ceeb8ef2",
  "download_url": "https://raw.githubusercontent.com/jeonwoohyun85/content-factory/main/workers/make-page-subdomain.js?token=B3OYCXICZBZ76AQMMGD74NDJPWCZZAA",
  "type": "file",
  "content": "// Content Factory - Minimal Version (Google Sheets Only)\n// Í±∞ÎûòÏ≤ò ÌéòÏù¥ÏßÄÎßå Ï†úÍ≥µ (ÎûúÎî©ÌéòÏù¥ÏßÄ, Î∏îÎ°úÍ∑∏, Supabase Ï†ÑÎ∂Ä Ï†úÍ±∞)\n\n// ==================== Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò ====================\n\n// Ï†ÑÏó≠ Î≤àÏó≠ Ï∫êÏãú (Worker Ïû¨ÏãúÏûë Ï†ÑÍπåÏßÄ Ïú†ÏßÄ)\nconst TRANSLATION_CACHE = {};\n\n// TimeoutÏù¥ ÏûàÎäî fetch\nasync function fetchWithTimeout(url, options = {}, timeoutMs = 10000) {\n  const controller = new AbortController();\n  const timeoutId = setTimeout(() => controller.abort(), timeoutMs);\n\n  try {\n    const response = await fetch(url, {\n      ...options,\n      signal: controller.signal\n    });\n    clearTimeout(timeoutId);\n    return response;\n  } catch (error) {\n    clearTimeout(timeoutId);\n    throw error;\n  }\n}\n\n// HTML Ïù¥Ïä§ÏºÄÏù¥ÌîÑ (XSS Î∞©ÏßÄ)\nfunction escapeHtml(text) {\n  if (!text) return '';\n  const map = {\n    '&': '&amp;',\n    '<': '&lt;',\n    '>': '&gt;',\n    '\"': '&quot;',\n    \"'\": '&#039;'\n  };\n  return text.toString().replace(/[&<>'\"']/g, m => map[m]);\n}\n\n// SHA-256 Ìï¥Ïã± (visitor_hash ÏÉùÏÑ±Ïö©)\n\n// Umami Cloud Analytics\nconst UMAMI_WEBSITE_ID = 'aea13630-0836-4fd6-91ae-d04b4180b6e7';\n\n// Ïñ∏Ïñ¥ ÏΩîÎìú Ï†ïÍ∑úÌôî (Ï£ºÏöî Ïñ∏Ïñ¥Îßå Îß§Ìïë, ÎÇòÎ®∏ÏßÄÎäî ÏûÖÎ†•Í∞í Í∑∏ÎåÄÎ°ú)\nfunction normalizeLanguage(lang) {\n  if (!lang) return 'ko';\n  const lower = lang.toLowerCase();\n  \n  // Ï£ºÏöî 5Í∞ú Ïñ∏Ïñ¥Îßå Ï≤¥ÌÅ¨ (ÌïòÎìúÏΩîÎî©Îêú Î≤àÏó≠ Îç∞Ïù¥ÌÑ∞)\n  if (lower.includes('ÌïúÍµ≠') || lower.includes('ÌïúÍ∏Ä') || lower.includes('korean') || lower === 'ko') return 'ko';\n  if (lower.includes('ÏòÅÏñ¥') || lower.includes('english') || lower === 'en') return 'en';\n  if (lower.includes('ÏùºÎ≥∏') || lower.includes('japanese') || lower === 'ja') return 'ja';\n  if (lower.includes('Ï§ëÍµ≠') || lower.includes('Í∞ÑÏ≤¥') || lower.includes('simplified') || lower.includes('chinese') || lower === 'zh' || lower === 'zh-cn') return 'zh-CN';\n  if (lower.includes('Î≤àÏ≤¥') || lower.includes('traditional') || lower === 'zh-tw') return 'zh-TW';\n  \n  // ÎÇòÎ®∏ÏßÄÎäî ÏûÖÎ†•Í∞í Í∑∏ÎåÄÎ°ú Î∞òÌôò (APIÏóêÏÑú Ï≤òÎ¶¨)\n  return lang;\n}\n\n// Ï£ºÏöî Ïñ∏Ïñ¥ ÌïòÎìúÏΩîÎî© Î≤àÏó≠ Îç∞Ïù¥ÌÑ∞\nconst LANGUAGE_TEXTS = {\n  ko: {\n    info: 'Info',\n    video: 'Video',\n    posts: 'Posts',\n    backToHome: 'ÌôàÏúºÎ°ú',\n    phone: 'Ï†ÑÌôîÌïòÍ∏∞',\n    instagram: 'Ïù∏Ïä§ÌÉÄÍ∑∏Îû®',\n    youtube: 'Ïú†ÌäúÎ∏å',\n    facebook: 'ÌéòÏù¥Ïä§Î∂Å',\n    kakao: 'Ïπ¥Ïπ¥Ïò§ÌÜ°',\n    location: 'ÏúÑÏπòÎ≥¥Í∏∞',\n    blog: 'Î∏îÎ°úÍ∑∏',\n    store: 'Ïä§ÌÜ†Ïñ¥',\n    booking: 'ÏòàÏïΩÌïòÍ∏∞',\n    link: 'ÎßÅÌÅ¨',\n    stats: 'ÌÜµÍ≥Ñ'\n  },\n  en: {\n    info: 'Gallery',\n    video: 'Videos',\n    posts: 'Posts',\n    backToHome: 'Back to Home',\n    phone: 'Call',\n    instagram: 'Instagram',\n    youtube: 'YouTube',\n    facebook: 'Facebook',\n    kakao: 'KakaoTalk',\n    location: 'Location',\n    blog: 'Blog',\n    store: 'Store',\n    booking: 'Book Now',\n    link: 'Link',\n    stats: 'Stats'\n  },\n  ja: {\n    info: '„ÇÆ„É£„É©„É™„Éº',\n    video: 'ÂãïÁîª',\n    posts: 'ÊäïÁ®ø',\n    backToHome: '„Éõ„Éº„É†„Å´Êàª„Çã',\n    phone: 'ÈõªË©±„Åô„Çã',\n    instagram: '„Ç§„É≥„Çπ„Çø„Ç∞„É©„É†',\n    youtube: '„É¶„Éº„ÉÅ„É•„Éº„Éñ',\n    facebook: '„Éï„Çß„Ç§„Çπ„Éñ„ÉÉ„ÇØ',\n    kakao: '„Ç´„Ç´„Ç™„Éà„Éº„ÇØ',\n    location: '‰ΩçÁΩÆ„ÇíË¶ã„Çã',\n    blog: '„Éñ„É≠„Ç∞',\n    store: '„Çπ„Éà„Ç¢',\n    booking: '‰∫àÁ¥Ñ„Åô„Çã',\n    link: '„É™„É≥„ÇØ',\n    stats: 'Áµ±Ë®à'\n  },\n  'zh-CN': {\n    info: 'ÁîªÂªä',\n    video: 'ËßÜÈ¢ë',\n    posts: 'Â∏ñÂ≠ê',\n    backToHome: 'ËøîÂõû‰∏ªÈ°µ',\n    phone: 'ÊâìÁîµËØù',\n    instagram: 'Instagram',\n    youtube: 'YouTube',\n    facebook: 'Facebook',\n    kakao: 'KakaoTalk',\n    location: 'Êü•Áúã‰ΩçÁΩÆ',\n    blog: 'ÂçöÂÆ¢',\n    store: 'ÂïÜÂ∫ó',\n    booking: 'È¢ÑËÆ¢',\n    link: 'ÈìæÊé•',\n    stats: 'ÁªüËÆ°'\n  },\n  'zh-TW': {\n    info: 'Áï´Âªä',\n    video: 'ÂΩ±Áâá',\n    posts: 'Ë≤ºÊñá',\n    backToHome: 'ËøîÂõû‰∏ªÈ†Å',\n    phone: 'ÊâìÈõªË©±',\n    instagram: 'Instagram',\n    youtube: 'YouTube',\n    facebook: 'Facebook',\n    kakao: 'KakaoTalk',\n    location: 'Êü•Áúã‰ΩçÁΩÆ',\n    blog: 'ÈÉ®ËêΩÊ†º',\n    store: 'ÂïÜÂ∫ó',\n    booking: 'È†êË®Ç',\n    link: 'ÈÄ£Áµê',\n    stats: 'Áµ±Ë®à'\n  }\n};\n\n// GeminiÎ°ú Ïñ∏Ïñ¥ Î≤àÏó≠ (2.5 Flash)\nasync function translateWithGemini(language, env) {\n  const prompt = `Translate the following UI text items to ${language}. Return ONLY a valid JSON object with these exact keys, no markdown formatting, no code blocks:\n\n{\n  \"info\": \"Gallery/Photos section title\",\n  \"video\": \"Videos section title\",\n  \"posts\": \"Blog posts section title\",\n  \"backToHome\": \"Back to home link text\",\n  \"phone\": \"Call/Phone button\",\n  \"instagram\": \"Instagram link\",\n  \"youtube\": \"YouTube link\",\n  \"facebook\": \"Facebook link\",\n  \"kakao\": \"KakaoTalk link\",\n  \"location\": \"Location/Map link\",\n  \"blog\": \"Blog link\",\n  \"booking\": \"Booking/Reservation button\",\n  \"link\": \"Generic link text\"\n}\n\nIMPORTANT: Return ONLY the JSON object, no other text.`;\n\n  const response = await fetch(\n    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${env.GEMINI_API_KEY}`,\n    {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        contents: [{\"parts\": [{\"text\": prompt}]}],\n        generationConfig: {\n          temperature: 0.3,\n          maxOutputTokens: 500\n        }\n      })\n    }\n  );\n\n  const data = await response.json();\n  const text = data.candidates[0].content.parts[0].text;\n  \n  // JSON Ï∂îÏ∂ú\n  const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    return JSON.parse(jsonMatch[0]);\n  }\n  \n  // Ïã§Ìå® Ïãú ÏòÅÏñ¥ Î∞òÌôò\n  return LANGUAGE_TEXTS.en;\n}\n\n// Ïñ∏Ïñ¥Î≥Ñ ÌÖçÏä§Ìä∏ Í∞ÄÏ†∏Ïò§Í∏∞ (Ï∫êÏãú ‚Üí ÌïòÎìúÏΩîÎî© ‚Üí API)\nasync function getLanguageTexts(langCode, env) {\n  // 1. Ï∫êÏãú ÌôïÏù∏\n  if (TRANSLATION_CACHE[langCode]) {\n    return TRANSLATION_CACHE[langCode];\n  }\n  \n  // 2. ÌïòÎìúÏΩîÎî©Îêú Ïñ∏Ïñ¥\n  if (LANGUAGE_TEXTS[langCode]) {\n    return LANGUAGE_TEXTS[langCode];\n  }\n  \n  // 3. API Ìò∏Ï∂ú (Ï≤´ ÏöîÏ≤≠Îßå)\n  try {\n    const texts = await translateWithGemini(langCode, env);\n    TRANSLATION_CACHE[langCode] = texts;\n    return texts;\n  } catch (error) {\n    console.error(`Translation error for ${langCode}:`, error);\n    // Ïã§Ìå® Ïãú ÏòÅÏñ¥ Î∞òÌôò\n    return LANGUAGE_TEXTS.en;\n  }\n}\n\n// CSV ÌååÏã± (ÌÅ∞Îî∞Ïò¥ÌëúÎ°ú Í∞êÏã∏ÏßÑ ÌïÑÎìú Ï≤òÎ¶¨)\nfunction parseCSV(csvText) {\n  const lines = csvText.trim().split('\\n');\n\n  // Ìó§Îçî ÌååÏã± (BOM Ï†úÍ±∞ Î∞è Í≥µÎ∞± Ï†úÍ±∞)\n  const headers = parseCSVLine(lines[0]).map(h => h.replace(/^\\uFEFF/, '').trim());\n\n  const clients = [];\n  for (let i = 1; i < lines.length; i++) {\n    const values = parseCSVLine(lines[i]);\n    const client = {};\n    headers.forEach((header, index) => {\n      client[header] = values[index] || '';\n    });\n    clients.push(client);\n  }\n  return clients;\n}\n\n// CSV Ìïú Ï§Ñ ÌååÏã± (ÌÅ∞Îî∞Ïò¥Ìëú Ï≤òÎ¶¨)\nfunction parseCSVLine(line) {\n  const result = [];\n  let current = '';\n  let inQuotes = false;\n\n  for (let i = 0; i < line.length; i++) {\n    const char = line[i];\n\n    if (char === '\"') {\n      inQuotes = !inQuotes;\n    } else if (char === ',' && !inQuotes) {\n      result.push(current.trim());\n      current = '';\n    } else {\n      current += char;\n    }\n  }\n\n  result.push(current.trim());\n  return result;\n}\n\n// ÌïúÍ∏Ä Ïª¨ÎüºÎ™ÖÏùÑ ÏòÅÏñ¥ ÌÇ§Î°ú Ï†ïÍ∑úÌôî\nfunction normalizeClient(client) {\n  const mapping = {\n    'ÎèÑÎ©îÏù∏': 'subdomain',\n    'ÏÑúÎ∏åÎèÑÎ©îÏù∏': 'subdomain',\n    'ÏÉÅÌò∏Î™Ö': 'business_name',\n    'ÏóÖÏ≤¥': 'partner_name',\n    'Ï£ºÏÜå': 'address',\n    'Ïñ∏Ïñ¥': 'language',\n    'Ïó∞ÎùΩÏ≤ò': 'phone',\n    'Ï†ÑÌôîÎ≤àÌò∏': 'phone',\n    'ÏòÅÏóÖÏãúÍ∞Ñ': 'business_hours',\n    'ÌÇ§ÏõåÎìú_ÏóÖÏ≤¥': 'description',\n    'Í±∞ÎûòÏ≤ò_Ï†ïÎ≥¥': 'description',\n    'ÏÜåÍ∞ú': 'description',\n    'ÎπÑÍ≥†Í∏∞ÌÉÄ': 'links',\n    'Î∞îÎ°úÍ∞ÄÍ∏∞': 'links',\n    'info': 'info',\n    'video': 'video',\n    'ÏóÖÏ¢Ö': 'industry',\n    'ÌÅ¨Î°†': 'cron',\n    'Íµ¨ÎèÖ': 'subscription',\n    'ÏÉÅÌÉú': 'posting_status',\n    'Ìè¥ÎçîÎ™Ö': 'folder_name'\n  };\n\n  const normalized = {};\n\n  // Í∏∞Ï°¥ ÌÇ§ Î≥µÏÇ¨\n  Object.keys(client).forEach(key => {\n    const mappedKey = mapping[key] || key;\n    normalized[mappedKey] = client[key];\n  });\n\n  return normalized;\n}\n\n// Google SheetsÏóêÏÑú Í±∞ÎûòÏ≤ò Ï†ïÎ≥¥ Ï°∞Ìöå\nasync function getClientFromSheets(clientId, env) {\n  try {\n    const SHEET_URL = env.GOOGLE_SHEETS_CSV_URL || 'https://docs.google.com/spreadsheets/d/1KrzLFi8Wt9GTGT97gcMoXnbZ3OJ04NsP4lncJyIdyhU/export?format=csv&gid=0';\n    const response = await fetchWithTimeout(SHEET_URL, {}, 10000);\n    const csvText = await response.text();\n    \n    // ÏàòÎèô ÌååÏã± Î∞è ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥ ÏàòÏßë\n    const lines = csvText.trim().split('\\n');\n    const headers = parseCSVLine(lines[0]).map(h => h.replace(/^\\uFEFF/, '').trim());\n    const debugInfo = { headers, rawLine: lines[0] };\n\n    const clients = [];\n    for (let i = 1; i < lines.length; i++) {\n      const values = parseCSVLine(lines[i]);\n      const client = {};\n      headers.forEach((header, index) => {\n        client[header] = values[index] || '';\n      });\n      clients.push(client);\n    }\n\n    const normalizedClients = clients.map(normalizeClient);\n\n    const client = normalizedClients.find(c => {\n      // subdomain Ï†ïÍ∑úÌôî: \"00001.make-page.com\" ‚Üí \"00001\"\n      let normalizedSubdomain = c.subdomain || '';\n      if (normalizedSubdomain.includes('.make-page.com')) {\n        normalizedSubdomain = normalizedSubdomain.replace('.make-page.com', '').replace('/', '');\n      }\n      return normalizedSubdomain === clientId;\n    });\n\n    // Posts Ï°∞Ìöå Ï∂îÍ∞Ä (ÏµúÏã† Ìè¨Ïä§ÌåÖ ÏãúÌä∏ÏóêÏÑú ÏùΩÍ∏∞)\n    if (client) {\n      const postsResult = await getPostsFromArchive(clientId, env);\n      client.posts = postsResult.posts;\n      if (postsResult.error) {\n        debugInfo.postsError = postsResult.error;\n      }\n    }\n\n    return { client, debugInfo };\n  } catch (error) {\n    console.error('Google Sheets fetch error:', error);\n    return { client: null, debugInfo: { error: error.message } };\n  }\n}\n\n// UTC ÏãúÍ∞ÑÏùÑ ÌïúÍµ≠ ÏãúÍ∞ÑÏúºÎ°ú Î≥ÄÌôò\nfunction formatKoreanTime(isoString) {\n  if (!isoString) return '';\n\n  try {\n    // ÏãúÌä∏Ïóê Ïù¥ÎØ∏ KST ÏãúÍ∞ÑÏù¥ Ï†ÄÏû•ÎêòÏñ¥ ÏûàÏúºÎØÄÎ°ú Í∑∏ÎåÄÎ°ú ÌååÏã±\n    const match = isoString.match(/^(\\d{4})-(\\d{2})-(\\d{2})\\s+(\\d{2}):(\\d{2})/);\n    if (match) {\n      const [_, year, month, day, hours, minutes] = match;\n      return `${year}-${month}-${day} ${hours}:${minutes}`;\n    }\n\n    // Ìè¥Î∞±: ISO ÌòïÏãùÏù¥ ÏïÑÎãå Í≤ΩÏö∞\n    return isoString;\n  } catch (error) {\n    return isoString;\n  }\n}\n\n// ÏµúÏã† Ìè¨Ïä§ÌåÖ ÏãúÌä∏ÏóêÏÑú Ìè¨Ïä§Ìä∏ Îç∞Ïù¥ÌÑ∞ ÏùΩÍ∏∞ (ÌôàÌéòÏù¥ÏßÄ ÌëúÏãúÏö©)\nasync function getPostsFromArchive(subdomain, env) {\n  try {\n    // Step 1: ÌÜ†ÌÅ∞ Î∞úÍ∏â\n    let accessToken;\n    try {\n      accessToken = await getGoogleAccessTokenForPosting(env);\n    } catch (tokenError) {\n      return { posts: [], error: `Token error: ${tokenError.message}` };\n    }\n\n    const latestSheetName = env.LATEST_POSTING_SHEET_NAME || 'ÏµúÏã† Ìè¨Ïä§ÌåÖ';\n\n    // Step 2: ÏãúÌä∏ ÏùΩÍ∏∞\n    const response = await fetch(\n      `https://sheets.googleapis.com/v4/spreadsheets/${env.SHEETS_ID}/values/${encodeURIComponent(latestSheetName)}!A:Z`,\n      { headers: { Authorization: `Bearer ${accessToken}` } }\n    );\n\n    if (!response.ok) {\n      return { posts: [], error: `Sheets API error: ${response.status}` };\n    }\n\n    const data = await response.json();\n    const rows = data.values || [];\n\n    if (rows.length < 2) {\n      return { posts: [], error: 'No data rows in sheet' };\n    }\n\n    const headers = rows[0];\n    const domainIndex = headers.indexOf('ÎèÑÎ©îÏù∏');\n    const businessNameIndex = headers.indexOf('ÏÉÅÌò∏Î™Ö');\n    const titleIndex = headers.indexOf('Ï†úÎ™©');\n    const createdAtIndex = headers.indexOf('ÏÉùÏÑ±ÏùºÏãú');\n    const languageIndex = headers.indexOf('Ïñ∏Ïñ¥');\n    const industryIndex = headers.indexOf('ÏóÖÏ¢Ö');\n    const bodyIndex = headers.indexOf('Î≥∏Î¨∏');\n    const imagesIndex = headers.indexOf('Ïù¥ÎØ∏ÏßÄ');\n\n    if (domainIndex === -1) {\n      console.error('ÏµúÏã† Ìè¨Ïä§ÌåÖ ÏãúÌä∏Ïóê \"ÎèÑÎ©îÏù∏\" Ïª¨ÎüºÏù¥ ÏóÜÏäµÎãàÎã§');\n      return { posts: [], error: 'No domain column' };\n    }\n\n    const posts = [];\n\n    // Ï≤´ Î≤àÏß∏ ÌñâÏùÄ Ìó§ÎçîÏù¥ÎØÄÎ°ú 1Î∂ÄÌÑ∞ ÏãúÏûë\n    for (let i = 1; i < rows.length; i++) {\n      const row = rows[i];\n      const domain = row[domainIndex] || '';\n\n      // ÎèÑÎ©îÏù∏ Îß§Ïπ≠ (00001.make-page.com ÎòêÎäî 00001)\n      const normalizedDomain = domain.replace('.make-page.com', '').replace('/', '');\n      const normalizedSubdomain = subdomain.replace('.make-page.com', '').replace('/', '');\n\n      if (normalizedDomain === normalizedSubdomain) {\n        posts.push({\n          subdomain: domain,\n          business_name: businessNameIndex !== -1 ? (row[businessNameIndex] || '') : '',\n          title: titleIndex !== -1 ? (row[titleIndex] || '') : '',\n          created_at: createdAtIndex !== -1 ? (row[createdAtIndex] || '') : '',\n          language: languageIndex !== -1 ? (row[languageIndex] || '') : '',\n          industry: industryIndex !== -1 ? (row[industryIndex] || '') : '',\n          body: bodyIndex !== -1 ? (row[bodyIndex] || '') : '',\n          images: imagesIndex !== -1 ? (row[imagesIndex] || '') : ''\n        });\n      }\n    }\n\n    // created_at Í∏∞Ï§Ä ÎÇ¥Î¶ºÏ∞®Ïàú Ï†ïÎ†¨ (ÏµúÏã†Ïàú)\n    posts.sort((a, b) => {\n      const dateA = new Date(a.created_at);\n      const dateB = new Date(b.created_at);\n      return dateB - dateA;\n    });\n\n    return { posts, error: null };\n  } catch (error) {\n    console.error('Error fetching posts from latest sheet:', error);\n    return { posts: [], error: `${error.message} (${error.stack?.substring(0, 100) || 'no stack'})` };\n  }\n}\n\nfunction pemToArrayBuffer(pem) {\n  const b64 = pem\n    .replace(/-----BEGIN PRIVATE KEY-----/, '')\n    .replace(/-----END PRIVATE KEY-----/, '')\n    .replace(/\\s/g, '');\n\n  const binaryString = atob(b64);\n  const bytes = new Uint8Array(binaryString.length);\n  for (let i = 0; i < binaryString.length; i++) {\n    bytes[i] = binaryString.charCodeAt(i);\n  }\n  return bytes.buffer;\n}\n\n// ÎßÅÌÅ¨ ÌÉÄÏûÖ ÏûêÎèô Í∞êÏßÄ (Ïñ∏Ïñ¥Î≥Ñ ÌÖçÏä§Ìä∏)\nfunction getLinkInfo(url, texts) {\n  if (!url) return null;\n\n  url = url.trim();\n  \n  // Ïú†Ìö®Ìïú URLÏù∏ÏßÄ ÌôïÏù∏ (http/https/tel:Î°ú ÏãúÏûëÌïòÎäî Í≤ÉÎßå Ï≤òÎ¶¨)\n  if (!url.startsWith('http') && !url.startsWith('tel:')) {\n    return null;\n  }\n\n  if (url.startsWith('tel:')) {\n    return { icon: 'üìû', text: texts.phone, url };\n  }\n\n  if (url.includes('instagram.com')) {\n    return { icon: 'üì∑', text: texts.instagram, url };\n  }\n\n  if (url.includes('youtube.com') || url.includes('youtu.be')) {\n    return { icon: '‚ñ∂Ô∏è', text: texts.youtube, url };\n  }\n\n  if (url.includes('facebook.com')) {\n    return { icon: 'üë•', text: texts.facebook, url };\n  }\n\n  if (url.includes('pf.kakao.com') || url.includes('talk.kakao')) {\n    return { icon: 'üí¨', text: texts.kakao, url };\n  }\n\n  if (url.includes('map.naver.com') || url.includes('naver.me')) {\n    return { icon: 'üìç', text: texts.location, url };\n  }\n\n  if (url.includes('maps.google.com') || url.includes('goo.gl/maps')) {\n    return { icon: 'üìç', text: texts.location, url };\n  }\n\n  if (url.includes('map.kakao.com')) {\n    return { icon: 'üìç', text: texts.location, url };\n  }\n\n  if (url.includes('smartstore.naver.com') || url.includes('brand.naver.com')) {\n    return { icon: 'üõí', text: texts.store, url };\n  }\n\n  if (url.includes('blog.naver.com')) {\n    return { icon: 'üìù', text: texts.blog, url };\n  }\n\n  if (url.includes('tistory.com')) {\n    return { icon: 'üìù', text: texts.blog, url };\n  }\n\n  if (url.includes('booking') || url.includes('reserve')) {\n    return { icon: 'üìÖ', text: texts.booking, url };\n  }\n\n  if (url === '/stats' || url.includes('umami')) {\n    return { icon: 'üìä', text: texts.stats || 'ÌÜµÍ≥Ñ', url };\n  }\n\n  return { icon: 'üîó', text: texts.link, url };\n}\n\n// ÏòÅÏÉÅ URLÏùÑ ÏûÑÎ≤†Îìú ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò\nfunction convertToEmbedUrl(url) {\n  if (!url) return null;\n\n  url = url.trim();\n\n  // YouTube\n  if (url.includes('youtube.com/watch?v=')) {\n    const videoId = url.split('v=')[1].split('&')[0];\n    return `https://www.youtube.com/embed/${videoId}`;\n  }\n  if (url.includes('youtu.be/')) {\n    const videoId = url.split('youtu.be/')[1].split('?')[0];\n    return `https://www.youtube.com/embed/${videoId}`;\n  }\n\n  // Google Drive\n  if (url.includes('drive.google.com/file/d/')) {\n    const fileId = url.split('/d/')[1].split('/')[0];\n    return `https://drive.google.com/file/d/${fileId}/preview`;\n  }\n\n  // TikTok\n  if (url.includes('tiktok.com')) {\n    // TikTok embed format varies, try to extract video ID\n    const match = url.match(/video\\/(\\d+)/);\n    if (match) {\n      return `https://www.tiktok.com/embed/v2/${match[1]}`;\n    }\n  }\n\n  // Instagram\n  if (url.includes('instagram.com')) {\n    // Instagram embed: /p/ or /reel/\n    if (url.includes('/p/') || url.includes('/reel/')) {\n      const cleanUrl = url.split('?')[0];\n      return `${cleanUrl}embed/`;\n    }\n  }\n\n  // Already embed format or unknown\n  return url;\n}\n\n// ==================== ÌéòÏù¥ÏßÄ ÏÉùÏÑ± ====================\n\n// Ìè¨Ïä§Ìä∏ ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄ ÏÉùÏÑ±\nasync function generatePostPage(client, post, env) {\n  const langCode = normalizeLanguage(client.language);\n  const texts = await getLanguageTexts(langCode, env);\n\n  // Ïù¥ÎØ∏ÏßÄ URL ÌååÏã±\n  const imageUrls = (post.images || '').split(',').map(url => url.trim()).filter(url => url);\n\n  // Î≥∏Î¨∏ÏùÑ Î¨∏Îã®ÏúºÎ°ú Î∂ÑÎ¶¨\n  const paragraphs = (post.body || '').split('\\n\\n').filter(p => p.trim());\n\n  // Ïù¥ÎØ∏ÏßÄÏôÄ Î¨∏Îã®ÏùÑ Ïù∏ÌÑ∞Î¶¨Î∏å\n  let contentHtml = '';\n  const maxLength = Math.max(imageUrls.length, paragraphs.length);\n\n  for (let i = 0; i < maxLength; i++) {\n    // Ïù¥ÎØ∏ÏßÄ Ï∂îÍ∞Ä\n    if (i < imageUrls.length) {\n      contentHtml += `<img src=\"${escapeHtml(imageUrls[i])}\" alt=\"Post Image\" class=\"post-image\">`;\n    }\n    // Î¨∏Îã® Ï∂îÍ∞Ä\n    if (i < paragraphs.length) {\n      contentHtml += `<p class=\"post-paragraph\">${escapeHtml(paragraphs[i])}</p>`;\n    }\n  }\n\n  return `<!DOCTYPE html>\n<html lang=\"${langCode}\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no\">\n    <title>${escapeHtml(post.title)} - ${escapeHtml(client.business_name)}</title>\n    <meta name=\"description\" content=\"${escapeHtml((post.body || '').substring(0, 160))}\">\n    <!-- Umami Cloud Analytics -->\n    <script defer src=\"https://cloud.umami.is/script.js\" data-website-id=\"${UMAMI_WEBSITE_ID}\"></script>\n    <style>\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            font-family: -apple-system, BlinkMacSystemFont, \"Malgun Gothic\", \"ÎßëÏùÄ Í≥†Îîï\", \"Segoe UI\", Roboto, sans-serif;\n            line-height: 1.8;\n            color: #333;\n            background: #f9fafb;\n        }\n\n        .container {\n            max-width: 800px;\n            margin: 0 auto;\n            padding: 20px;\n        }\n\n        .back-button {\n            display: inline-block;\n            margin-bottom: 24px;\n            color: #667eea;\n            text-decoration: none;\n            font-size: 14px;\n            font-weight: 500;\n        }\n\n        .back-button:hover {\n            text-decoration: underline;\n        }\n\n        .post-header {\n            background: #fff;\n            padding: 40px;\n            border-radius: 12px;\n            margin-bottom: 24px;\n            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n        }\n\n        .post-title {\n            font-size: 32px;\n            font-weight: 700;\n            color: #1a1a1a;\n            margin-bottom: 16px;\n            line-height: 1.4;\n        }\n\n        .post-meta {\n            display: flex;\n            gap: 16px;\n            font-size: 14px;\n            color: #a0aec0;\n        }\n\n        .post-content {\n            background: #fff;\n            padding: 40px;\n            border-radius: 12px;\n            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n        }\n\n        .post-image {\n            width: 100%;\n            max-width: 800px;\n            height: auto;\n            border-radius: 8px;\n            margin: 32px 0;\n            display: block;\n        }\n\n        .post-paragraph {\n            font-size: 17px;\n            color: #333;\n            line-height: 1.8;\n            margin-bottom: 24px;\n        }\n\n        @media (max-width: 768px) {\n            .container {\n                padding: 16px;\n            }\n\n            .post-header, .post-content {\n                padding: 24px;\n            }\n\n            .post-title {\n                font-size: 24px;\n            }\n\n            .post-body {\n                font-size: 16px;\n            }\n        }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <a href=\"/\" class=\"back-button\">‚Üê ${escapeHtml(client.business_name)} ${texts.backToHome}</a>\n\n        <div class=\"post-header\">\n            <h1 class=\"post-title\">${escapeHtml(post.title)}</h1>\n            <div class=\"post-meta\">\n                <span>${escapeHtml(client.business_name)}</span>\n                <span>‚Ä¢</span>\n                <time>${escapeHtml(formatKoreanTime(post.created_at))}</time>\n            </div>\n        </div>\n\n        <div class=\"post-content\">\n            ${contentHtml}\n        </div>\n    </div>\n</body>\n</html>`;\n}\n\n// Í±∞ÎûòÏ≤ò ÌéòÏù¥ÏßÄ ÏÉùÏÑ±\n// ÎßàÌÅ¨Îã§Ïö¥ ÎßÅÌÅ¨ÏóêÏÑú URL Ï∂îÏ∂ú [ÌÖçÏä§Ìä∏](URL) -> URL\nfunction extractUrlFromMarkdown(text) {\n  if (!text) return text;\n  const match = text.match(/\\[.*?\\]\\((https?:\\/\\/[^\\)]+)\\)/);\n  return match ? match[1] : text;\n}\n\nasync function generateClientPage(client, debugInfo, env) {\n  const langCode = normalizeLanguage(client.language);\n  const texts = await getLanguageTexts(langCode, env);\n\n  // Links ÌååÏã± (ÏâºÌëú Íµ¨Î∂Ñ) - ÎßàÌÅ¨Îã§Ïö¥ ÌòïÏãù Ï≤òÎ¶¨ ÌõÑ Ïñ∏Ïñ¥ ÌÖçÏä§Ìä∏ Ï†ÑÎã¨\n  const links = (client.links || '').split(',').map(l => extractUrlFromMarkdown(l.trim())).filter(l => l).map(url => getLinkInfo(url, texts)).filter(l => l);\n\n  // Info Ïù¥ÎØ∏ÏßÄ ÌååÏã± (ÏâºÌëú Íµ¨Î∂Ñ) + Google Drive URL Î≥ÄÌôò\n  let infoImages = (client.info || '').split(',')\n    .map(i => i.trim())\n    .filter(i => i)\n    .map(url => {\n      // Google Drive /view URLÏùÑ /thumbnailÎ°ú Î≥ÄÌôò\n      if (url.includes('drive.google.com/file/d/')) {\n        const fileId = url.split('/d/')[1].split('/')[0];\n        return `https://drive.google.com/thumbnail?id=${fileId}&sz=w400`;\n      }\n      return url;\n    });\n\n  // ÎûúÎç§ÏúºÎ°ú ÏÑûÍ≥† ÏµúÎåÄ 6Í∞úÎßå ÏÑ†ÌÉù\n  if (infoImages.length > 6) {\n    infoImages = infoImages.sort(() => Math.random() - 0.5).slice(0, 6);\n  }\n\n  // Video ÌååÏã± (ÏâºÌëú Íµ¨Î∂Ñ)\n  const videoUrls = (client.video || '').split(',').map(v => v.trim()).filter(v => v).map(convertToEmbedUrl).filter(v => v);\n\n  // Posts ÌååÏã± (ÏµúÍ∑º 1Í∞ú)\n  const posts = (client.posts || []).slice(0, 1);\n\n  // Ï†ÑÌôîÎ≤àÌò∏ ÎßÅÌÅ¨ Ï∂îÍ∞Ä\n  if (client.phone && !links.some(l => l.url.includes(client.phone))) {\n    links.unshift({ icon: 'üìû', text: texts.phone, url: `tel:${client.phone}` });\n  }\n\n  return `<!DOCTYPE html>\n<html lang=\"${langCode}\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no\">\n    <title>${escapeHtml(client.business_name)}</title>\n    <!-- Umami Cloud Analytics -->\n    <script defer src=\"https://cloud.umami.is/script.js\" data-website-id=\"${UMAMI_WEBSITE_ID}\"></script>\n    <style>\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            font-family: -apple-system, BlinkMacSystemFont, \"Malgun Gothic\", \"ÎßëÏùÄ Í≥†Îîï\", \"Segoe UI\", Roboto, sans-serif;\n            line-height: 1.6;\n            color: #333;\n            background: #fff;\n        }\n\n        /* Header */\n        header {\n            background: #fff;\n            border-bottom: 1px solid #e9ecef;\n            padding: 20px 16px;\n            position: sticky;\n            top: 0;\n            z-index: 100;\n            box-shadow: 0 1px 3px rgba(0,0,0,0.05);\n        }\n\n        .header-content {\n            max-width: 1200px;\n            margin: 0 auto;\n        }\n\n        .business-name {\n            font-size: 24px;\n            font-weight: 700;\n            color: #1a1a1a;\n            margin-bottom: 4px;\n        }\n\n        /* Section */\n        section {\n            max-width: 1200px;\n            margin: 0 auto;\n            padding: 60px 16px;\n        }\n\n        .section-title {\n            font-size: 28px;\n            font-weight: 700;\n            color: #1a1a1a;\n            margin-bottom: 12px;\n            text-align: center;\n        }\n\n        /* Profile Section */\n        .profile-section {\n            background: linear-gradient(to bottom, #f5f3ff 0%, #faf9ff 100%);\n            padding: 80px 16px;\n            text-align: center;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            min-height: 500px;\n        }\n\n        .profile-content {\n            max-width: 800px;\n            margin: 0 auto;\n            width: 100%;\n        }\n\n        .profile-title {\n            font-size: 48px;\n            font-weight: 800;\n            color: #1a1a1a;\n            margin-bottom: 36px;\n            letter-spacing: -0.5px;\n            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);\n        }\n\n        .contact-info {\n            display: flex;\n            flex-direction: column;\n            gap: 10px;\n            max-width: 500px;\n            margin: 0 auto 40px;\n            background: #fff;\n            padding: 20px;\n            border-radius: 8px;\n            box-shadow: 0 2px 8px rgba(0,0,0,0.06);\n        }\n\n        .contact-item {\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            gap: 10px;\n            font-size: 14px;\n            color: #4a5568;\n        }\n\n        .contact-icon {\n            font-size: 18px;\n        }\n\n        /* Quick Links */\n        .quick-links {\n            display: grid;\n            grid-template-columns: repeat(3, 1fr);\n            gap: 12px;\n            max-width: 700px;\n            margin: 0 auto;\n        }\n\n        .quick-link-item {\n            background: #fff;\n            border: 1px solid #e2e8f0;\n            border-radius: 8px;\n            padding: 20px 16px;\n            text-align: center;\n            cursor: pointer;\n            transition: all 0.3s;\n            text-decoration: none;\n            color: inherit;\n        }\n\n        .quick-link-item:hover {\n            border-color: #6366f1;\n            transform: translateY(-2px);\n            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);\n        }\n\n        .quick-link-icon {\n            font-size: 32px;\n            margin-bottom: 8px;\n        }\n\n        .quick-link-text {\n            font-size: 13px;\n            font-weight: 600;\n            color: #1a1a1a;\n        }\n\n        /* Gallery Section */\n        .gallery-grid {\n            display: grid;\n            grid-template-columns: repeat(3, 1fr);\n            gap: 16px;\n        }\n\n        .gallery-item {\n            position: relative;\n            overflow: hidden;\n            border-radius: 8px;\n            cursor: pointer;\n            transition: transform 0.3s;\n            aspect-ratio: 1;\n        }\n\n        .gallery-item:hover {\n            transform: translateY(-4px);\n        }\n\n        .gallery-image {\n            width: 100%;\n            height: 100%;\n            object-fit: cover;\n            display: block;\n        }\n\n        /* Video Section */\n        .video-grid {\n            display: grid;\n            grid-template-columns: repeat(1, 1fr);\n            gap: 24px;\n        }\n\n        @media (min-width: 768px) {\n            .video-grid {\n                grid-template-columns: repeat(2, 1fr);\n            }\n        }\n\n        .video-item {\n            position: relative;\n            width: 100%;\n            padding-top: 56.25%; /* 16:9 ÎπÑÏú® (Î™®Î∞îÏùº ÏµúÏ†ÅÌôî) */\n            border-radius: 8px;\n            overflow: hidden;\n            background: #000;\n        }\n\n        .video-item iframe {\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            border: 0;\n        }\n\n        /* Posts Section */\n        .posts-grid {\n            display: grid;\n            grid-template-columns: repeat(1, 1fr);\n            gap: 24px;\n        }\n\n        .post-card {\n            background: #fff;\n            border: 1px solid #e2e8f0;\n            border-radius: 8px;\n            padding: 24px;\n            transition: transform 0.3s, box-shadow 0.3s;\n            position: relative;\n        }\n\n        .post-card:hover {\n            transform: translateY(-4px);\n            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);\n        }\n\n        .post-delete-btn {\n            position: absolute;\n            top: 12px;\n            right: 12px;\n            width: 32px;\n            height: 32px;\n            background: #ef4444;\n            color: #fff;\n            border: none;\n            border-radius: 50%;\n            font-size: 18px;\n            font-weight: 700;\n            cursor: pointer;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            transition: all 0.3s;\n            opacity: 0.8;\n        }\n\n        .post-delete-btn:hover {\n            opacity: 1;\n            transform: scale(1.1);\n        }\n\n        .post-title {\n            font-size: 20px;\n            font-weight: 700;\n            color: #1a1a1a;\n            margin-bottom: 12px;\n            line-height: 1.4;\n            padding-right: 40px;\n        }\n\n        .post-body {\n            font-size: 15px;\n            color: #4a5568;\n            line-height: 1.6;\n            margin-bottom: 16px;\n        }\n\n        .post-date {\n            font-size: 13px;\n            color: #a0aec0;\n        }\n\n        @media (min-width: 768px) {\n            .contact-info {\n                flex-direction: row;\n            }\n        }\n\n        /* Lightbox */\n        .lightbox {\n            display: none;\n            position: fixed;\n            z-index: 9999;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%\n;\n            background: rgba(0, 0, 0, 0.9);\n            align-items: center;\n            justify-content: center;\n        }\n\n        .lightbox.active {\n            display: flex;\n        }\n\n        .lightbox-content {\n            position: relative;\n            max-width: 90%;\n            max-height: 90%;\n        }\n\n        .lightbox-image {\n            width: 100%;\n            height: 100%;\n            object-fit: contain;\n            max-height: 90vh;\n        }\n\n        .lightbox-close {\n            position: absolute;\n            top: 20px;\n            right: 20px;\n            color: #fff;\n            font-size: 40px;\n            font-weight: 300;\n            cursor: pointer;\n            z-index: 10000;\n            width: 50px;\n            height: 50px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            background: rgba(0, 0, 0, 0.5);\n            border-radius: 50%;\n            transition: background 0.3s;\n        }\n\n        .lightbox-close:hover {\n            background: rgba(0, 0, 0, 0.8);\n        }\n\n        .lightbox-nav {\n            position: absolute;\n            top: 50%;\n            transform: translateY(-50%);\n            color: #fff;\n            font-size: 60px;\n            font-weight: 300;\n            cursor: pointer;\n            padding: 20px;\n            background: rgba(0, 0, 0, 0.5);\n            border-radius: 4px;\n            user-select: none;\n            transition: background 0.3s;\n        }\n\n        .lightbox-nav:hover {\n            background: rgba(0, 0, 0, 0.8);\n        }\n\n        .lightbox-prev {\n            left: 20px;\n        }\n\n        .lightbox-next {\n            right: 20px;\n        }\n\n        /* Password Modal */\n        .password-modal {\n            display: none;\n            position: fixed;\n            z-index: 10000;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.5);\n            align-items: center;\n            justify-content: center;\n        }\n\n        .password-modal.active {\n            display: flex;\n        }\n\n        .password-modal-content {\n            background: #fff;\n            padding: 32px;\n            border-radius: 12px;\n            max-width: 400px;\n            width: 90%;\n            text-align: center;\n        }\n\n        .password-modal-title {\n            font-size: 20px;\n            font-weight: 700;\n            margin-bottom: 16px;\n        }\n\n        .password-input {\n            width: 100%;\n            padding: 12px;\n            border: 1px solid #e2e8f0;\n            border-radius: 8px;\n            font-size: 16px;\n            margin-bottom: 16px;\n        }\n\n        .password-buttons {\n            display: flex;\n            gap: 12px;\n        }\n\n        .password-btn {\n            flex: 1;\n            padding: 12px;\n            border: none;\n            border-radius: 8px;\n            font-size: 16px;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.3s;\n        }\n\n        .password-btn-confirm {\n            background: #ef4444;\n            color: #fff;\n        }\n\n        .password-btn-confirm:hover {\n            background: #dc2626;\n        }\n\n        .password-btn-cancel {\n            background: #e2e8f0;\n            color: #333;\n        }\n\n        .password-btn-cancel:hover {\n            background: #cbd5e1;\n        }\n    </style>\n</head>\n<body>\n    <!-- Header -->\n    <header>\n        <div class=\"header-content\">\n            <h1 class=\"business-name\">${escapeHtml(client.business_name)}</h1>\n        </div>\n    </header>\n\n    <!-- Profile Section -->\n    <section class=\"profile-section\">\n        <div class=\"profile-content\">\n            <h2 class=\"profile-title\">${escapeHtml(client.business_name)}</h2>\n            <div class=\"contact-info\">\n                ${client.address ? '<div class=\"contact-item\"><span class=\"contact-icon\">üìç</span><span>' + escapeHtml(client.address) + '</span></div>' : ''}\n                ${client.phone ? '<div class=\"contact-item\"><span class=\"contact-icon\">üìû</span><span>' + escapeHtml(client.phone) + '</span></div>' : ''}\n                ${client.business_hours ? '<div class=\"contact-item\"><span class=\"contact-icon\">üïê</span><span>' + escapeHtml(client.business_hours) + '</span></div>' : ''}\n            </div>\n\n            <!-- Quick Links -->\n            ${links.length > 0 ? '<div class=\"quick-links\">' + links.map(link => '<a href=\"' + escapeHtml(link.url) + '\" class=\"quick-link-item\"' + (link.url.startsWith('http') ? ' target=\"_blank\"' : '') + '><div class=\"quick-link-icon\">' + link.icon + '</div><div class=\"quick-link-text\">' + escapeHtml(link.text) + '</div></a>').join('') + '</div>' : ''}\n        </div>\n    </section>\n\n    <!-- Info Section -->\n    ${infoImages.length > 0 ? '<section><h2 class=\"section-title\">' + texts.info + '</h2><div class=\"gallery-grid\">' + infoImages.map((img, index) => '<div class=\"gallery-item\" onclick=\"openLightbox(' + index + ')\"><img src=\"' + escapeHtml(img) + '\" alt=\"Info\" class=\"gallery-image\"></div>').join('') + '</div></section>' : ''}\n\n    <!-- Video Section -->\n    ${videoUrls.length > 0 ? '<section><h2 class=\"section-title\">' + texts.video + '</h2><div class=\"video-grid\">' + videoUrls.map(url => '<div class=\"video-item\"><iframe src=\"' + escapeHtml(url) + '\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe></div>').join('') + '</div></section>' : ''}\n\n    <!-- Posts Section -->\n    ${posts.length > 0 ? '<section><h2 class=\"section-title\">' + texts.posts + '</h2><div class=\"posts-grid\">' + posts.map(post => '<article class=\"post-card\"><a href=\"/post?id=' + encodeURIComponent(post.created_at) + '\" style=\"text-decoration: none; color: inherit;\"><h3 class=\"post-title\">' + escapeHtml(post.title) + '</h3><p class=\"post-body\">' + escapeHtml((post.body || '').substring(0, 200)) + '...</p><time class=\"post-date\">' + escapeHtml(formatKoreanTime(post.created_at)) + '</time></a></article>').join('') + '</div></section>' : ''}\n\n    <!-- Lightbox -->\n    <div id=\"lightbox\" class=\"lightbox\" onclick=\"closeLightbox()\">\n        <span class=\"lightbox-close\" onclick=\"closeLightbox()\">√ó</span>\n        <span class=\"lightbox-nav lightbox-prev\" onclick=\"event.stopPropagation(); prevImage()\">&#10094;</span>\n        <div class=\"lightbox-content\" onclick=\"event.stopPropagation()\">\n            <img id=\"lightbox-image\" class=\"lightbox-image\" src=\"\" alt=\"Info\">\n        </div>\n        <span class=\"lightbox-nav lightbox-next\" onclick=\"event.stopPropagation(); nextImage()\">&#10095;</span>\n    </div>\n\n    <script>\n        const infoImages = ${JSON.stringify(infoImages)};\n        let currentImageIndex = 0;\n\n        function openLightbox(index) {\n            currentImageIndex = index;\n            document.getElementById('lightbox-image').src = infoImages[index];\n            document.getElementById('lightbox').classList.add('active');\n            document.body.style.overflow = 'hidden';\n        }\n\n        function closeLightbox() {\n            document.getElementById('lightbox').classList.remove('active');\n            document.body.style.overflow = 'auto';\n        }\n\n        function nextImage() {\n            currentImageIndex = (currentImageIndex + 1) % infoImages.length;\n            document.getElementById('lightbox-image').src = infoImages[currentImageIndex];\n        }\n\n        function prevImage() {\n            currentImageIndex = (currentImageIndex - 1 + infoImages.length) % infoImages.length;\n            document.getElementById('lightbox-image').src = infoImages[currentImageIndex];\n        }\n\n        // ESC ÌÇ§Î°ú Îã´Í∏∞\n        document.addEventListener('keydown', function(e) {\n            if (e.key === 'Escape') {\n                closeLightbox();\n            }\n            if (e.key === 'ArrowRight') nextImage();\n            if (e.key === 'ArrowLeft') prevImage();\n        });\n    </script>\n    <!-- DEBUG CLIENT: ${JSON.stringify(client)} -->\n    <!-- DEBUG HEADERS: ${JSON.stringify(debugInfo)} -->\n</body>\n</html>`;\n}\n\n// robots.txt ÏÉùÏÑ±\nfunction generateRobotsTxt() {\n  return `User-agent: *\nAllow: /\n\nSitemap: https://make-page.com/sitemap.xml`;\n}\n\n// ==================== Sitemap ====================\n\nasync function handleSitemap(env) {\n  try {\n    // Google SheetsÏóêÏÑú ÌôúÏÑ± Í±∞ÎûòÏ≤ò Ï°∞Ìöå\n    const SHEET_URL = env.GOOGLE_SHEETS_CSV_URL || 'https://docs.google.com/spreadsheets/d/1KrzLFi8Wt9GTGT97gcMoXnbZ3OJ04NsP4lncJyIdyhU/export?format=csv&gid=0';\n    const response = await fetchWithTimeout(SHEET_URL, {}, 10000);\n    const csvText = await response.text();\n    const clients = parseCSV(csvText).map(normalizeClient);\n\n    const activeClients = clients.filter(client => client.subscription === 'ÌôúÏÑ±');\n\n    let urls = [];\n\n    // KST ÎÇ†Ïßú Í≥ÑÏÇ∞\n    const getKstDate = () => {\n      const utcDate = new Date();\n      const kstDate = new Date(utcDate.getTime() + (9 * 60 * 60 * 1000));\n      return kstDate.toISOString().split('T')[0];\n    };\n\n    // Í±∞ÎûòÏ≤ò Î©îÏù∏ ÌéòÏù¥ÏßÄÎßå Ìè¨Ìï®\n    activeClients.forEach(client => {\n      urls.push({\n        loc: `https://${client.subdomain}.make-page.com/`,\n        lastmod: getKstDate(),\n        changefreq: 'daily',\n        priority: '0.9'\n      });\n    });\n\n    // XML ÏÉùÏÑ±\n    const xml = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n${urls.map(url => `  <url>\n    <loc>${url.loc}</loc>\n    <lastmod>${url.lastmod}</lastmod>\n    <changefreq>${url.changefreq}</changefreq>\n    <priority>${url.priority}</priority>\n  </url>`).join('\\n')}\n</urlset>`;\n\n    return new Response(xml, {\n      headers: {\n        'Content-Type': 'application/xml; charset=utf-8',\n        'Cache-Control': 'public, max-age=3600'\n      }\n    });\n\n  } catch (error) {\n    console.error('Sitemap generation error:', error);\n    return new Response('Error generating sitemap', { status: 500 });\n  }\n}\n\n// ==================== Ìè¨Ïä§Ìä∏ ÏÇ≠Ï†ú ====================\n\nasync function deletePost(subdomain, createdAt, password, env) {\n  // ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏\n  if (password !== env.DELETE_PASSWORD) {\n    return { success: false, error: 'ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§' };\n  }\n\n  try {\n    const accessToken = await getGoogleAccessTokenForPosting(env);\n    const archiveSheetName = env.ARCHIVE_SHEET_NAME || 'Ï†ÄÏû•ÏÜå';\n    const latestSheetName = env.LATEST_POSTING_SHEET_NAME || 'ÏµúÏã† Ìè¨Ïä§ÌåÖ';\n\n    // ÎèÑÎ©îÏù∏ Ï†ïÍ∑úÌôî\n    const normalizedSubdomain = subdomain.replace('.make-page.com', '').replace('/', '');\n    const domain = `${normalizedSubdomain}.make-page.com`;\n\n    // 1. Ï†ÄÏû•ÏÜå ÌÉ≠ÏóêÏÑú ÏÇ≠Ï†ú\n    const archiveResponse = await fetch(\n      `https://sheets.googleapis.com/v4/spreadsheets/${env.SHEETS_ID}/values/'${archiveSheetName}'!A:Z`,\n      { headers: { Authorization: `Bearer ${accessToken}` } }\n    );\n    const archiveData = await archiveResponse.json();\n    const archiveRows = archiveData.values || [];\n\n    if (archiveRows.length < 2) {\n      return { success: false, error: 'ÏÇ≠Ï†úÌï† Ìè¨Ïä§Ìä∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§' };\n    }\n\n    const archiveHeaders = archiveRows[0];\n    const archiveDomainIndex = archiveHeaders.indexOf('ÎèÑÎ©îÏù∏');\n    const archiveCreatedAtIndex = archiveHeaders.indexOf('ÏÉùÏÑ±ÏùºÏãú');\n\n    if (archiveDomainIndex === -1 || archiveCreatedAtIndex === -1) {\n      return { success: false, error: 'Ï†ÄÏû•ÏÜå ÏãúÌä∏ Íµ¨Ï°∞ Ïò§Î•ò' };\n    }\n\n    let foundInArchive = false;\n    for (let i = 1; i < archiveRows.length; i++) {\n      const row = archiveRows[i];\n      if (row[archiveDomainIndex] === domain && row[archiveCreatedAtIndex] === createdAt) {\n        // Ìñâ ÏÇ≠Ï†ú\n        const archiveSheetId = await getSheetId(env.SHEETS_ID, archiveSheetName, accessToken);\n        await fetch(\n          `https://sheets.googleapis.com/v4/spreadsheets/${env.SHEETS_ID}:batchUpdate`,\n          {\n            method: 'POST',\n            headers: {\n              'Authorization': `Bearer ${accessToken}`,\n              'Content-Type': 'application/json'\n            },\n            body: JSON.stringify({\n              requests: [{\n                deleteDimension: {\n                  range: {\n                    sheetId: archiveSheetId,\n                    dimension: 'ROWS',\n                    startIndex: i,\n                    endIndex: i + 1\n                  }\n                }\n              }]\n            })\n          }\n        );\n        foundInArchive = true;\n        break;\n      }\n    }\n\n    // 2. ÏµúÏã† Ìè¨Ïä§ÌåÖ ÌÉ≠ÏóêÏÑúÎèÑ ÏÇ≠Ï†ú\n    const latestResponse = await fetch(\n      `https://sheets.googleapis.com/v4/spreadsheets/${env.SHEETS_ID}/values/'${latestSheetName}'!A:Z`,\n      { headers: { Authorization: `Bearer ${accessToken}` } }\n    );\n    const latestData = await latestResponse.json();\n    const latestRows = latestData.values || [];\n\n    if (latestRows.length >= 2) {\n      const latestHeaders = latestRows[0];\n      const latestDomainIndex = latestHeaders.indexOf('ÎèÑÎ©îÏù∏');\n      const latestCreatedAtIndex = latestHeaders.indexOf('ÏÉùÏÑ±ÏùºÏãú');\n\n      if (latestDomainIndex !== -1 && latestCreatedAtIndex !== -1) {\n        for (let i = 1; i < latestRows.length; i++) {\n          const row = latestRows[i];\n          if (row[latestDomainIndex] === domain && row[latestCreatedAtIndex] === createdAt) {\n            const latestSheetId = await getSheetId(env.SHEETS_ID, latestSheetName, accessToken);\n        await fetch(\n          `https://sheets.googleapis.com/v4/spreadsheets/${env.SHEETS_ID}:batchUpdate`,\n          {\n            method: 'POST',\n            headers: {\n              'Authorization': `Bearer ${accessToken}`,\n              'Content-Type': 'application/json'\n            },\n            body: JSON.stringify({\n              requests: [{\n                deleteDimension: {\n                  range: {\n                    sheetId: latestSheetId,\n                    dimension: 'ROWS',\n                    startIndex: i,\n                    endIndex: i + 1\n                  }\n                }\n              }]\n            })\n          }\n        );\n        break;\n      }\n    }\n      }\n    }\n\n    if (!foundInArchive) {\n      return { success: false, error: 'ÏÇ≠Ï†úÌï† Ìè¨Ïä§Ìä∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§' };\n    }\n\n    return { success: true };\n\n  } catch (error) {\n    console.error('Delete post error:', error);\n    return { success: false, error: error.message };\n  }\n}\n\n// ==================== ÎùºÏö∞ÌåÖ ====================\n\nexport default {\n  async scheduled(event, env, ctx) {\n    const nowUtc = new Date();\n    const nowKst = new Date(nowUtc.getTime() + (9 * 60 * 60 * 1000));\n    const timestamp = nowKst.toISOString().replace('T', ' ').substring(0, 19);\n    console.log('Scheduled trigger started at (KST)', timestamp);\n\n    // ÎèôÏãú Ïã§Ìñâ Î∞©ÏßÄ (ÎÇ†ÏßúÎ≥Ñ KV ÎùΩ)\n    // KST ÎÇ†Ïßú Í≥ÑÏÇ∞\n    const kstDate = nowKst.toISOString().split('T')[0]; // YYYY-MM-DD\n    const lockKey = `cron_posting_lock_${kstDate}`;\n    const lockValue = await env.POSTING_KV.get(lockKey);\n\n    if (lockValue) {\n      console.log(`Cron already executed for ${kstDate}, skipping...`);\n      return;\n    }\n\n    try {\n      // ÎùΩ ÏÑ§Ï†ï (48ÏãúÍ∞Ñ TTL - Îã§Ïùå ÎÇ† Ïã§Ìñâ Î≥¥Ïû•)\n      await env.POSTING_KV.put(lockKey, timestamp, { expirationTtl: 172800 });\n\n      // 1. Î™®Îì† Íµ¨ÎèÖ Í±∞ÎûòÏ≤ò Ï°∞Ìöå\n      const SHEET_URL = env.GOOGLE_SHEETS_CSV_URL || 'https://docs.google.com/spreadsheets/d/1KrzLFi8Wt9GTGT97gcMoXnbZ3OJ04NsP4lncJyIdyhU/export?format=csv&gid=0';\n      const response = await fetchWithTimeout(SHEET_URL, {}, 10000);\n\n      if (!response.ok) {\n        throw new Error(`Sheets fetch failed: ${response.status}`);\n      }\n\n      const csvText = await response.text();\n      const clients = parseCSV(csvText).map(normalizeClient).filter(c => c.subscription === 'ÌôúÏÑ±');\n\n      console.log(`Found ${clients.length} active clients`);\n\n      // 2. Î∞∞Ïπò Ï≤òÎ¶¨ (10Í∞úÏî© Queue Ï†ÑÏÜ°)\n      const batchSize = 10;\n      let successCount = 0;\n      let failCount = 0;\n\n      for (let i = 0; i < clients.length; i += batchSize) {\n        const batch = clients.slice(i, i + batchSize);\n\n        for (const client of batch) {\n          try {\n            const normalizedSubdomain = client.subdomain.replace('.make-page.com', '').replace('/', '');\n            await env.POSTING_QUEUE.send({ subdomain: normalizedSubdomain });\n            successCount++;\n            console.log(`Queue sent: ${normalizedSubdomain}`);\n          } catch (err) {\n            failCount++;\n            console.error(`Queue send failed for ${client.subdomain}:`, err);\n          }\n        }\n\n        // Î∞∞Ïπò Í∞Ñ 1Ï¥à ÎåÄÍ∏∞\n        if (i + batchSize < clients.length) {\n          await new Promise(resolve => setTimeout(resolve, 1000));\n        }\n      }\n\n      console.log(`Cron completed: ${successCount} queued, ${failCount} failed`);\n\n    } catch (error) {\n      console.error('Scheduled handler error:', error);\n    } finally {\n      // ÎùΩ Ìï¥Ï†ú\n      await env.POSTING_KV.delete(lockKey);\n    }\n  },\n\n  async queue(batch, env) {\n    await Promise.all(\n      batch.messages.map(async (message) => {\n        try {\n          const result = await generatePostingForClient(message.body.subdomain, env);\n          if (result.success) {\n            console.log(`‚úÖ ${message.body.subdomain} Ìè¨Ïä§ÌåÖ ÏÑ±Í≥µ`);\n            message.ack();\n          } else {\n            console.error(`‚ùå ${message.body.subdomain} Ïã§Ìå®: ${result.error}`);\n            message.ack();\n          }\n        } catch (error) {\n          console.error(`‚ùå ${message.body.subdomain} ÏóêÎü¨: ${error.message}`);\n          message.ack();\n        }\n      })\n    );\n  },\n\n  async fetch(request, env, ctx) {\n    const url = new URL(request.url);\n    const hostname = url.hostname;\n    const pathname = url.pathname;\n\n    // www Î¶¨Îã§Ïù¥Î†âÌä∏\n    if (hostname === 'www.make-page.com') {\n      const redirectUrl = `https://make-page.com${pathname}${url.search}`;\n      return Response.redirect(redirectUrl, 301);\n    }\n\n    // ÏÑúÎ∏åÎèÑÎ©îÏù∏ Ï∂îÏ∂ú\n    const subdomain = hostname.split('.')[0];\n\n    // make-page.com (Î©îÏù∏ ÎèÑÎ©îÏù∏) Ï≤òÎ¶¨\n    if (hostname === 'make-page.com' || hostname === 'staging.make-page.com') {\n      if (pathname === '/sitemap.xml') {\n        return handleSitemap(env);\n      }\n      if (pathname === '/robots.txt') {\n        return new Response(generateRobotsTxt(), {\n          headers: { 'Content-Type': 'text/plain; charset=utf-8' }\n        });\n      }\n      // IndexNow API ÌÇ§ ÌååÏùº\n      if (pathname === '/kmlsc7f9b1pm7n7x7gq1zdihmzxtkqzr.txt') {\n        return new Response('kmlsc7f9b1pm7n7x7gq1zdihmzxtkqzr', {\n          headers: { 'Content-Type': 'text/plain; charset=utf-8' }\n        });\n      }\n      // Test posting generation (ÏßÅÏ†ë Ïã§Ìñâ, Queue Ïö∞Ìöå)\n      if (pathname === '/test-posting' && request.method === 'POST') {\n        try {\n          const { subdomain } = await request.json();\n          const result = await generatePostingForClient(subdomain, env);\n\n          return new Response(JSON.stringify(result, null, 2), {\n            headers: { 'Content-Type': 'application/json' }\n          });\n        } catch (error) {\n          return new Response(JSON.stringify({\n            error: error.message,\n            stack: error.stack\n          }), {\n            status: 500,\n            headers: { 'Content-Type': 'application/json' }\n          });\n        }\n      }\n\n      // Test cron trigger (Cron ÏàòÎèô Ïã§Ìñâ ÌÖåÏä§Ìä∏)\n      if (pathname === '/test-cron' && request.method === 'POST') {\n        try {\n          const nowUtc = new Date();\n          const nowKst = new Date(nowUtc.getTime() + (9 * 60 * 60 * 1000));\n          const timestamp = nowKst.toISOString().replace('T', ' ').substring(0, 19);\n          const logs = [`Manual cron test started at (KST) ${timestamp}`];\n\n          // 1. Î™®Îì† Íµ¨ÎèÖ Í±∞ÎûòÏ≤ò Ï°∞Ìöå\n          const SHEET_URL = env.GOOGLE_SHEETS_CSV_URL || 'https://docs.google.com/spreadsheets/d/1KrzLFi8Wt9GTGT97gcMoXnbZ3OJ04NsP4lncJyIdyhU/export?format=csv&gid=0';\n          const response = await fetchWithTimeout(SHEET_URL, {}, 10000);\n\n          if (!response.ok) {\n            throw new Error(`Sheets fetch failed: ${response.status}`);\n          }\n\n          const csvText = await response.text();\n          const clients = parseCSV(csvText).map(normalizeClient).filter(c => c.subscription === 'ÌôúÏÑ±');\n          logs.push(`Found ${clients.length} active clients`);\n\n          // 2. Î∞∞Ïπò Ï≤òÎ¶¨ (10Í∞úÏî© Queue Ï†ÑÏÜ°)\n          const batchSize = 10;\n          let successCount = 0;\n          let failCount = 0;\n\n          for (let i = 0; i < clients.length; i += batchSize) {\n            const batch = clients.slice(i, i + batchSize);\n\n            for (const client of batch) {\n              try {\n                const normalizedSubdomain = client.subdomain.replace('.make-page.com', '').replace('/', '');\n                await env.POSTING_QUEUE.send({ subdomain: normalizedSubdomain });\n                successCount++;\n                logs.push(`Queue sent: ${normalizedSubdomain}`);\n              } catch (err) {\n                failCount++;\n                logs.push(`Queue send failed for ${client.subdomain}: ${err.message}`);\n              }\n            }\n\n            // Î∞∞Ïπò Í∞Ñ 1Ï¥à ÎåÄÍ∏∞\n            if (i + batchSize < clients.length) {\n              await new Promise(resolve => setTimeout(resolve, 1000));\n            }\n          }\n\n          logs.push(`Test cron completed: ${successCount} queued, ${failCount} failed`);\n\n          return new Response(JSON.stringify({\n            success: true,\n            totalClients: clients.length,\n            successCount,\n            failCount,\n            logs\n          }, null, 2), {\n            headers: { 'Content-Type': 'application/json' }\n          });\n        } catch (error) {\n          return new Response(JSON.stringify({\n            error: error.message,\n            stack: error.stack\n          }), {\n            status: 500,\n            headers: { 'Content-Type': 'application/json' }\n          });\n        }\n      }\n\n      // Test sheet reading (ÏãúÌä∏ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏)\n      if (pathname === '/test-sheet' && request.method === 'GET') {\n        try {\n          const accessToken = await getGoogleAccessTokenForPosting(env);\n          const archiveSheetName = env.ARCHIVE_SHEET_NAME || 'Ï†ÄÏû•ÏÜå';\n          const latestSheetName = env.LATEST_POSTING_SHEET_NAME || 'ÏµúÏã† Ìè¨Ïä§ÌåÖ';\n\n          const latestResponse = await fetch(\n            `https://sheets.googleapis.com/v4/spreadsheets/${env.SHEETS_ID}/values/${encodeURIComponent(latestSheetName)}!A:Z`,\n            { headers: { Authorization: `Bearer ${accessToken}` } }\n          );\n          const latestData = await latestResponse.json();\n\n          const archiveResponse = await fetch(\n            `https://sheets.googleapis.com/v4/spreadsheets/${env.SHEETS_ID}/values/${encodeURIComponent(archiveSheetName)}!A:Z`,\n            { headers: { Authorization: `Bearer ${accessToken}` } }\n          );\n          const archiveData = await archiveResponse.json();\n\n          // Ïó¥ ÎÑàÎπÑ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞\n          const spreadsheetResponse = await fetch(\n            `https://sheets.googleapis.com/v4/spreadsheets/${env.SHEETS_ID}?fields=sheets(properties(title,sheetId),data.columnMetadata.pixelSize)`,\n            { headers: { Authorization: `Bearer ${accessToken}` } }\n          );\n          const spreadsheetData = await spreadsheetResponse.json();\n\n          // Í∞Å ÏãúÌä∏Ïùò Ïó¥ ÎÑàÎπÑ Ï∞æÍ∏∞\n          const latestSheet = spreadsheetData.sheets.find(s => s.properties.title === latestSheetName);\n          const archiveSheet = spreadsheetData.sheets.find(s => s.properties.title === archiveSheetName);\n          const mainSheet = spreadsheetData.sheets[0]; // Í¥ÄÎ¶¨Ïûê ÏãúÌä∏\n\n          const getColumnWidths = (sheet) => {\n            if (!sheet || !sheet.data || !sheet.data[0] || !sheet.data[0].columnMetadata) {\n              return [];\n            }\n            return sheet.data[0].columnMetadata.slice(0, 9).map(col => col.pixelSize || 100);\n          };\n\n          return new Response(JSON.stringify({\n            latest: {\n              sheetName: latestSheetName,\n              rowCount: (latestData.values || []).length,\n              headers: (latestData.values || [])[0] || [],\n              firstDataRow: (latestData.values || [])[1] || [],\n              allRows: latestData.values || [],\n              columnWidths: getColumnWidths(latestSheet)\n            },\n            archive: {\n              sheetName: archiveSheetName,\n              rowCount: (archiveData.values || []).length,\n              headers: (archiveData.values || [])[0] || [],\n              firstDataRow: (archiveData.values || [])[1] || [],\n              allRows: archiveData.values || [],\n              columnWidths: getColumnWidths(archiveSheet)\n            },\n            main: {\n              sheetName: mainSheet?.properties?.title || 'Í¥ÄÎ¶¨Ïûê',\n              columnWidths: getColumnWidths(mainSheet)\n            }\n          }, null, 2), {\n            headers: { 'Content-Type': 'application/json' }\n          });\n        } catch (error) {\n          return new Response(JSON.stringify({\n            error: error.message,\n            stack: error.stack\n          }), {\n            status: 500,\n            headers: { 'Content-Type': 'application/json' }\n          });\n        }\n      }\n\n      // Generate posting (Queue Ï†ÑÏÜ°)\n      if (pathname === '/generate-posting' && request.method === 'POST') {\n        try {\n          const { subdomain } = await request.json();\n\n          // QueueÏóê Î©îÏãúÏßÄ Ï†ÑÏÜ°\n          await env.POSTING_QUEUE.send({ subdomain });\n\n          // Ï¶âÏãú 202 ÏùëÎãµ\n          return new Response(JSON.stringify({\n            success: true,\n            message: \"Ìè¨Ïä§ÌåÖ ÏÉùÏÑ±Ïù¥ QueueÏóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§. ÏôÑÎ£åÍπåÏßÄ 2-3Î∂Ñ ÏÜåÏöîÎê©ÎãàÎã§.\",\n            subdomain: subdomain\n          }), {\n            status: 202,\n            headers: { 'Content-Type': 'application/json' }\n          });\n        } catch (error) {\n          return new Response(JSON.stringify({\n            error: error.message,\n            stack: error.stack\n          }), {\n            status: 500,\n            headers: { 'Content-Type': 'application/json' }\n          });\n        }\n      }\n      // Î©îÏù∏ ÎèÑÎ©îÏù∏ÏùÄ 404 (ÎûúÎî©ÌéòÏù¥ÏßÄ ÏóÜÏùå)\n      return new Response('Not Found', { status: 404 });\n    }\n\n    // ÏÑúÎ∏åÎèÑÎ©îÏù∏Ïù¥ 5ÏûêÎ¶¨ Ïà´ÏûêÍ∞Ä ÏïÑÎãàÎ©¥ 404\n    if (!/^\\d{5}$/.test(subdomain)) {\n      return new Response('Not Found', { status: 404 });\n    }\n\n    try {\n      // Delete post ÏóîÎìúÌè¨Ïù∏Ìä∏\n      if (pathname === '/delete-post' && request.method === 'POST') {\n        const { subdomain: reqSubdomain, created_at, password } = await request.json();\n        const result = await deletePost(reqSubdomain, created_at, password, env);\n        return new Response(JSON.stringify(result), {\n          status: result.success ? 200 : 400,\n          headers: { 'Content-Type': 'application/json' }\n        });\n      }\n\n      // Google SheetsÏóêÏÑú Í±∞ÎûòÏ≤ò Ï†ïÎ≥¥ Ï°∞Ìöå\n      const { client, debugInfo } = await getClientFromSheets(subdomain, env);\n\n      if (!client) {\n        return new Response('Not Found', { status: 404 });\n      }\n\n      // ÎπÑÌôúÏÑ± Í±∞ÎûòÏ≤òÎäî ÌëúÏãú ÏïàÌï® (ÏùºÏãúÏ†ÅÏúºÎ°ú Ìï¥Ï†ú)\n      /*\n      if (client.status !== 'Íµ¨ÎèÖ') {\n        return new Response('This page is inactive', { status: 403 });\n      }\n      */\n\n      // Ìè¨Ïä§Ìä∏ ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄ\n      if (pathname === '/post' && client.posts && client.posts.length > 0) {\n        // Query parameterÏóêÏÑú post ID Ï∂îÏ∂ú\n        const postId = url.searchParams.get('id');\n\n        // created_atÏúºÎ°ú Ìè¨Ïä§Ìä∏ Ï∞æÍ∏∞\n        const post = postId\n          ? client.posts.find(p => p.created_at === postId)\n          : client.posts[0];\n\n        if (!post) {\n          return new Response('Post not found', { status: 404 });\n        }\n\n        return new Response(await generatePostPage(client, post, env), {\n          headers: {\n            'Content-Type': 'text/html; charset=utf-8',\n            'Cache-Control': 'public, max-age=300'\n          }\n        });\n      }\n\n      // Umami CloudÍ∞Ä ÏûêÎèôÏúºÎ°ú Ï∂îÏ†Å\n      // Í±∞ÎûòÏ≤ò ÌéòÏù¥ÏßÄ ÏÉùÏÑ±\n      return new Response(await generateClientPage(client, debugInfo, env), {\n        headers: {\n          'Content-Type': 'text/html; charset=utf-8',\n          'Cache-Control': 'public, max-age=300'\n        }\n      });\n\n    } catch (error) {\n      console.error('Error:', error);\n      return new Response('Internal Server Error', { status: 500 });\n    }\n  }\n};\n\n// ==================== Ìè¨Ïä§ÌåÖ ÏÉùÏÑ± Ìï®ÏàòÎì§ (posting-generator.js ÌÜµÌï©) ====================\n\nasync function generatePostingForClient(subdomain, env) {\n  const logs = [];\n\n  try {\n    // Step 1: Í±∞ÎûòÏ≤ò Ï†ïÎ≥¥ Ï°∞Ìöå\n    logs.push('Í±∞ÎûòÏ≤ò Ï†ïÎ≥¥ Ï°∞Ìöå Ï§ë...');\n    const client = await getClientFromSheetsForPosting(subdomain, env);\n    if (!client) {\n      return { success: false, error: 'Client not found', logs };\n    }\n    logs.push(`Í±∞ÎûòÏ≤ò: ${client.business_name}`);\n\n    // Step 1.5: Google Drive Ìè¥Îçî ÏàúÌôò ÏÑ†ÌÉù\n    logs.push('Google Drive Ìè¥Îçî Ï°∞Ìöå Ï§ë...');\n    const accessToken = await getGoogleAccessTokenForPosting(env);\n    const normalizedSubdomain = client.subdomain.replace('.make-page.com', '').replace('/', '');\n\n    // Ìè¥ÎçîÎ™Ö Ïª¨Îüº ÏÇ¨Ïö© (ÏóÜÏúºÎ©¥ subdomain Í∏∞Î∞ò Í≤ÄÏÉâÏúºÎ°ú Ìè¥Î∞±)\n    const folderName = client.folder_name || null;\n    if (folderName) {\n      logs.push(`Drive Ìè¥Îçî Í≤ÄÏÉâ: Ìè¥ÎçîÎ™Ö=\"${folderName}\"`);\n    } else {\n      logs.push(`Drive Ìè¥Îçî Í≤ÄÏÉâ: subdomain=${normalizedSubdomain} (Ìè¥ÎçîÎ™Ö Ïª¨Îüº ÏóÜÏùå)`);\n    }\n\n    const folders = await getClientFoldersForPosting(folderName, normalizedSubdomain, accessToken, env, logs);\n\n    if (folders.length === 0) {\n      return { success: false, error: 'No folders found (Info/Video excluded)', logs };\n    }\n\n    logs.push(`Ìè¥Îçî ${folders.length}Í∞ú Î∞úÍ≤¨`);\n\n    const folderData = await getLastUsedFolderForPosting(subdomain, accessToken, env);\n    const lastFolder = folderData?.lastFolder || null;\n    const archiveHeaders = folderData?.archiveHeaders || [];\n    const nextFolder = getNextFolderForPosting(folders, lastFolder);\n    logs.push(`ÏÑ†ÌÉùÎêú Ìè¥Îçî: ${nextFolder}`);\n\n    // Step 1.7: ÏÑ†ÌÉùÎêú Ìè¥ÎçîÏóêÏÑú Î™®Îì† Ïù¥ÎØ∏ÏßÄ Í∞ÄÏ†∏Ïò§Í∏∞\n    logs.push('Ìè¥Îçî ÎÇ¥ Ïù¥ÎØ∏ÏßÄ Ï°∞Ìöå Ï§ë...');\n    const images = await getFolderImagesForPosting(normalizedSubdomain, nextFolder, accessToken, env, logs);\n    logs.push(`Ïù¥ÎØ∏ÏßÄ ${images.length}Í∞ú Î∞úÍ≤¨`);\n\n    // Ïù¥ÎØ∏ÏßÄ ÏóÜÏñ¥ÎèÑ ÌÖçÏä§Ìä∏ Ìè¨Ïä§ÌåÖ ÏÉùÏÑ± ÏßÑÌñâ\n\n    // Step 2: Ïõπ Í≤ÄÏÉâ (Gemini 2.5 Flash)\n    logs.push('Ïõπ Í≤ÄÏÉâ ÏãúÏûë...');\n    const trendsData = await searchWithGeminiForPosting(client, env);\n    logs.push(`Ïõπ Í≤ÄÏÉâ ÏôÑÎ£å: ${trendsData.substring(0, 100)}...`);\n\n    // Step 3: Ìè¨Ïä§ÌåÖ ÏÉùÏÑ± (Gemini 3.0 Pro)\n    logs.push('Ìè¨Ïä§ÌåÖ ÏÉùÏÑ± ÏãúÏûë...');\n    const postData = await generatePostWithGeminiForPosting(client, trendsData, images, env);\n    logs.push(`Ìè¨Ïä§ÌåÖ ÏÉùÏÑ± ÏôÑÎ£å: ${postData.title}`);\n\n    // Step 3.5: Ïù¥ÎØ∏ÏßÄ URL Ï∂îÍ∞Ä\n    const imageUrls = images.map(img => `https://drive.google.com/thumbnail?id=${img.id}&sz=w800`).join(',');\n    postData.images = imageUrls;\n\n    // Step 4: Ï†ÄÏû•ÏÜå + ÏµúÏã† Ìè¨Ïä§ÌåÖ ÏãúÌä∏ Ï†ÄÏû•\n    logs.push('Ï†ÄÏû•ÏÜå/ÏµúÏã†Ìè¨Ïä§ÌåÖ ÏãúÌä∏ Ï†ÄÏû• ÏãúÏûë...');\n    await saveToLatestPostingSheet(client, postData, normalizedSubdomain, nextFolder, accessToken, env, archiveHeaders);\n    logs.push('Ï†ÄÏû•ÏÜå/ÏµúÏã†Ìè¨Ïä§ÌåÖ ÏãúÌä∏ Ï†ÄÏû• ÏôÑÎ£å');\n\n    return {\n      success: true,\n      post: postData,\n      logs\n    };\n\n  } catch (error) {\n    logs.push(`ÏóêÎü¨: ${error.message}`);\n    return {\n      success: false,\n      error: error.message,\n      logs\n    };\n  }\n}\n\nasync function getClientFromSheetsForPosting(subdomain, env) {\n  const SHEET_URL = env.GOOGLE_SHEETS_CSV_URL || 'https://docs.google.com/spreadsheets/d/1KrzLFi8Wt9GTGT97gcMoXnbZ3OJ04NsP4lncJyIdyhU/export?format=csv&gid=0';\n\n  try {\n    const response = await fetchWithTimeout(SHEET_URL, {}, 10000);\n\n    if (!response.ok) {\n      throw new Error(`Sheets CSV fetch failed: ${response.status}`);\n    }\n\n    const csvText = await response.text();\n    const clients = parseCSV(csvText).map(normalizeClient);\n\n    return clients.find(c => {\n      let normalized = (c.subdomain || '').replace('.make-page.com', '').replace('/', '');\n      return normalized === subdomain && c.subscription === 'ÌôúÏÑ±';\n    }) || null;\n  } catch (error) {\n    console.error(`getClientFromSheetsForPosting ÏóêÎü¨: ${error.message}`);\n    throw error;\n  }\n}\n\nasync function searchWithGeminiForPosting(client, env) {\n  const prompt = `\n[ÏóÖÏ¢Ö] ${client.industry || client.business_name}\n[Ïñ∏Ïñ¥] ${client.language}\n\nÎã§Ïùå Ï†ïÎ≥¥Î•º 500Ïûê Ïù¥ÎÇ¥Î°ú ÏûëÏÑ±:\n1. ${client.language} ÏãúÏû•Ïùò ÏµúÏã† Ìä∏Î†åÎìú\n2. Í≤ÄÏÉâ ÌÇ§ÏõåÎìú ÏÉÅÏúÑ 5Í∞ú\n3. ÏÜåÎπÑÏûê Í¥ÄÏã¨ÏÇ¨\n\nÏ∂úÎ†• ÌòïÏãù: ÌÖçÏä§Ìä∏Îßå (JSON Î∂àÌïÑÏöî)\n`;\n\n  try {\n    const response = await fetchWithTimeout(\n      `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${env.GEMINI_API_KEY}`,\n      {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          contents: [{\"parts\": [{\"text\": prompt}]}],\n          generationConfig: {\n            temperature: 0.7,\n            maxOutputTokens: 600\n          }\n        })\n      },\n      120000\n    );\n\n    if (!response.ok) {\n      throw new Error(`Gemini API HTTP error: ${response.status}`);\n    }\n\n    const data = await response.json();\n\n    // ÏóêÎü¨ Ï≤òÎ¶¨\n    if (data.error) {\n      throw new Error(`Gemini API error: ${data.error.message}`);\n    }\n\n    if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {\n      throw new Error(`Unexpected Gemini API response structure: ${JSON.stringify(data)}`);\n    }\n\n    return data.candidates[0].content.parts[0].text;\n  } catch (error) {\n    console.error(`searchWithGeminiForPosting ÏóêÎü¨: ${error.message}`);\n    throw error;\n  }\n}\n\nasync function generatePostWithGeminiForPosting(client, trendsData, images, env) {\n  const hasImages = images.length > 0;\n  const imageCount = images.length;\n\n  const prompt = hasImages ? `\n[Í±∞ÎûòÏ≤ò Ï†ïÎ≥¥]\n- ÏóÖÏ≤¥Î™Ö: ${client.business_name}\n- Ïñ∏Ïñ¥: ${client.language}\n- **ÌïµÏã¨ Ï£ºÏ†ú Î∞è ÏÜåÍ∞ú (ÌïÑÏàò Î∞òÏòÅ): ${client.description}**\n\n[Ìä∏Î†åÎìú Ï†ïÎ≥¥]\n${trendsData}\n\n[Ï†úÍ≥µÎêú Ïù¥ÎØ∏ÏßÄ]\nÏ¥ù ${imageCount}Ïû•Ïùò Ïù¥ÎØ∏ÏßÄÍ∞Ä Ï†úÍ≥µÎê©ÎãàÎã§.\n\n[ÏûëÏÑ± Í∑úÏπô]\n0. **Ìè¨Ïä§ÌåÖ Ï†ÑÏ≤¥(Ï†úÎ™©Í≥º Î≥∏Î¨∏)Î•º Î∞òÎìúÏãú ${client.language}Î°ú ÏûëÏÑ±** (ÏµúÏö∞ÏÑ† ÌïÑÏàò)\n1. Ï†úÎ™©: **'${client.description}'Ïùò ÌïµÏã¨ ÎÇ¥Ïö©ÏùÑ Î∞òÏòÅ**ÌïòÏó¨ Îß§Î†•Ï†ÅÏúºÎ°ú ÏûëÏÑ± (ÏôÑÏ†Ñ ÏûêÏú† Ï∞ΩÏûë)\n2. Î≥∏Î¨∏ Ï†ÑÏ≤¥ Í∏ÄÏûêÏàò: **Í≥µÎ∞± Ìè¨Ìï® 2800~3200Ïûê** (ÌïÑÏàò)\n3. Î≥∏Î¨∏ Íµ¨Ï°∞: **Î∞òÎìúÏãú ${imageCount}Í∞úÏùò Î¨∏Îã®ÏúºÎ°ú ÏûëÏÑ±**\n   - 1Î≤àÏß∏ Ïù¥ÎØ∏ÏßÄ ‚Üí 1Î≤àÏß∏ Î¨∏Îã®\n   - 2Î≤àÏß∏ Ïù¥ÎØ∏ÏßÄ ‚Üí 2Î≤àÏß∏ Î¨∏Îã®\n   - ...\n   - ${imageCount}Î≤àÏß∏ Ïù¥ÎØ∏ÏßÄ ‚Üí ${imageCount}Î≤àÏß∏ Î¨∏Îã®\n4. Í∞Å Î¨∏Îã®: Ìï¥Îãπ ÏàúÏÑúÏùò Ïù¥ÎØ∏ÏßÄÏóêÏÑú Î≥¥Ïù¥Îäî ÎÇ¥Ïö©ÏùÑ Í∞ÑÍ≤∞ÌïòÍ≤å ÏÑ§Î™Ö\n   - Ïù¥ÎØ∏ÏßÄ ÏÜç ÏÉâÏÉÅ, Î∂ÑÏúÑÍ∏∞, ÏÇ¨Î¨º, ÏÇ¨Îûå, Ïï°ÏÖò Îì±ÏùÑ Î¨òÏÇ¨\n   - **Í∞Å Î¨∏Îã®ÏùÄ Í≥µÎ∞± Ìè¨Ìï® ÏïΩ 280~320Ïûê ÎÇ¥Ïô∏Î°ú ÏûëÏÑ±**\n   - **[Ìä∏Î†åÎìú Ï†ïÎ≥¥]Îäî Î¨∏Îã®Îãπ 1~2Î¨∏Ïû• Ï†ïÎèÑÎßå Í∞ÑÍ≤∞ÌïòÍ≤å Î∞∞Í≤Ω ÏÑ§Î™ÖÏúºÎ°ú ÌôúÏö©**\n5. Î¨∏Îã® Íµ¨Î∂Ñ: Î¨∏Îã® ÏÇ¨Ïù¥Ïóê Îπà Ï§Ñ 2Í∞ú (\\\\n\\\\n)Î°ú Î™ÖÌôïÌûà Íµ¨Î∂Ñ\n6. Í∏àÏßÄÏñ¥: ÏµúÍ≥†, 1Îì±, Ïú†Ïùº, Í≤ÄÏ¶ùÎêú\n7. Í∏àÏßÄ Ï∞ΩÏûë: Í≤ΩÎ†•, ÌïôÎ†•, ÏûêÍ≤©Ï¶ù, ÏàòÏÉÅ\n8. **Î≥∏Î¨∏Ïùò Î™®Îì† ÎÇ¥Ïö©ÏùÄ '${client.description}'Ïùò Ï£ºÏ†úÏôÄ ÏûêÏó∞Ïä§ÎüΩÍ≤å Ïó∞Í≤∞ÎêòÏñ¥Ïïº Ìï® (ÏµúÏö∞ÏÑ† ÏàúÏúÑ)**\n9. **Í∞ÑÍ≤∞ÌïòÍ≥† ÌïµÏã¨Ï†ÅÏù∏ ÌëúÌòÑ ÏÇ¨Ïö© - Ïû•Ìô©Ìïú ÏÑ§Î™Ö Í∏àÏßÄ**\n\nÏ∂úÎ†• ÌòïÏãù (JSON):\n{\n  \"title\": \"Ï†úÎ™©\",\n  \"body\": \"Î¨∏Îã®1\\\\n\\\\nÎ¨∏Îã®2\\\\n\\\\nÎ¨∏Îã®3\\\\n\\\\n...\"\n}\n\nÏ§ëÏöî: bodyÎäî Ï†ïÌôïÌûà ${imageCount}Í∞úÏùò Î¨∏Îã®ÏúºÎ°ú Íµ¨ÏÑ±ÎêòÏñ¥Ïïº ÌïòÎ©∞, '${client.description}'Ïùò ÎÇ¥Ïö©Ïù¥ Ìè¨Ïä§ÌåÖÏùò Ï§ëÏã¨Ïù¥ ÎêòÏñ¥Ïïº Ìï©ÎãàÎã§.\n` : `\n[Í±∞ÎûòÏ≤ò Ï†ïÎ≥¥]\n- ÏóÖÏ≤¥Î™Ö: ${client.business_name}\n- Ïñ∏Ïñ¥: ${client.language}\n- **ÌïµÏã¨ Ï£ºÏ†ú Î∞è ÏÜåÍ∞ú (ÌïÑÏàò Î∞òÏòÅ): ${client.description}**\n\n[Ìä∏Î†åÎìú Ï†ïÎ≥¥]\n${trendsData}\n\n[Ï†úÍ≥µÎêú Ïù¥ÎØ∏ÏßÄ]\nÏù¥ÎØ∏ÏßÄÍ∞Ä Ï†úÍ≥µÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. ÌÖçÏä§Ìä∏ÎßåÏúºÎ°ú ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.\n\n[ÏûëÏÑ± Í∑úÏπô]\n0. **Ìè¨Ïä§ÌåÖ Ï†ÑÏ≤¥(Ï†úÎ™©Í≥º Î≥∏Î¨∏)Î•º Î∞òÎìúÏãú ${client.language}Î°ú ÏûëÏÑ±** (ÏµúÏö∞ÏÑ† ÌïÑÏàò)\n1. Ï†úÎ™©: **'${client.description}'Ïùò ÌïµÏã¨ ÎÇ¥Ïö©ÏùÑ Î∞òÏòÅ**ÌïòÏó¨ Îß§Î†•Ï†ÅÏúºÎ°ú ÏûëÏÑ± (ÏôÑÏ†Ñ ÏûêÏú† Ï∞ΩÏûë)\n2. Î≥∏Î¨∏ Ï†ÑÏ≤¥ Í∏ÄÏûêÏàò: **Í≥µÎ∞± Ìè¨Ìï® 2800~3200Ïûê** (ÌïÑÏàò)\n3. Î≥∏Î¨∏ Íµ¨Ï°∞: **8~10Í∞úÏùò Î¨∏Îã®ÏúºÎ°ú ÏûëÏÑ±** (Ïù¥ÎØ∏ÏßÄ ÏóÜÏùå)\n   - Í∞Å Î¨∏Îã®ÏùÄ '${client.description}' Ï£ºÏ†úÏùò Îã§ÏñëÌïú Ï∏°Î©¥ÏùÑ Îã§Î£∏\n   - [Ìä∏Î†åÎìú Ï†ïÎ≥¥]Î•º ÌôúÏö©ÌïòÏó¨ Ìù•ÎØ∏Î°≠Í≤å ÏûëÏÑ±\n4. Í∞Å Î¨∏Îã®:\n   - **Í∞Å Î¨∏Îã®ÏùÄ Í≥µÎ∞± Ìè¨Ìï® ÏïΩ 280~320Ïûê ÎÇ¥Ïô∏Î°ú ÏûëÏÑ±**\n   - **[Ìä∏Î†åÎìú Ï†ïÎ≥¥]Î•º Ï†ÅÍ∑π ÌôúÏö©ÌïòÏó¨ ÌíçÎ∂ÄÌïú ÎÇ¥Ïö© Íµ¨ÏÑ±**\n5. Î¨∏Îã® Íµ¨Î∂Ñ: Î¨∏Îã® ÏÇ¨Ïù¥Ïóê Îπà Ï§Ñ 2Í∞ú (\\\\n\\\\n)Î°ú Î™ÖÌôïÌûà Íµ¨Î∂Ñ\n6. Í∏àÏßÄÏñ¥: ÏµúÍ≥†, 1Îì±, Ïú†Ïùº, Í≤ÄÏ¶ùÎêú\n7. Í∏àÏßÄ Ï∞ΩÏûë: Í≤ΩÎ†•, ÌïôÎ†•, ÏûêÍ≤©Ï¶ù, ÏàòÏÉÅ\n8. **Î≥∏Î¨∏Ïùò Î™®Îì† ÎÇ¥Ïö©ÏùÄ '${client.description}'Ïùò Ï£ºÏ†úÏôÄ ÏûêÏó∞Ïä§ÎüΩÍ≤å Ïó∞Í≤∞ÎêòÏñ¥Ïïº Ìï® (ÏµúÏö∞ÏÑ† ÏàúÏúÑ)**\n9. **Í∞ÑÍ≤∞ÌïòÍ≥† ÌïµÏã¨Ï†ÅÏù∏ ÌëúÌòÑ ÏÇ¨Ïö© - Ïû•Ìô©Ìïú ÏÑ§Î™Ö Í∏àÏßÄ**\n\nÏ∂úÎ†• ÌòïÏãù (JSON):\n{\n  \"title\": \"Ï†úÎ™©\",\n  \"body\": \"Î¨∏Îã®1\\\\n\\\\nÎ¨∏Îã®2\\\\n\\\\nÎ¨∏Îã®3\\\\n\\\\n...\"\n}\n\nÏ§ëÏöî: Ïù¥ÎØ∏ÏßÄ ÏóÜÏù¥ ÌÖçÏä§Ìä∏ÎßåÏúºÎ°ú Îß§Î†•Ï†ÅÏù∏ Ìè¨Ïä§ÌåÖÏùÑ ÏûëÏÑ±ÌïòÎ©∞, '${client.description}'Ïùò ÎÇ¥Ïö©Ïù¥ Ìè¨Ïä§ÌåÖÏùò Ï§ëÏã¨Ïù¥ ÎêòÏñ¥Ïïº Ìï©ÎãàÎã§.\n`;\n\n  const parts = [{ text: prompt }];\n\n  for (const image of images) {\n    parts.push({\n      inline_data: {\n        mime_type: image.mimeType,\n        data: image.data\n      }\n    });\n  }\n\n  try {\n    const response = await fetchWithTimeout(\n      `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent?key=${env.GEMINI_API_KEY}`,\n      {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          contents: [{\"parts\": parts}],\n          generationConfig: {\n            temperature: 0.8,\n            maxOutputTokens: 8000\n          }\n        })\n      },\n      120000\n    );\n\n    // HTTP ÏùëÎãµ ÏÉÅÌÉú ÌôïÏù∏\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(`Gemini API HTTP ${response.status}: ${errorText.substring(0, 200)}`);\n    }\n\n    const data = await response.json();\n\n    // ÏóêÎü¨ Ï≤òÎ¶¨\n    if (data.error) {\n      throw new Error(`Gemini API error: ${data.error.message}`);\n    }\n\n    if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {\n      throw new Error(`Unexpected Gemini API response structure: ${JSON.stringify(data)}`);\n    }\n\n    const text = data.candidates[0].content.parts[0].text;\n\n    const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\n    if (jsonMatch) {\n      return JSON.parse(jsonMatch[0]);\n    }\n\n    throw new Error('Failed to parse Gemini response');\n  } catch (error) {\n    console.error(`generatePostWithGeminiForPosting ÏóêÎü¨: ${error.message}`);\n    throw error;\n  }\n}\n\nasync function getGoogleAccessTokenForPosting(env) {\n  const serviceAccount = JSON.parse(env.GOOGLE_SERVICE_ACCOUNT_JSON);\n\n  // Base64URL Ïù∏ÏΩîÎî© (UTF-8 ÏïàÏ†Ñ)\n  function base64urlEncode(str) {\n    const base64 = btoa(unescape(encodeURIComponent(str)));\n    return base64.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=/g, '');\n  }\n\n  const jwtHeader = base64urlEncode(JSON.stringify({ alg: 'RS256', typ: 'JWT' }));\n  const now = Math.floor(Date.now() / 1000);\n  const jwtClaimSet = {\n    iss: serviceAccount.client_email,\n    scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly',\n    aud: 'https://oauth2.googleapis.com/token',\n    exp: now + 3600,\n    iat: now\n  };\n\n  const jwtClaimSetEncoded = base64urlEncode(JSON.stringify(jwtClaimSet));\n  const signatureInput = `${jwtHeader}.${jwtClaimSetEncoded}`;\n\n  const privateKey = await crypto.subtle.importKey(\n    'pkcs8',\n    pemToArrayBuffer(serviceAccount.private_key),\n    { name: 'RSASSA-PKCS1-v1_5', hash: 'SHA-256' },\n    false,\n    ['sign']\n  );\n\n  const signature = await crypto.subtle.sign(\n    'RSASSA-PKCS1-v1_5',\n    privateKey,\n    new TextEncoder().encode(signatureInput)\n  );\n\n  const jwtSignature = btoa(String.fromCharCode(...new Uint8Array(signature)))\n    .replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=/g, '');\n\n  const jwt = `${signatureInput}.${jwtSignature}`;\n\n  const tokenResponse = await fetch('https://oauth2.googleapis.com/token', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\n    body: `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${jwt}`\n  });\n\n  if (!tokenResponse.ok) {\n    const errorText = await tokenResponse.text();\n    throw new Error(`OAuth token error (${tokenResponse.status}): ${errorText}`);\n  }\n\n  const responseText = await tokenResponse.text();\n  if (!responseText) {\n    throw new Error('Empty OAuth token response');\n  }\n\n  const tokenData = JSON.parse(responseText);\n  return tokenData.access_token;\n}\n\nasync function getFolderImagesForPosting(subdomain, folderName, accessToken, env, logs) {\n  const DRIVE_FOLDER_ID = env.DRIVE_FOLDER_ID || '1JiVmIkliR9YrPIUPOn61G8Oh7h9HTMEt';\n\n  const businessFolderQuery = `mimeType = 'application/vnd.google-apps.folder' and name contains '${subdomain}' and '${DRIVE_FOLDER_ID}' in parents and trashed = false`;\n\n  const businessFolderResponse = await fetch(\n    `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(businessFolderQuery)}&fields=files(id,name)`,\n    { headers: { Authorization: `Bearer ${accessToken}` } }\n  );\n\n  const businessFolderData = await businessFolderResponse.json();\n  if (!businessFolderData.files || businessFolderData.files.length === 0) {\n    logs.push('Ïù¥ÎØ∏ÏßÄ Ï°∞Ìöå: Í±∞ÎûòÏ≤ò Ìè¥Îçî ÏóÜÏùå');\n    return [];\n  }\n\n  const businessFolderId = businessFolderData.files[0].id;\n  logs.push(`Ïù¥ÎØ∏ÏßÄ Ï°∞Ìöå: Í±∞ÎûòÏ≤ò Ìè¥Îçî ID ${businessFolderId}`);\n\n  const targetFolderQuery = `mimeType = 'application/vnd.google-apps.folder' and name = '${folderName}' and '${businessFolderId}' in parents and trashed = false`;\n\n  const targetFolderResponse = await fetch(\n    `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(targetFolderQuery)}&fields=files(id,name)`,\n    { headers: { Authorization: `Bearer ${accessToken}` } }\n  );\n\n  const targetFolderData = await targetFolderResponse.json();\n  logs.push(`ÌÉÄÍ≤ü Ìè¥Îçî Í≤ÄÏÉâ Í≤∞Í≥º: ${JSON.stringify(targetFolderData)}`);\n\n  if (!targetFolderData.files || targetFolderData.files.length === 0) {\n    logs.push('Ïù¥ÎØ∏ÏßÄ Ï°∞Ìöå: ÌÉÄÍ≤ü Ìè¥Îçî ÏóÜÏùå');\n    return [];\n  }\n\n  const targetFolderId = targetFolderData.files[0].id;\n  logs.push(`Ïù¥ÎØ∏ÏßÄ Ï°∞Ìöå: ÌÉÄÍ≤ü Ìè¥Îçî ID ${targetFolderId}`);\n\n  const filesQuery = `'${targetFolderId}' in parents and trashed = false`;\n\n  const filesResponse = await fetch(\n    `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(filesQuery)}&fields=files(id,name,mimeType)&pageSize=100`,\n    { headers: { Authorization: `Bearer ${accessToken}` } }\n  );\n\n  const filesData = await filesResponse.json();\n  logs.push(`ÌååÏùº Í≤ÄÏÉâ Í≤∞Í≥º: ${JSON.stringify(filesData)}`);\n\n  let imageFiles = (filesData.files || []).filter(f => f.mimeType && f.mimeType.startsWith('image/'));\n  logs.push(`Ïù¥ÎØ∏ÏßÄ ÌååÏùº ${imageFiles.length}Í∞ú ÌïÑÌÑ∞ÎßÅÎê®`);\n\n  // 10Í∞ú Ï¥àÍ≥ºÏãú ÎûúÎç§ 10Í∞ú ÏÑ†ÌÉù\n  if (imageFiles.length > 10) {\n    imageFiles = imageFiles.sort(() => Math.random() - 0.5).slice(0, 10);\n    logs.push(`10Í∞ú Ï¥àÍ≥º: ÎûúÎç§ ${imageFiles.length}Í∞ú ÏÑ†ÌÉù`);\n  }\n\n  // Î≥ëÎ†¨ Îã§Ïö¥Î°úÎìú (ÏÜçÎèÑ Ìñ•ÏÉÅ)\n  const downloadPromises = imageFiles.map(async (file) => {\n    try {\n      logs.push(`Ïç∏ÎÑ§Ïùº Îã§Ïö¥Î°úÎìú: ${file.name}`);\n\n      // Google Drive Ïç∏ÎÑ§Ïùº API ÏÇ¨Ïö© (w400 ÌÅ¨Í∏∞)\n      const thumbnailUrl = `https://lh3.googleusercontent.com/d/${file.id}=w400`;\n      const imageResponse = await fetch(thumbnailUrl);\n\n      if (!imageResponse.ok) {\n        logs.push(`Ïç∏ÎÑ§Ïùº Îã§Ïö¥Î°úÎìú Ïã§Ìå®: ${file.name} - ${imageResponse.status}`);\n        return null;\n      }\n\n      const arrayBuffer = await imageResponse.arrayBuffer();\n      const bytes = new Uint8Array(arrayBuffer);\n\n      let binary = '';\n      const chunkSize = 8192;\n      for (let i = 0; i < bytes.length; i += chunkSize) {\n        const chunk = bytes.subarray(i, Math.min(i + chunkSize, bytes.length));\n        binary += String.fromCharCode.apply(null, chunk);\n      }\n      const base64 = btoa(binary);\n\n      logs.push(`Ïç∏ÎÑ§Ïùº Îã§Ïö¥Î°úÎìú ÏôÑÎ£å: ${file.name}`);\n      return {\n        id: file.id,\n        name: file.name,\n        mimeType: file.mimeType,\n        data: base64\n      };\n    } catch (error) {\n      logs.push(`Ïç∏ÎÑ§Ïùº Îã§Ïö¥Î°úÎìú ÏóêÎü¨: ${file.name} - ${error.message}`);\n      return null;\n    }\n  });\n\n  const results = await Promise.all(downloadPromises);\n  const images = results.filter(img => img !== null);\n\n  logs.push(`Ï¥ù ${images.length}Í∞ú Ïù¥ÎØ∏ÏßÄ Îã§Ïö¥Î°úÎìú ÏôÑÎ£å`);\n  return images;\n}\n\nasync function getClientFoldersForPosting(folderName, subdomain, accessToken, env, logs) {\n  const DRIVE_FOLDER_ID = env.DRIVE_FOLDER_ID || '1JiVmIkliR9YrPIUPOn61G8Oh7h9HTMEt';\n\n  // Ìè¥ÎçîÎ™ÖÏù¥ ÏûàÏúºÎ©¥ Ï†ïÌôïÌïú Îß§Ïπ≠, ÏóÜÏúºÎ©¥ subdomain Ìè¨Ìï® Í≤ÄÏÉâ (Ìè¥Î∞±)\n  const businessFolderQuery = folderName\n    ? `mimeType = 'application/vnd.google-apps.folder' and name = '${folderName}' and '${DRIVE_FOLDER_ID}' in parents and trashed = false`\n    : `mimeType = 'application/vnd.google-apps.folder' and name contains '${subdomain}' and '${DRIVE_FOLDER_ID}' in parents and trashed = false`;\n\n  const businessFolderResponse = await fetch(\n    `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(businessFolderQuery)}&fields=files(id,name)`,\n    { headers: { Authorization: `Bearer ${accessToken}` } }\n  );\n\n  const businessFolderData = await businessFolderResponse.json();\n  logs.push(`Í±∞ÎûòÏ≤ò Ìè¥Îçî Í≤ÄÏÉâ Í≤∞Í≥º: ${JSON.stringify(businessFolderData)}`);\n\n  if (!businessFolderData.files || businessFolderData.files.length === 0) {\n    logs.push('Í±∞ÎûòÏ≤ò Ìè¥ÎçîÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');\n    return [];\n  }\n\n  const businessFolderId = businessFolderData.files[0].id;\n  logs.push(`Í±∞ÎûòÏ≤ò Ìè¥Îçî ID: ${businessFolderId}`);\n\n  const subFoldersQuery = `mimeType = 'application/vnd.google-apps.folder' and '${businessFolderId}' in parents and trashed = false`;\n\n  const subFoldersResponse = await fetch(\n    `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(subFoldersQuery)}&fields=files(id,name)&orderBy=name`,\n    { headers: { Authorization: `Bearer ${accessToken}` } }\n  );\n\n  const subFoldersData = await subFoldersResponse.json();\n  logs.push(`ÌïòÏúÑ Ìè¥Îçî Ï°∞Ìöå Í≤∞Í≥º: ${JSON.stringify(subFoldersData)}`);\n\n  const folders = (subFoldersData.files || [])\n    .map(f => f.name)\n    .filter(name => {\n      const lowerName = name.toLowerCase();\n      return lowerName !== 'info' && lowerName !== 'video';\n    })\n    .sort();\n\n  logs.push(`ÌïÑÌÑ∞ÎßÅÎêú Ìè¥Îçî: ${JSON.stringify(folders)}`);\n\n  return folders;\n}\n\nasync function getLastUsedFolderForPosting(subdomain, accessToken, env) {\n  try {\n    const archiveSheetName = env.ARCHIVE_SHEET_NAME || 'Ï†ÄÏû•ÏÜå';\n\n    const response = await fetchWithTimeout(\n      `https://sheets.googleapis.com/v4/spreadsheets/${env.SHEETS_ID}/values/${encodeURIComponent(archiveSheetName)}!A:Z`,\n      { headers: { Authorization: `Bearer ${accessToken}` } },\n      10000\n    );\n\n    if (!response.ok) {\n      return { lastFolder: null, archiveHeaders: [] };\n    }\n\n    const data = await response.json();\n    const rows = data.values || [];\n\n    if (rows.length < 1) {\n      return { lastFolder: null, archiveHeaders: [] };\n    }\n\n    const headers = rows[0];\n    const domainIndex = headers.indexOf('ÎèÑÎ©îÏù∏');\n    const folderNameIndex = headers.indexOf('Ìè¥ÎçîÎ™Ö');\n\n    if (domainIndex === -1 || folderNameIndex === -1) {\n      return { lastFolder: null, archiveHeaders: headers };\n    }\n\n    const normalizedSubdomain = subdomain.replace('.make-page.com', '').replace('/', '');\n    const domain = `${normalizedSubdomain}.make-page.com`;\n\n    // Ìï¥Îãπ ÎèÑÎ©îÏù∏Ïùò ÎßàÏßÄÎßâ ÌñâÏóêÏÑú Ìè¥ÎçîÎ™Ö Í∞ÄÏ†∏Ïò§Í∏∞\n    let lastFolder = null;\n    for (let i = rows.length - 1; i >= 1; i--) {\n      const row = rows[i];\n      const rowDomain = row[domainIndex] || '';\n      if (rowDomain === domain) {\n        lastFolder = row[folderNameIndex] || null;\n        break;\n      }\n    }\n\n    return { lastFolder, archiveHeaders: headers };\n  } catch (error) {\n    return { lastFolder: null, archiveHeaders: [] };\n  }\n}\n\nfunction getNextFolderForPosting(folders, lastFolder) {\n  if (folders.length === 0) {\n    return null;\n  }\n\n  // 1. ÎÇ†Ïßú Í∏∞Î∞ò Îß§Ïπ≠ (Ïò§Îäò ÎÇ†Ïßú YYYY-MM-DD)\n  const now = new Date();\n  const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));\n  const todayString = koreaTime.toISOString().split('T')[0];\n\n  const todayFolder = folders.find(f => f.includes(todayString));\n  if (todayFolder) {\n    return todayFolder;\n  }\n\n  // 2. ÏàúÌôò Î°úÏßÅ (Í∏∞Ï°¥ Î∞©Ïãù)\n  if (!lastFolder) {\n    return folders[0];\n  }\n\n  const currentIndex = folders.indexOf(lastFolder);\n  if (currentIndex === -1) {\n    return folders[0];\n  }\n\n  const nextIndex = (currentIndex + 1) % folders.length;\n  return folders[nextIndex];\n}\n\nasync function saveToLatestPostingSheet(client, postData, normalizedSubdomain, folderName, accessToken, env, archiveHeaders) {\n  const now = new Date();\n  const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));\n  const timestamp = koreaTime.toISOString().replace('T', ' ').substring(0, 19);\n  const domain = `${normalizedSubdomain}.make-page.com`;\n\n  const archiveSheetName = env.ARCHIVE_SHEET_NAME || 'Ï†ÄÏû•ÏÜå';\n  const latestSheetName = env.LATEST_POSTING_SHEET_NAME || 'ÏµúÏã† Ìè¨Ïä§ÌåÖ';\n\n  // Îç∞Ïù¥ÌÑ∞ Í∞ùÏ≤¥ (Ïª¨ÎüºÎ™Ö: Í∞í)\n  const postDataMap = {\n    'ÎèÑÎ©îÏù∏': domain,\n    'ÏÉÅÌò∏Î™Ö': client.business_name,\n    'Ï†úÎ™©': postData.title,\n    'URL': `${domain}/post?id=${encodeURIComponent(timestamp)}`,\n    'ÏÉùÏÑ±ÏùºÏãú': timestamp,\n    'Ïñ∏Ïñ¥': client.language || 'ko',\n    'ÏóÖÏ¢Ö': client.industry || '',\n    'Ìè¥ÎçîÎ™Ö': folderName || '',\n    'Î≥∏Î¨∏': postData.body || '',\n    'Ïù¥ÎØ∏ÏßÄ': postData.images || ''\n  };\n\n  // 1. ÏµúÏã† Ìè¨Ïä§ÌåÖ ÌÉ≠ Î®ºÏ†Ä Ï≤òÎ¶¨ (Ìä∏ÎûúÏû≠ÏÖò Î∞©Ïãù - Ïã§Ìå® Ïãú Ï†ÄÏû•ÏÜå Ï†ÄÏû• ÏïàÌï®)\n  const getResponse = await fetchWithTimeout(\n    `https://sheets.googleapis.com/v4/spreadsheets/${env.SHEETS_ID}/values/${encodeURIComponent(latestSheetName)}!A:Z`,\n    { headers: { Authorization: `Bearer ${accessToken}` } },\n    10000\n  );\n\n  if (!getResponse.ok) {\n    throw new Error(`ÏµúÏã† Ìè¨Ïä§ÌåÖ ÏãúÌä∏ ÏùΩÍ∏∞ Ïã§Ìå®: ${getResponse.status}`);\n  }\n\n  const getData = await getResponse.json();\n  const rows = getData.values || [];\n\n  if (rows.length < 1) {\n    throw new Error('ÏµúÏã† Ìè¨Ïä§ÌåÖ ÏãúÌä∏Ïóê Ìó§ÎçîÍ∞Ä ÏóÜÏäµÎãàÎã§');\n  }\n\n  const latestHeaders = rows[0];\n  const domainIndex = latestHeaders.indexOf('ÎèÑÎ©îÏù∏');\n  const createdAtIndex = latestHeaders.indexOf('ÏÉùÏÑ±ÏùºÏãú');\n\n  if (domainIndex === -1 || createdAtIndex === -1) {\n    throw new Error('ÏµúÏã† Ìè¨Ïä§ÌåÖ ÏãúÌä∏Ïóê ÌïÑÏàò Ïª¨Îüº(ÎèÑÎ©îÏù∏, ÏÉùÏÑ±ÏùºÏãú)Ïù¥ ÏóÜÏäµÎãàÎã§');\n  }\n\n  // 2. ÏãúÌä∏ Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Ìïú Î≤àÎßå Ï°∞Ìöå (API Ï§ëÎ≥µ Ìò∏Ï∂ú Î∞©ÏßÄ)\n  const spreadsheetResponse = await fetchWithTimeout(\n    `https://sheets.googleapis.com/v4/spreadsheets/${env.SHEETS_ID}?fields=sheets(properties(title,sheetId),data.columnMetadata.pixelSize)`,\n    { headers: { Authorization: `Bearer ${accessToken}` } },\n    10000\n  );\n\n  if (!spreadsheetResponse.ok) {\n    throw new Error(`ÏãúÌä∏ Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ïã§Ìå®: ${spreadsheetResponse.status}`);\n  }\n\n  const spreadsheetData = await spreadsheetResponse.json();\n  const latestSheet = spreadsheetData.sheets.find(s => s.properties.title === latestSheetName);\n  const archiveSheet = spreadsheetData.sheets.find(s => s.properties.title === archiveSheetName);\n  const adminSheet = spreadsheetData.sheets.find(s => s.properties.title === 'Í¥ÄÎ¶¨Ïûê');\n\n  const latestSheetId = latestSheet ? latestSheet.properties.sheetId : 0;\n  const archiveSheetId = archiveSheet ? archiveSheet.properties.sheetId : 0;\n\n  console.log(`SheetID - ÏµúÏã†Ìè¨Ïä§ÌåÖ: ${latestSheetId}, Ï†ÄÏû•ÏÜå: ${archiveSheetId}`);\n\n  // 3. Ìï¥Îãπ ÎèÑÎ©îÏù∏Ïùò ÌñâÎì§ Ï∞æÍ∏∞\n  const domainRows = [];\n  for (let i = 1; i < rows.length; i++) {\n    if (rows[i][domainIndex] === domain) {\n      domainRows.push({ index: i + 1, createdAt: rows[i][createdAtIndex] || '' });\n    }\n  }\n\n  // 4. 1Í∞ú Ïù¥ÏÉÅÏù¥Î©¥ Í∞ÄÏû• Ïò§ÎûòÎêú Ìñâ ÏÇ≠Ï†ú (ÏµúÏã† 1Í∞úÎßå Ïú†ÏßÄ)\n  if (domainRows.length >= 1) {\n    domainRows.sort((a, b) => (a.createdAt || '').localeCompare(b.createdAt || ''));\n    const oldestRowIndex = domainRows[0].index;\n\n    const deleteResponse = await fetchWithTimeout(\n      `https://sheets.googleapis.com/v4/spreadsheets/${env.SHEETS_ID}:batchUpdate`,\n      {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${accessToken}`,\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          requests: [{\n            deleteDimension: {\n              range: {\n                sheetId: latestSheetId,\n                dimension: 'ROWS',\n                startIndex: oldestRowIndex - 1,\n                endIndex: oldestRowIndex\n              }\n            }\n          }]\n        })\n      },\n      10000\n    );\n\n    if (!deleteResponse.ok) {\n      throw new Error(`ÏµúÏã† Ìè¨Ïä§ÌåÖ Ìñâ ÏÇ≠Ï†ú Ïã§Ìå®: ${deleteResponse.status}`);\n    }\n  }\n\n  // 5. ÏµúÏã† Ìè¨Ïä§ÌåÖ ÌÉ≠Ïóê append (Ìó§Îçî ÏàúÏÑúÎåÄÎ°ú)\n  const latestRowData = latestHeaders.map(header => postDataMap[header] || '');\n\n  const latestAppendResponse = await fetchWithTimeout(\n    `https://sheets.googleapis.com/v4/spreadsheets/${env.SHEETS_ID}/values/${encodeURIComponent(latestSheetName)}!A:Z:append?valueInputOption=RAW`,\n    {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${accessToken}`,\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({ values: [latestRowData] })\n    },\n    10000\n  );\n\n  if (!latestAppendResponse.ok) {\n    const errorText = await latestAppendResponse.text();\n    throw new Error(`ÏµúÏã† Ìè¨Ïä§ÌåÖ ÏãúÌä∏ append Ïã§Ìå®: ${latestAppendResponse.status} - ${errorText}`);\n  }\n\n  // ÏµúÏã† Ìè¨Ïä§ÌåÖ ÏãúÌä∏Ïóê ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú ÌñâÏùò ÎÜíÏù¥ÏôÄ ÌÖçÏä§Ìä∏ Ï§ÑÎ∞îÍøà ÏÑ§Ï†ï\n  try {\n    const latestAppendResult = await latestAppendResponse.json();\n    const latestUpdatedRange = latestAppendResult.updates?.updatedRange;\n\n    if (latestUpdatedRange) {\n      const latestRowMatch = latestUpdatedRange.match(/:(\\d+)$/);\n      const latestNewRowIndex = latestRowMatch ? parseInt(latestRowMatch[1]) - 1 : null;\n\n      if (latestNewRowIndex !== null) {\n        const latestFormatRequests = [{\n          updateDimensionProperties: {\n            range: {\n              sheetId: latestSheetId,\n              dimension: 'ROWS',\n              startIndex: latestNewRowIndex,\n              endIndex: latestNewRowIndex + 1\n            },\n            properties: {\n              pixelSize: 21\n            },\n            fields: 'pixelSize'\n          }\n        }, {\n          repeatCell: {\n            range: {\n              sheetId: latestSheetId,\n              startRowIndex: latestNewRowIndex,\n              endRowIndex: latestNewRowIndex + 1\n            },\n            cell: {\n              userEnteredFormat: {\n                wrapStrategy: 'WRAP'\n              }\n            },\n            fields: 'userEnteredFormat.wrapStrategy'\n          }\n        }];\n\n        const latestFormatResponse = await fetchWithTimeout(\n          `https://sheets.googleapis.com/v4/spreadsheets/${env.SHEETS_ID}:batchUpdate`,\n          {\n            method: 'POST',\n            headers: {\n              'Authorization': `Bearer ${accessToken}`,\n              'Content-Type': 'application/json'\n            },\n            body: JSON.stringify({ requests: latestFormatRequests })\n          },\n          10000\n        );\n\n        if (!latestFormatResponse.ok) {\n          console.error(`ÏµúÏã† Ìè¨Ïä§ÌåÖ Ìñâ ÏÑúÏãù ÏÑ§Ï†ï Ïã§Ìå®: ${latestFormatResponse.status}`);\n        } else {\n          console.log(`ÏµúÏã† Ìè¨Ïä§ÌåÖ Ìñâ ${latestNewRowIndex + 1} ÏÑúÏãù ÏÑ§Ï†ï ÏôÑÎ£å (ÎÜíÏù¥ 21px, Ï§ÑÎ∞îÍøà CLIP)`);\n        }\n      }\n    }\n  } catch (error) {\n    console.error(`ÏµúÏã† Ìè¨Ïä§ÌåÖ Ìñâ ÏÑúÏãù ÏÑ§Ï†ï Ï§ë ÏóêÎü¨: ${error.message}`);\n  }\n\n  // 6. ÏµúÏã† Ìè¨Ïä§ÌåÖ Ï†ÄÏû• ÏÑ±Í≥µ ‚Üí Ïù¥Ï†ú Ï†ÄÏû•ÏÜåÏóê Ï†ÄÏû• (Ìä∏ÎûúÏû≠ÏÖò ÏôÑÎ£å)\n  // archiveHeadersÍ∞Ä ÏóÜÍ±∞ÎÇò Îπà Î∞∞Ïó¥Ïù¥Î©¥ ÏóêÎü¨ Ï≤òÎ¶¨\n  if (!archiveHeaders || archiveHeaders.length === 0) {\n    console.error('[ERROR] Ï†ÄÏû•ÏÜå Ìó§Îçî ÏóÜÏùå. archiveHeaders:', archiveHeaders);\n    console.error('Ï†ÄÏû•ÏÜå ÏãúÌä∏ Ìó§ÎçîÍ∞Ä Ï†úÍ≥µÎêòÏßÄ ÏïäÏùå');\n    return; // ÏµúÏã† Ìè¨Ïä§ÌåÖÏùÄ Ïù¥ÎØ∏ Ï†ÄÏû•Îê®, Ï†ÄÏû•ÏÜåÎßå Ïã§Ìå®\n  }\n\n  // Ìó§Îçî ÏàúÏÑúÎåÄÎ°ú rowData ÏÉùÏÑ±\n  const archiveRowData = archiveHeaders.map(header => postDataMap[header] || '');\n  console.log('[INFO] Ï†ÄÏû•ÏÜå Ï†ÄÏû•:', { sheet: archiveSheetName, headersCount: archiveHeaders.length, dataLength: archiveRowData.length });\n\n  // Ï†ÄÏû•ÏÜå ÌÉ≠Ïóê append\n  const archiveAppendResponse = await fetchWithTimeout(\n    `https://sheets.googleapis.com/v4/spreadsheets/${env.SHEETS_ID}/values/${encodeURIComponent(archiveSheetName)}!A:Z:append?valueInputOption=RAW`,\n    {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${accessToken}`,\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({ values: [archiveRowData] })\n    },\n    10000\n  );\n\n  if (!archiveAppendResponse.ok) {\n    const errorText = await archiveAppendResponse.text();\n    console.error(`Ï†ÄÏû•ÏÜå ÏãúÌä∏ append Ïã§Ìå®: ${archiveAppendResponse.status} - ${errorText}`);\n    // ÏµúÏã† Ìè¨Ïä§ÌåÖÏùÄ Ïù¥ÎØ∏ Ï†ÄÏû•Îê®, Ï†ÄÏû•ÏÜå Ï†ÄÏû• Ïã§Ìå®Îäî ÏπòÎ™ÖÏ†ÅÏù¥ÏßÄ ÏïäÏùå\n  } else {\n    console.log('[SUCCESS] Ï†ÄÏû•ÏÜå Ï†ÄÏû• ÏôÑÎ£å');\n    // Ï†ÄÏû•ÏÜå ÏãúÌä∏Ïóê ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú ÌñâÏùò ÎÜíÏù¥ÏôÄ ÌÖçÏä§Ìä∏ Ï§ÑÎ∞îÍøà ÏÑ§Ï†ï\n    try {\n      const appendResult = await archiveAppendResponse.json();\n      const updatedRange = appendResult.updates?.updatedRange;\n\n      if (updatedRange) {\n        // Î≤îÏúÑÏóêÏÑú Ìñâ Î≤àÌò∏ Ï∂îÏ∂ú (Ïòà: \"Ï†ÄÏû•ÏÜå!A20:I20\" ‚Üí 20)\n        const rowMatch = updatedRange.match(/:(\\d+)$/);\n        const newRowIndex = rowMatch ? parseInt(rowMatch[1]) - 1 : null;\n\n        if (newRowIndex !== null) {\n          // Ìñâ ÎÜíÏù¥ 21px + ÌÖçÏä§Ìä∏ Ï§ÑÎ∞îÍøà CLIP ÏÑ§Ï†ï\n          const formatRequests = [{\n            updateDimensionProperties: {\n              range: {\n                sheetId: archiveSheetId,\n                dimension: 'ROWS',\n                startIndex: newRowIndex,\n                endIndex: newRowIndex + 1\n              },\n              properties: {\n                pixelSize: 21\n              },\n              fields: 'pixelSize'\n            }\n          }, {\n            repeatCell: {\n              range: {\n                sheetId: archiveSheetId,\n                startRowIndex: newRowIndex,\n                endRowIndex: newRowIndex + 1\n              },\n              cell: {\n                userEnteredFormat: {\n                  wrapStrategy: 'WRAP'\n                }\n              },\n              fields: 'userEnteredFormat.wrapStrategy'\n            }\n          }];\n\n          const formatResponse = await fetchWithTimeout(\n            `https://sheets.googleapis.com/v4/spreadsheets/${env.SHEETS_ID}:batchUpdate`,\n            {\n              method: 'POST',\n              headers: {\n                'Authorization': `Bearer ${accessToken}`,\n                'Content-Type': 'application/json'\n              },\n              body: JSON.stringify({ requests: formatRequests })\n            },\n            10000\n          );\n\n          if (!formatResponse.ok) {\n            console.error(`Ï†ÄÏû•ÏÜå Ìñâ ÏÑúÏãù ÏÑ§Ï†ï Ïã§Ìå®: ${formatResponse.status}`);\n          } else {\n            console.log(`Ï†ÄÏû•ÏÜå Ìñâ ${newRowIndex + 1} ÏÑúÏãù ÏÑ§Ï†ï ÏôÑÎ£å (ÎÜíÏù¥ 21px, Ï§ÑÎ∞îÍøà CLIP)`);\n          }\n        }\n      }\n    } catch (error) {\n      console.error(`Ï†ÄÏû•ÏÜå Ìñâ ÏÑúÏãù ÏÑ§Ï†ï Ï§ë ÏóêÎü¨: ${error.message}`);\n    }\n  }\n\n  // 7. Í¥ÄÎ¶¨Ïûê ÏãúÌä∏Ïùò Ïó¥ ÎÑàÎπÑÎ•º Ï†ÄÏû•ÏÜå ÏãúÌä∏Ïóê Î≥µÏÇ¨\n  try {\n    if (!adminSheet || !adminSheet.data || !adminSheet.data[0] || !adminSheet.data[0].columnMetadata) {\n      console.error('Í¥ÄÎ¶¨Ïûê ÏãúÌä∏ Ïó¥ ÎÑàÎπÑ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');\n      return;\n    }\n\n    const columnWidths = adminSheet.data[0].columnMetadata.slice(0, 9).map(col => col.pixelSize || 100);\n    console.log(`Í¥ÄÎ¶¨Ïûê ÏãúÌä∏ Ïó¥ ÎÑàÎπÑ (Î≥µÏÇ¨Ìï† Í∞í): ${JSON.stringify(columnWidths)}`);\n\n    // Ï†ÄÏû•ÏÜå ÏãúÌä∏Ïóê Ïó¥ ÎÑàÎπÑ Ï†ÅÏö©\n    const updateRequests = columnWidths.map((width, i) => ({\n      updateDimensionProperties: {\n        range: {\n          sheetId: archiveSheetId,\n          dimension: 'COLUMNS',\n          startIndex: i,\n          endIndex: i + 1\n        },\n        properties: {\n          pixelSize: width\n        },\n        fields: 'pixelSize'\n      }\n    }));\n\n    const updateResponse = await fetch(\n      `https://sheets.googleapis.com/v4/spreadsheets/${env.SHEETS_ID}:batchUpdate`,\n      {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${accessToken}`,\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({ requests: updateRequests })\n      }\n    );\n\n    if (!updateResponse.ok) {\n      const errorText = await updateResponse.text();\n      console.error(`Ï†ÄÏû•ÏÜå ÏãúÌä∏ Ïó¥ ÎÑàÎπÑ ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: ${updateResponse.status} - ${errorText}`);\n    } else {\n      console.log('Ï†ÄÏû•ÏÜå ÏãúÌä∏ Ïó¥ ÎÑàÎπÑ ÏóÖÎç∞Ïù¥Ìä∏ ÏÑ±Í≥µ (Í¥ÄÎ¶¨Ïûê ÏãúÌä∏ Í∏∞Ï§Ä)');\n    }\n  } catch (error) {\n    console.error(`Ïó¥ ÎÑàÎπÑ Î≥µÏÇ¨ Ï§ë ÏóêÎü¨: ${error.message}`);\n  }\n\n  // 8. Í¥ÄÎ¶¨Ïûê ÏãúÌä∏ \"ÌÅ¨Î°†\" Ïª¨Îüº ÏóÖÎç∞Ïù¥Ìä∏ (Îã§Ïùå ÏòàÏ†ï ÏãúÍ∞Ñ)\n  try {\n    // Í¥ÄÎ¶¨Ïûê ÏãúÌä∏ Îç∞Ïù¥ÌÑ∞ ÏùΩÍ∏∞\n    const adminResponse = await fetchWithTimeout(\n      `https://sheets.googleapis.com/v4/spreadsheets/${env.SHEETS_ID}/values/'Í¥ÄÎ¶¨Ïûê'!A:Z`,\n      { headers: { Authorization: `Bearer ${accessToken}` } },\n      10000\n    );\n\n    if (!adminResponse.ok) {\n      console.error('Í¥ÄÎ¶¨Ïûê ÏãúÌä∏ ÏùΩÍ∏∞ Ïã§Ìå® (ÌÅ¨Î°† ÏóÖÎç∞Ïù¥Ìä∏ Ïä§ÌÇµ)');\n      return;\n    }\n\n    const adminData = await adminResponse.json();\n    const adminRows = adminData.values || [];\n\n    if (adminRows.length < 2) {\n      console.error('Í¥ÄÎ¶¨Ïûê ÏãúÌä∏Ïóê Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå (ÌÅ¨Î°† ÏóÖÎç∞Ïù¥Ìä∏ Ïä§ÌÇµ)');\n      return;\n    }\n\n    const adminHeaders = adminRows[0];\n    const adminDomainIndex = adminHeaders.indexOf('ÎèÑÎ©îÏù∏');\n    const cronIndex = adminHeaders.indexOf('ÌÅ¨Î°†');\n\n    if (adminDomainIndex === -1) {\n      console.error('Í¥ÄÎ¶¨Ïûê ÏãúÌä∏Ïóê \"ÎèÑÎ©îÏù∏\" Ïª¨Îüº ÏóÜÏùå');\n      return;\n    }\n\n    if (cronIndex === -1) {\n      console.error('Í¥ÄÎ¶¨Ïûê ÏãúÌä∏Ïóê \"ÌÅ¨Î°†\" Ïª¨Îüº ÏóÜÏùå (ÏóÖÎç∞Ïù¥Ìä∏ Ïä§ÌÇµ)');\n      return;\n    }\n\n    // Ìï¥Îãπ Í±∞ÎûòÏ≤ò Ìñâ Ï∞æÍ∏∞\n    let targetRowIndex = -1;\n    for (let i = 1; i < adminRows.length; i++) {\n      const row = adminRows[i];\n      const rowDomain = (row[adminDomainIndex] || '').replace('.make-page.com', '').replace('/', '');\n      if (rowDomain === normalizedSubdomain) {\n        targetRowIndex = i + 1; // 1-indexed\n        break;\n      }\n    }\n\n    if (targetRowIndex === -1) {\n      console.error(`Í¥ÄÎ¶¨Ïûê ÏãúÌä∏ÏóêÏÑú ${normalizedSubdomain} ÌñâÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå`);\n      return;\n    }\n\n    // Îã§Ïùå ÏòàÏ†ï ÏãúÍ∞Ñ Í≥ÑÏÇ∞ (ÎÇ¥Ïùº 09:00 KST)\n    const tomorrow = new Date(koreaTime);\n    tomorrow.setDate(tomorrow.getDate() + 1);\n    tomorrow.setHours(9, 0, 0, 0);\n    const nextCronTime = tomorrow.toISOString().replace('T', ' ').substring(0, 16); // \"YYYY-MM-DD HH:mm\"\n\n    // ÌÅ¨Î°† Ïª¨Îüº ÏóÖÎç∞Ïù¥Ìä∏\n    const cronColumnLetter = getColumnLetter(cronIndex);\n    const updateRange = `Í¥ÄÎ¶¨Ïûê!${cronColumnLetter}${targetRowIndex}`;\n\n    const updateResponse = await fetch(\n      `https://sheets.googleapis.com/v4/spreadsheets/${env.SHEETS_ID}/values/${encodeURIComponent(updateRange)}?valueInputOption=RAW`,\n      {\n        method: 'PUT',\n        headers: {\n          'Authorization': `Bearer ${accessToken}`,\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          values: [[nextCronTime]]\n        })\n      }\n    );\n\n    if (updateResponse.ok) {\n      console.log(`ÌÅ¨Î°† Ïª¨Îüº ÏóÖÎç∞Ïù¥Ìä∏ ÏÑ±Í≥µ: ${nextCronTime}`);\n    } else {\n      console.error(`ÌÅ¨Î°† Ïª¨Îüº ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: ${updateResponse.status}`);\n    }\n\n    // 9. Í¥ÄÎ¶¨Ïûê ÏãúÌä∏ \"ÏÉÅÌÉú\" Ïª¨Îüº ÏóÖÎç∞Ïù¥Ìä∏ (ÏÑ±Í≥µ)\n    const statusIndex = adminHeaders.indexOf('ÏÉÅÌÉú');\n\n    if (statusIndex === -1) {\n      console.log('Í¥ÄÎ¶¨Ïûê ÏãúÌä∏Ïóê \"ÏÉÅÌÉú\" Ïª¨Îüº ÏóÜÏùå (ÏóÖÎç∞Ïù¥Ìä∏ Ïä§ÌÇµ)');\n    } else {\n      const statusColumnLetter = getColumnLetter(statusIndex);\n      const statusUpdateRange = `Í¥ÄÎ¶¨Ïûê!${statusColumnLetter}${targetRowIndex}`;\n\n      const statusUpdateResponse = await fetch(\n        `https://sheets.googleapis.com/v4/spreadsheets/${env.SHEETS_ID}/values/${encodeURIComponent(statusUpdateRange)}?valueInputOption=RAW`,\n        {\n          method: 'PUT',\n          headers: {\n            'Authorization': `Bearer ${accessToken}`,\n            'Content-Type': 'application/json'\n          },\n          body: JSON.stringify({\n            values: [['ÏÑ±Í≥µ']]\n          })\n        }\n      );\n\n      if (statusUpdateResponse.ok) {\n        console.log(`ÏÉÅÌÉú Ïª¨Îüº ÏóÖÎç∞Ïù¥Ìä∏ ÏÑ±Í≥µ: ÏÑ±Í≥µ`);\n      } else {\n        console.error(`ÏÉÅÌÉú Ïª¨Îüº ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: ${statusUpdateResponse.status}`);\n      }\n    }\n\n  } catch (error) {\n    console.error(`ÌÅ¨Î°†/ÏÉÅÌÉú Ïª¨Îüº ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë ÏóêÎü¨: ${error.message}`);\n  }\n}\n\n// Ïª¨Îüº Ïù∏Îç±Ïä§Î•º Î¨∏ÏûêÎ°ú Î≥ÄÌôò (0 -> A, 1 -> B, ...)\nfunction getColumnLetter(index) {\n  let letter = '';\n  while (index >= 0) {\n    letter = String.fromCharCode((index % 26) + 65) + letter;\n    index = Math.floor(index / 26) - 1;\n  }\n  return letter;\n}\n\nasync function getSheetId(sheetsId, sheetName, accessToken) {\n  const response = await fetch(\n    `https://sheets.googleapis.com/v4/spreadsheets/${sheetsId}?fields=sheets(properties(sheetId,title))`,\n    { headers: { Authorization: `Bearer ${accessToken}` } }\n  );\n  const data = await response.json();\n  const sheet = data.sheets.find(s => s.properties.title === sheetName);\n  return sheet ? sheet.properties.sheetId : 0;\n}\n\n\n// Deploy trigger\n\n",
  "encoding": "base64",
  "_links": {
    "self": "https://api.github.com/repos/jeonwoohyun85/content-factory/contents/workers/make-page-subdomain.js?ref=main",
    "git": "https://api.github.com/repos/jeonwoohyun85/content-factory/git/blobs/8237cf1368ceb6189926772598ad32b5ceeb8ef2",
    "html": "https://github.com/jeonwoohyun85/content-factory/blob/main/workers/make-page-subdomain.js"
  }
}