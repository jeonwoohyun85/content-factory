name: ì¼ë³„ ìš”ì•½ ìë™ ì—…ë°ì´íŠ¸

on:
  schedule:
    # ë§¤ì¼ 00:00 KST (ì „ë‚  15:00 UTC)
    - cron: '0 15 * * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  update-daily:
    runs-on: ubuntu-latest
    name: ì¼ë³„ ìš”ì•½ ìë™ ì—…ë°ì´íŠ¸
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ì „ì¼ ë°°í¬ ì´ë ¥ ì¡°íšŒ
        run: |
          # ì–´ì œ ë‚ ì§œ ê³„ì‚° (KST)
          YESTERDAY=$(TZ='Asia/Seoul' date -d 'yesterday' +"%Y-%m-%d")
          echo "YESTERDAY=$YESTERDAY" >> $GITHUB_ENV

          gh run list \
            --repo jeonwoohyun85/content-factory \
            --status success \
            --limit 10000 \
            --json displayTitle,createdAt,conclusion \
            > all-runs.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ì „ì¼ ìš”ì•½ ìƒì„±
        run: |
          cat > generate_summary.py << 'SCRIPT_EOF'
import json
import os
from datetime import datetime, timedelta
from collections import defaultdict

yesterday = os.environ['YESTERDAY']

# ë°°í¬ ë°ì´í„° ë¡œë“œ
with open('all-runs.json', 'r', encoding='utf-8') as f:
    runs = json.load(f)

# workflow_dispatch ì œì™¸
runs = [r for r in runs if r['displayTitle'] != 'í´ë¼ìš°ë“œí”Œë ˆì–´ ì›Œì»¤ ìë™ ë°°í¬']

# ì–´ì œ ë°°í¬ë§Œ í•„í„°ë§
yesterday_runs = []
for run in runs:
    timestamp = run['createdAt']
    utc_dt = datetime.fromisoformat(timestamp.replace('Z', '+00:00'))
    kst_dt = utc_dt + timedelta(hours=9)

    if kst_dt.strftime('%Y-%m-%d') == yesterday:
        title = run['displayTitle'].strip()
        if ':' in title:
            category = title.split(':')[0].strip()
            text = title.split(':', 1)[1].strip()
        else:
            category = 'other'
            text = title

        yesterday_runs.append({
            'time': kst_dt.strftime('%H:%M'),
            'category': category,
            'title': text
        })

if not yesterday_runs:
    print(f"{yesterday} ë°°í¬ ì—†ìŒ")
    with open('summary.txt', 'w', encoding='utf-8') as f:
        f.write('')
    exit(0)

# ì¹´í…Œê³ ë¦¬ë³„ ì§‘ê³„
categories = defaultdict(list)
for run in yesterday_runs:
    categories[run['category']].append(run['title'])

# ìš”ì•½ ìƒì„±
summary_lines = []
summary_lines.append(f"## {yesterday} ì‘ì—… ìš”ì•½")
summary_lines.append(f"")
summary_lines.append(f"**ì´ {len(yesterday_runs)}ê±´ ë°°í¬**")
summary_lines.append(f"")

# ì¹´í…Œê³ ë¦¬ë³„ ìš”ì•½
if 'feature' in categories or 'feat' in categories:
    all_features = categories.get('feature', []) + categories.get('feat', [])
    summary_lines.append(f"### âœ¨ ì‹ ê·œ ê¸°ëŠ¥ ({len(all_features)}ê±´)")
    for title in all_features[:5]:
        summary_lines.append(f"- {title}")
    summary_lines.append(f"")

if 'fix' in categories or 'bugfix' in categories:
    all_fixes = categories.get('fix', []) + categories.get('bugfix', [])
    summary_lines.append(f"### ğŸ› ë²„ê·¸ ìˆ˜ì • ({len(all_fixes)}ê±´)")
    for title in all_fixes[:5]:
        summary_lines.append(f"- {title}")
    summary_lines.append(f"")

if 'improvement' in categories or 'performance' in categories:
    all_improvements = categories.get('improvement', []) + categories.get('performance', [])
    summary_lines.append(f"### âš¡ ê°œì„  ì‚¬í•­ ({len(all_improvements)}ê±´)")
    for title in all_improvements[:5]:
        summary_lines.append(f"- {title}")
    summary_lines.append(f"")

if 'deprecate' in categories:
    summary_lines.append(f"### ğŸ—‘ï¸ íê¸° ({len(categories['deprecate'])}ê±´)")
    for title in categories['deprecate']:
        summary_lines.append(f"- {title}")
    summary_lines.append(f"")

# íŒŒì¼ ì €ì¥
with open('summary.txt', 'w', encoding='utf-8') as f:
    f.write('\n'.join(summary_lines))

print(f"{yesterday} ìš”ì•½ ìƒì„± ì™„ë£Œ")
SCRIPT_EOF

          python3 generate_summary.py

      - name: PROJECT.mdì— ìš”ì•½ ì¶”ê°€
        run: |
          if [ ! -s summary.txt ]; then
            echo "ìš”ì•½ ì—†ìŒ, ê±´ë„ˆëœ€"
            exit 0
          fi

          python3 << 'UPDATE_EOF'
with open('PROJECT.md', 'r', encoding='utf-8') as f:
    content = f.read()

with open('summary.txt', 'r', encoding='utf-8') as f:
    summary = f.read().strip()

if not summary:
    print("ìš”ì•½ ì—†ìŒ")
    exit(0)

# "## ë°°í¬ ì´ë ¥" ë°”ë¡œ ì•„ë˜ì— ì¶”ê°€
parts = content.split('## ë°°í¬ ì´ë ¥')
if len(parts) != 2:
    print("ë°°í¬ ì´ë ¥ ì„¹ì…˜ ì—†ìŒ")
    exit(1)

new_content = parts[0] + '## ë°°í¬ ì´ë ¥\n\n' + summary + '\n\n---\n\n' + parts[1].lstrip()

with open('PROJECT.md', 'w', encoding='utf-8') as f:
    f.write(new_content)

print("ìš”ì•½ ì¶”ê°€ ì™„ë£Œ")
UPDATE_EOF

      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add PROJECT.md
          git diff --staged --quiet || git commit -m "docs: ì¼ë³„ ìš”ì•½ ìë™ ì—…ë°ì´íŠ¸ [skip ci]"

      - name: ë³€ê²½ì‚¬í•­ í‘¸ì‹œ
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
