name: Health Check Cron

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check cron system health
        run: |
          echo "Running health check"

          RESPONSE=$(curl -X POST "https://make-page.com/test-posting" \
            -H "Content-Type: application/json" \
            -d '{"subdomain":"00001"}' \
            --max-time 60 -s)

          if [ -z "$RESPONSE" ]; then
            curl -X POST "https://api.telegram.org/bot8328468112:AAHcfkNgMXPR4hbc4b5g0G3K_oFnQurryqs/sendMessage" \
              -H "Content-Type: application/json" \
              -d '{"chat_id":"6857038085","text":"üî¥ Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå®\n\nÎ¨∏Ï†ú: ÏùëÎãµ ÏóÜÏùå"}' \
              --max-time 10
            exit 1
          fi

          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          TITLE_LEN=$(echo "$RESPONSE" | jq -r '.validation.title_length // 0')
          BODY_LEN=$(echo "$RESPONSE" | jq -r '.validation.body_length // 0')
          IMG_COUNT=$(echo "$RESPONSE" | jq -r '.validation.image_count // 0')
          SPECIAL_RATIO=$(echo "$RESPONSE" | jq -r '.validation.special_char_ratio // 0')
          BUSINESS=$(echo "$RESPONSE" | jq -r '.validation.business_name // "ÏïåÏàòÏóÜÏùå"')
          FIRST_IMG_POS=$(echo "$RESPONSE" | jq -r '.validation.first_image_position // 0')
          IMG_DIST=$(echo "$RESPONSE" | jq -r '.validation.image_distribution // "none"')

          ERRORS=""

          if [ "$SUCCESS" != "true" ]; then
            ERRORS="${ERRORS}‚Ä¢ Ìè¨Ïä§ÌåÖ ÏÉùÏÑ± Ïã§Ìå®\n"
          fi

          if [ "$TITLE_LEN" -lt 10 ] || [ "$TITLE_LEN" -gt 100 ]; then
            ERRORS="${ERRORS}‚Ä¢ Ï†úÎ™© Í∏∏Ïù¥: ${TITLE_LEN}Ïûê (Ï†ïÏÉÅ: 10-100)\n"
          fi

          if [ "$BODY_LEN" -lt 2800 ] || [ "$BODY_LEN" -gt 3200 ]; then
            ERRORS="${ERRORS}‚Ä¢ Î≥∏Î¨∏ Í∏∏Ïù¥: ${BODY_LEN}Ïûê (Ï†ïÏÉÅ: 2800-3200)\n"
          fi

          if [ "$IMG_COUNT" -lt 1 ]; then
            ERRORS="${ERRORS}‚Ä¢ Ïù¥ÎØ∏ÏßÄ ÎàÑÎùΩ: ${IMG_COUNT}Í∞ú\n"
          fi

          if [ "$SPECIAL_RATIO" -gt 50 ]; then
            ERRORS="${ERRORS}‚Ä¢ ÌäπÏàòÎ¨∏Ïûê Í≥ºÎã§: ${SPECIAL_RATIO}%\n"
          fi

          if [ "$FIRST_IMG_POS" -gt 40 ]; then
            ERRORS="${ERRORS}‚Ä¢ Ï≤´ Ïù¥ÎØ∏ÏßÄ ÏúÑÏπò: ${FIRST_IMG_POS}% (Ï†ïÏÉÅ: 40% Ïù¥ÎÇ¥)\n"
          fi

          if [ "$IMG_DIST" = "clustered" ]; then
            ERRORS="${ERRORS}‚Ä¢ Ïù¥ÎØ∏ÏßÄ Î™∞Î¶º ÌòÑÏÉÅ Î∞úÍ≤¨\n"
          fi

          if [ -n "$ERRORS" ]; then
            curl -X POST "https://api.telegram.org/bot8328468112:AAHcfkNgMXPR4hbc4b5g0G3K_oFnQurryqs/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\":\"6857038085\",\"text\":\"üî¥ Ìè¨Ïä§ÌåÖ ÌíàÏßà Í≤ÄÏ¶ù Ïã§Ìå®\n\nÍ±∞ÎûòÏ≤ò: ${BUSINESS}\n\nÎ¨∏Ï†ú:\n${ERRORS}\"}" \
              --max-time 10
            exit 1
          fi

          echo "‚úÖ Health check passed"

      - name: Check posting time sync
        run: |
          echo "Checking posting time synchronization"

          SHEET_URL="https://docs.google.com/spreadsheets/d/1KrzLFi8Wt9GTGT97gcMoXnbZ3OJ04NsP4lncJyIdyhU/gviz/tq?tqx=out:csv&sheet=%EC%B5%9C%EC%8B%A0_%ED%8F%AC%EC%8A%A4%ED%8C%85"
          SHEET_DATA=$(curl -s "$SHEET_URL")

          # Í∞Å Í±∞ÎûòÏ≤òÏùò ÏµúÏã† Ìè¨Ïä§ÌåÖ Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú
          DATA_00001=$(echo "$SHEET_DATA" | grep "00001" | head -1)
          DATA_00002=$(echo "$SHEET_DATA" | grep "00002" | head -1)
          DATA_00003=$(echo "$SHEET_DATA" | grep "00003" | head -1)
          DATA_00004=$(echo "$SHEET_DATA" | grep "00004" | head -1)

          # ÏÉÅÌò∏Î™Ö (2Î≤àÏß∏ Ïª¨Îüº)
          NAME_00001=$(echo "$DATA_00001" | cut -d',' -f2 | tr -d '"')
          NAME_00002=$(echo "$DATA_00002" | cut -d',' -f2 | tr -d '"')
          NAME_00003=$(echo "$DATA_00003" | cut -d',' -f2 | tr -d '"')
          NAME_00004=$(echo "$DATA_00004" | cut -d',' -f2 | tr -d '"')

          # ÏÉùÏÑ±ÏùºÏãú (4Î≤àÏß∏ Ïª¨Îüº)
          TIME_00001=$(echo "$DATA_00001" | cut -d',' -f4 | tr -d '"')
          TIME_00002=$(echo "$DATA_00002" | cut -d',' -f4 | tr -d '"')
          TIME_00003=$(echo "$DATA_00003" | cut -d',' -f4 | tr -d '"')
          TIME_00004=$(echo "$DATA_00004" | cut -d',' -f4 | tr -d '"')

          echo "00001 ($NAME_00001): $TIME_00001"
          echo "00002 ($NAME_00002): $TIME_00002"
          echo "00003 ($NAME_00003): $TIME_00003"
          echo "00004 ($NAME_00004): $TIME_00004"

          # ÏãúÍ∞ÑÏùÑ timestampÎ°ú Î≥ÄÌôò (Îπà Í∞í Ï≤¥ÌÅ¨)
          if [ -z "$TIME_00001" ] || [ -z "$TIME_00002" ] || [ -z "$TIME_00003" ] || [ -z "$TIME_00004" ]; then
            curl -X POST "https://api.telegram.org/bot8328468112:AAHcfkNgMXPR4hbc4b5g0G3K_oFnQurryqs/sendMessage" \
              -H "Content-Type: application/json" \
              -d '{"chat_id":"6857038085","text":"üî¥ Ìè¨Ïä§ÌåÖ ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî Ïã§Ìå®\n\nÎ¨∏Ï†ú: ÏùºÎ∂Ä Í±∞ÎûòÏ≤ò Ìè¨Ïä§ÌåÖ ÏãúÍ∞Ñ ÎàÑÎùΩ"}' \
              --max-time 10
            exit 1
          fi

          TS_00001=$(date -d "$TIME_00001" +%s 2>/dev/null || echo "0")
          TS_00002=$(date -d "$TIME_00002" +%s 2>/dev/null || echo "0")
          TS_00003=$(date -d "$TIME_00003" +%s 2>/dev/null || echo "0")
          TS_00004=$(date -d "$TIME_00004" +%s 2>/dev/null || echo "0")

          # ÏµúÏã† ÏãúÍ∞ÑÍ≥º Í∞ÄÏû• Ïò§ÎûòÎêú ÏãúÍ∞Ñ Ï∞æÍ∏∞
          MAX_TS=$TS_00001
          MIN_TS=$TS_00001
          OLDEST_CLIENT="00001"
          NEWEST_CLIENT="00001"

          if [ $TS_00002 -gt $MAX_TS ]; then
            MAX_TS=$TS_00002
            NEWEST_CLIENT="00002"
          fi
          if [ $TS_00002 -lt $MIN_TS ]; then
            MIN_TS=$TS_00002
            OLDEST_CLIENT="00002"
          fi

          if [ $TS_00003 -gt $MAX_TS ]; then
            MAX_TS=$TS_00003
            NEWEST_CLIENT="00003"
          fi
          if [ $TS_00003 -lt $MIN_TS ]; then
            MIN_TS=$TS_00003
            OLDEST_CLIENT="00003"
          fi

          if [ $TS_00004 -gt $MAX_TS ]; then
            MAX_TS=$TS_00004
            NEWEST_CLIENT="00004"
          fi
          if [ $TS_00004 -lt $MIN_TS ]; then
            MIN_TS=$TS_00004
            OLDEST_CLIENT="00004"
          fi

          # ÏãúÍ∞ÑÏ∞® Í≥ÑÏÇ∞ (Ï¥à)
          TIME_DIFF=$((MAX_TS - MIN_TS))
          TIME_DIFF_MIN=$((TIME_DIFF / 60))

          echo "Time difference: ${TIME_DIFF_MIN} minutes"

          # 30Î∂Ñ(1800Ï¥à) Ïù¥ÏÉÅ Ï∞®Ïù¥ÎÇòÎ©¥ ÏïåÎ¶º
          if [ $TIME_DIFF -gt 1800 ]; then
            # Í∞Å Í±∞ÎûòÏ≤ò Ï†ïÎ≥¥ Íµ¨ÏÑ±
            case $NEWEST_CLIENT in
              00001) NEWEST_NAME="$NAME_00001"; NEWEST_TIME="$TIME_00001" ;;
              00002) NEWEST_NAME="$NAME_00002"; NEWEST_TIME="$TIME_00002" ;;
              00003) NEWEST_NAME="$NAME_00003"; NEWEST_TIME="$TIME_00003" ;;
              00004) NEWEST_NAME="$NAME_00004"; NEWEST_TIME="$TIME_00004" ;;
            esac

            case $OLDEST_CLIENT in
              00001) OLDEST_NAME="$NAME_00001"; OLDEST_TIME="$TIME_00001" ;;
              00002) OLDEST_NAME="$NAME_00002"; OLDEST_TIME="$TIME_00002" ;;
              00003) OLDEST_NAME="$NAME_00003"; OLDEST_TIME="$TIME_00003" ;;
              00004) OLDEST_NAME="$NAME_00004"; OLDEST_TIME="$TIME_00004" ;;
            esac

            MESSAGE="‚ö†Ô∏è Ìè¨Ïä§ÌåÖ ÏãúÍ∞Ñ Î∂àÏùºÏπò Í∞êÏßÄ\n\nÏãúÍ∞ÑÏ∞®: ${TIME_DIFF_MIN}Î∂Ñ\n\nÍ±∞ÎûòÏ≤ò ÌòÑÌô©:\n‚Ä¢ 00001 (${NAME_00001}): ${TIME_00001}\n‚Ä¢ 00002 (${NAME_00002}): ${TIME_00002}\n‚Ä¢ 00003 (${NAME_00003}): ${TIME_00003}\n‚Ä¢ 00004 (${NAME_00004}): ${TIME_00004}\n\n‚ö†Ô∏è ÌôïÏù∏ ÌïÑÏöî: ${OLDEST_CLIENT} (${OLDEST_NAME})\nÏµúÏã†: ${NEWEST_CLIENT} (${NEWEST_NAME})"

            curl -X POST "https://api.telegram.org/bot8328468112:AAHcfkNgMXPR4hbc4b5g0G3K_oFnQurryqs/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\":\"6857038085\",\"text\":\"${MESSAGE}\"}" \
              --max-time 10
          fi

          echo "‚úÖ Time sync check completed"
