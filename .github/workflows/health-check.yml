name: Health Check Cron

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check cron system health
        run: |
          echo "Running health check"

          RESPONSE=$(curl -X POST "https://make-page.com/test-posting" \
            -H "Content-Type: application/json" \
            -d '{"subdomain":"00001"}' \
            --max-time 60 -s)

          if [ -z "$RESPONSE" ]; then
            curl -X POST "https://api.telegram.org/bot8328468112:AAHcfkNgMXPR4hbc4b5g0G3K_oFnQurryqs/sendMessage" \
              -H "Content-Type: application/json" \
              -d '{"chat_id":"6857038085","text":"ğŸ”´ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨\n\në¬¸ì œ: ì‘ë‹µ ì—†ìŒ"}' \
              --max-time 10
            exit 1
          fi

          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          TITLE_LEN=$(echo "$RESPONSE" | jq -r '.validation.title_length // 0')
          BODY_LEN=$(echo "$RESPONSE" | jq -r '.validation.body_length // 0')
          IMG_COUNT=$(echo "$RESPONSE" | jq -r '.validation.image_count // 0')
          SPECIAL_RATIO=$(echo "$RESPONSE" | jq -r '.validation.special_char_ratio // 0')
          BUSINESS=$(echo "$RESPONSE" | jq -r '.validation.business_name // "ì•Œìˆ˜ì—†ìŒ"')
          FIRST_IMG_POS=$(echo "$RESPONSE" | jq -r '.validation.first_image_position // 0')
          IMG_DIST=$(echo "$RESPONSE" | jq -r '.validation.image_distribution // "none"')

          ERRORS=""

          if [ "$SUCCESS" != "true" ]; then
            ERRORS="${ERRORS}â€¢ í¬ìŠ¤íŒ… ìƒì„± ì‹¤íŒ¨\n"
          fi

          if [ "$TITLE_LEN" -lt 10 ] || [ "$TITLE_LEN" -gt 100 ]; then
            ERRORS="${ERRORS}â€¢ ì œëª© ê¸¸ì´: ${TITLE_LEN}ì (ì •ìƒ: 10-100)\n"
          fi

          if [ "$BODY_LEN" -lt 2800 ] || [ "$BODY_LEN" -gt 3200 ]; then
            ERRORS="${ERRORS}â€¢ ë³¸ë¬¸ ê¸¸ì´: ${BODY_LEN}ì (ì •ìƒ: 2800-3200)\n"
          fi

          if [ "$IMG_COUNT" -lt 1 ]; then
            ERRORS="${ERRORS}â€¢ ì´ë¯¸ì§€ ëˆ„ë½: ${IMG_COUNT}ê°œ\n"
          fi

          if [ "$SPECIAL_RATIO" -gt 50 ]; then
            ERRORS="${ERRORS}â€¢ íŠ¹ìˆ˜ë¬¸ì ê³¼ë‹¤: ${SPECIAL_RATIO}%\n"
          fi

          if [ "$FIRST_IMG_POS" -gt 40 ]; then
            ERRORS="${ERRORS}â€¢ ì²« ì´ë¯¸ì§€ ìœ„ì¹˜: ${FIRST_IMG_POS}% (ì •ìƒ: 40% ì´ë‚´)\n"
          fi

          if [ "$IMG_DIST" = "clustered" ]; then
            ERRORS="${ERRORS}â€¢ ì´ë¯¸ì§€ ëª°ë¦¼ í˜„ìƒ ë°œê²¬\n"
          fi

          if [ -n "$ERRORS" ]; then
            curl -X POST "https://api.telegram.org/bot8328468112:AAHcfkNgMXPR4hbc4b5g0G3K_oFnQurryqs/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\":\"6857038085\",\"text\":\"ğŸ”´ í¬ìŠ¤íŒ… í’ˆì§ˆ ê²€ì¦ ì‹¤íŒ¨\n\nê±°ë˜ì²˜: ${BUSINESS}\n\në¬¸ì œ:\n${ERRORS}\"}" \
              --max-time 10
            exit 1
          fi

          echo "âœ… Health check passed"
