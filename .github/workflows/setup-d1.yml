name: D1 데이터베이스 설정

on:
  workflow_dispatch:

jobs:
  setup-d1:
    runs-on: ubuntu-latest
    steps:
      - name: D1 생성 및 스키마 설정
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          # wrangler 설치
          npm install -g wrangler
          
          echo "=== D1 데이터베이스 생성 ==="
          wrangler d1 create content-factory-analytics || echo "이미 존재"
          
          echo ""
          echo "=== 스키마 생성 ==="
          wrangler d1 execute content-factory-analytics --remote --command "
          CREATE TABLE IF NOT EXISTS analytics_visits (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            subdomain TEXT NOT NULL,
            visited_at INTEGER NOT NULL,
            country TEXT,
            city TEXT,
            referrer TEXT,
            user_agent TEXT,
            pathname TEXT,
            visitor_hash TEXT,
            is_unique_today INTEGER DEFAULT 1
          );
          
          CREATE INDEX IF NOT EXISTS idx_subdomain_time ON analytics_visits(subdomain, visited_at DESC);
          CREATE INDEX IF NOT EXISTS idx_subdomain_date ON analytics_visits(subdomain, visited_at);
          CREATE INDEX IF NOT EXISTS idx_visitor_hash_date ON analytics_visits(subdomain, visitor_hash, visited_at);
          "
          
          echo ""
          echo "=== 테이블 확인 ==="
          wrangler d1 execute content-factory-analytics --remote --command "SELECT name FROM sqlite_master WHERE type='table';"
          
          echo ""
          echo "=== 완료 ==="
