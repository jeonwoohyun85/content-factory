name: Update PROJECT.md

on:
  push:
    branches:
      - main

jobs:
  update-project-md:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Extract commit info
        id: commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_DATE=$(date -u +"%Y-%m-%d %H:%M")
          CATEGORY=$(echo "$COMMIT_MSG" | grep -oP '^[a-z]+(?=:)' || echo "other")
          TITLE=$(echo "$COMMIT_MSG" | sed 's/^[a-z]*: //' | head -1)

          echo "category=$CATEGORY" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "date=$COMMIT_DATE" >> $GITHUB_OUTPUT

      - name: Update PROJECT.md
        if: steps.commit.outputs.category != 'other'
        run: |
          CATEGORY="${{ steps.commit.outputs.category }}"
          TITLE="${{ steps.commit.outputs.title }}"
          DATE="${{ steps.commit.outputs.date }}"

          # ì¹´í…Œê³ ë¦¬ë³„ ì•„ì´ì½˜
          case $CATEGORY in
            feature) ICON="âœ¨" ;;
            bugfix) ICON="ğŸ›" ;;
            deprecate) ICON="âŒ" ;;
            improvement) ICON="âš¡" ;;
            security) ICON="ğŸ”’" ;;
            performance) ICON="ğŸš€" ;;
            deployment) ICON="ğŸ“¦" ;;
            infra) ICON="ğŸ”§" ;;
            docs) ICON="ğŸ“" ;;
            *) ICON="ğŸ“Œ" ;;
          esac

          # PROJECT.mdê°€ ì—†ìœ¼ë©´ ìƒì„±
          if [ ! -f PROJECT.md ]; then
            echo "# CAPS Project History" > PROJECT.md
            echo "" >> PROJECT.md
            echo "## Development Log" >> PROJECT.md
            echo "" >> PROJECT.md
          fi

          # ìƒˆ ì—”íŠ¸ë¦¬ ì¶”ê°€
          ENTRY="- **$DATE** $ICON [$CATEGORY] $TITLE"

          # "## Development Log" ë‹¤ìŒ ì¤„ì— ì¶”ê°€
          sed -i "/## Development Log/a\\
          \\
          $ENTRY" PROJECT.md

      - name: Commit changes
        if: steps.commit.outputs.category != 'other'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add PROJECT.md
          git diff --staged --quiet || git commit -m "docs: Update PROJECT.md [skip ci]"

      - name: Push changes
        if: steps.commit.outputs.category != 'other'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
