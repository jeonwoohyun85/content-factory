name: í”„ë¡œì íŠ¸ íˆìŠ¤í† ë¦¬ ìë™ ì—…ë°ì´íŠ¸

on:
  push:
    branches:
      - main

jobs:
  update-project-md:
    runs-on: ubuntu-latest
    name: PROJECT.md ì—…ë°ì´íŠ¸ ì‘ì—…
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ì»¤ë°‹ ì •ë³´ ì¶”ì¶œ (KST)
        id: commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_DATE=$(TZ='Asia/Seoul' date +"%Y-%m-%d")
          COMMIT_TIME=$(TZ='Asia/Seoul' date +"%H:%M")
          CATEGORY=$(echo "$COMMIT_MSG" | grep -oP '^[a-z]+(?=:)' || echo "other")
          TITLE=$(echo "$COMMIT_MSG" | sed 's/^[a-z]*: //' | head -1)

          echo "category=$CATEGORY" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "date=$COMMIT_DATE" >> $GITHUB_OUTPUT
          echo "time=$COMMIT_TIME" >> $GITHUB_OUTPUT

      - name: PROJECT.md íŒŒì¼ ì—…ë°ì´íŠ¸ (ì¼ë³„ í—¤ë”)
        if: steps.commit.outputs.category != 'other'
        run: |
          CATEGORY="${{ steps.commit.outputs.category }}"
          TITLE="${{ steps.commit.outputs.title }}"
          DATE="${{ steps.commit.outputs.date }}"
          TIME="${{ steps.commit.outputs.time }}"

          case "$CATEGORY" in
            feature) ICON="âœ¨" ;;
            feat) ICON="âœ¨" ;;
            fix) ICON="ğŸ›" ;;
            bugfix) ICON="ğŸ›" ;;
            refactor) ICON="â™»ï¸" ;;
            deprecate) ICON="ğŸ—‘ï¸" ;;
            improvement) ICON="âš¡" ;;
            security) ICON="ğŸ”’" ;;
            performance) ICON="ğŸš€" ;;
            deployment) ICON="ğŸ“¦" ;;
            infra) ICON="ğŸ—ï¸" ;;
            docs) ICON="ğŸ“" ;;
            *) ICON="ğŸ”¹" ;;
          esac

          export ICON DATE TIME CATEGORY TITLE
          python3 << 'PYSCRIPT_EOF'
import re
import os

date = os.environ['DATE']
time = os.environ['TIME']
icon = os.environ['ICON']
category = os.environ['CATEGORY']
title = os.environ['TITLE']

with open('PROJECT.md', 'r', encoding='utf-8') as f:
    lines = f.readlines()

# ìƒì„¸ íƒ€ì„ë¼ì¸ ì°¾ê¸°
timeline_idx = None
for i, line in enumerate(lines):
    if '### ğŸ“‹ ìƒì„¸ íƒ€ì„ë¼ì¸' in line:
        timeline_idx = i
        break

if timeline_idx is None:
    print("ìƒì„¸ íƒ€ì„ë¼ì¸ ì„¹ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    exit(1)

# ì˜¤ëŠ˜ ë‚ ì§œ í—¤ë” ì°¾ê¸°
date_header_idx = None
for i in range(timeline_idx + 1, len(lines)):
    if lines[i].strip() == f'#### {date}':
        date_header_idx = i
        break
    # ë‹¤ë¥¸ ë‚ ì§œ í—¤ë”ê°€ ë‚˜ì˜¤ë©´ ì¤‘ë‹¨
    if lines[i].startswith('#### 20'):
        break

# ìƒˆ ì—”íŠ¸ë¦¬
new_entry = f'- **{time}** {icon} [{category}] {title}\n'

# ì‚½ì…
if date_header_idx is not None:
    # ë‚ ì§œ í—¤ë” ì•„ë˜ ë¹ˆ ì¤„ ë‹¤ìŒì— ì¶”ê°€
    lines.insert(date_header_idx + 2, new_entry)
else:
    # ìƒˆ ë‚ ì§œ í—¤ë” ìƒì„±
    lines.insert(timeline_idx + 2, f'#### {date}\n')
    lines.insert(timeline_idx + 3, '\n')
    lines.insert(timeline_idx + 4, new_entry)
    lines.insert(timeline_idx + 5, '\n')

with open('PROJECT.md', 'w', encoding='utf-8') as f:
    f.writelines(lines)

print(f'ì¶”ê°€ë¨: {date} {time} [{category}] {title}')
PYSCRIPT_EOF

      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        if: steps.commit.outputs.category != 'other'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add PROJECT.md
          git diff --staged --quiet || git commit -m "docs: Update PROJECT.md [skip ci]"

      - name: ë³€ê²½ì‚¬í•­ í‘¸ì‹œ
        if: steps.commit.outputs.category != 'other'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
