name: ÌîÑÎ°úÏ†ùÌä∏ ÌûàÏä§ÌÜ†Î¶¨ ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏

on:
  push:
    branches:
      - main

jobs:
  update-project-md:
    runs-on: ubuntu-latest
    name: PROJECT.md ÏóÖÎç∞Ïù¥Ìä∏ ÏûëÏóÖ
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Ïª§Î∞ã Ï†ïÎ≥¥ Ï∂îÏ∂ú
        id: commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_DATE=$(TZ='Asia/Seoul' date +"%Y-%m-%d %H:%M")
          CATEGORY=$(echo "$COMMIT_MSG" | grep -oP '^[a-z]+(?=:)' || echo "other")
          TITLE=$(echo "$COMMIT_MSG" | sed 's/^[a-z]*: //' | head -1)

          echo "category=$CATEGORY" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "date=$COMMIT_DATE" >> $GITHUB_OUTPUT

      - name: PROJECT.md ÌååÏùº ÏóÖÎç∞Ïù¥Ìä∏
        if: steps.commit.outputs.category != 'other'
        run: |
          CATEGORY="${{ steps.commit.outputs.category }}"
          TITLE="${{ steps.commit.outputs.title }}"
          DATE="${{ steps.commit.outputs.date }}"

          case "$CATEGORY" in
            feature) ICON="‚ú®" ;;
            fix) ICON="üêõ" ;;
            refactor) ICON="‚ôªÔ∏è" ;;
            deprecate) ICON="üóëÔ∏è" ;;
            improvement) ICON="‚ö°" ;;
            security) ICON="üîí" ;;
            performance) ICON="üöÄ" ;;
            deployment) ICON="üì¶" ;;
            infra) ICON="üèóÔ∏è" ;;
            docs) ICON="üìù" ;;
            *) ICON="üîπ" ;;
          esac

          if [ ! -f PROJECT.md ]; then
            echo "# CAPS Project History" > PROJECT.md
            echo "" >> PROJECT.md
            echo "## Î∞∞Ìè¨ Ïù¥Î†•" >> PROJECT.md
            echo "" >> PROJECT.md
          fi

          ENTRY="- **$DATE** $ICON [$CATEGORY] $TITLE"
          sed -i "/## Î∞∞Ìè¨ Ïù¥Î†•/a\
          $ENTRY" PROJECT.md

      - name: Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ïª§Î∞ã
        if: steps.commit.outputs.category != 'other'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add PROJECT.md
          git diff --staged --quiet || git commit -m "docs: Update PROJECT.md [skip ci]"

      - name: Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ìë∏Ïãú
        if: steps.commit.outputs.category != 'other'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
