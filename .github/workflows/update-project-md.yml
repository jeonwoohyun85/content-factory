name: í”„ë¡œì íŠ¸ ížˆìŠ¤í† ë¦¬ ìžë™ ì—…ë°ì´íŠ¸

on:
  push:
    branches:
      - main

jobs:
  update-project-md:
    runs-on: ubuntu-latest
    name: PROJECT.md ì—…ë°ì´íŠ¸ ìž‘ì—…
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ì»¤ë°‹ ì •ë³´ ì¶”ì¶œ
        id: commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_DATE=$(date -u +"%Y-%m-%d %H:%M")
          CATEGORY=$(echo "$COMMIT_MSG" | grep -oP '^[a-z]+(?=:)' || echo "other")
          TITLE=$(echo "$COMMIT_MSG" | sed 's/^[a-z]*: //' | head -1)

          echo "category=$CATEGORY" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "date=$COMMIT_DATE" >> $GITHUB_OUTPUT

      - name: PROJECT.md íŒŒì¼ ì—…ë°ì´íŠ¸
        if: steps.commit.outputs.category != 'other'
        run: |
          CATEGORY="${{ steps.commit.outputs.category }}"
          TITLE="${{ steps.commit.outputs.title }}"
          DATE="${{ steps.commit.outputs.date }}"

          case "$CATEGORY" in
            feature) ICON="âœ¨" ;;
            fix) ICON="ðŸ›" ;;
            refactor) ICON="â™»ï¸" ;;
            deprecate) ICON="ðŸ—‘ï¸" ;;
            improvement) ICON="âš¡" ;;
            security) ICON="ðŸ”’" ;;
            performance) ICON="ðŸš€" ;;
            deployment) ICON="ðŸ“¦" ;;
            infra) ICON="ðŸ—ï¸" ;;
            docs) ICON="ðŸ“" ;;
            *) ICON="ðŸ”¹" ;;
          esac

          if [ ! -f PROJECT.md ]; then
            echo "# CAPS Project History" > PROJECT.md
            echo "" >> PROJECT.md
            echo "## Development Log" >> PROJECT.md
            echo "" >> PROJECT.md
          fi

          ENTRY="- **$DATE** $ICON [$CATEGORY] $TITLE"
          sed -i "/## Development Log/a\\
          $ENTRY" PROJECT.md

      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        if: steps.commit.outputs.category != 'other'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add PROJECT.md
          git diff --staged --quiet || git commit -m "docs: Update PROJECT.md [skip ci]"

      - name: ë³€ê²½ì‚¬í•­ í‘¸ì‹œ
        if: steps.commit.outputs.category != 'other'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main