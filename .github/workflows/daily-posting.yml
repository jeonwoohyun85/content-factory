name: Daily Posting Cron

on:
  schedule:
    - cron: '0 15 * * *'  # 매일 15:00 UTC = 00:00 KST (다음날)
  workflow_dispatch:  # 수동 실행 가능

jobs:
  posting:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - subdomain: '00001'
            name: '상상피아노'
          - subdomain: '00002'
            name: '제이공방'
          - subdomain: '00003'
            name: '상상피아노 Japan'
          - subdomain: '00004'
            name: '제이공방 Thailand'
      max-parallel: 5  # 동시 최대 5개 실행
      fail-fast: false  # 하나 실패해도 나머지 계속 실행

    steps:
      - name: Post ${{ matrix.subdomain }} (${{ matrix.name }})
        run: |
          if ! curl -X POST "https://make-page.com/test-posting" \
            -H "Content-Type: application/json" \
            -d '{"subdomain":"${{ matrix.subdomain }}"}' \
            --max-time 200 \
            --fail-with-body; then
            # 실패 시 ntfy 알림
            curl -X POST "https://ntfy.sh/ContentFactory" \
              -H "Title: ❌ GitHub Actions 실패" \
              -H "Priority: high" \
              -H "Tags: warning" \
              -d "거래처: ${{ matrix.subdomain }} ${{ matrix.name }}
시간: $(date -u +"%Y-%m-%d %H:%M:%S") UTC
에러: GitHub Actions curl 실패 (타임아웃 또는 네트워크 오류)
단계: GitHub Actions Cron"
            exit 1
          fi
