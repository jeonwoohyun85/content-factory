name: Daily Posting Cron

on:
  schedule:
    - cron: '1 15 * * *'
  workflow_dispatch:

jobs:
  posting:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - subdomain: '00001'
            name: 'ìƒìƒí”¼ì•„ë…¸'
          - subdomain: '00002'
            name: 'ì œì´ê³µë°©'
          - subdomain: '00003'
            name: 'ìƒìƒí”¼ì•„ë…¸ Japan'
          - subdomain: '00004'
            name: 'ì œì´ê³µë°© Thailand'
      max-parallel: 5
      fail-fast: false

    steps:
      - name: Post ${{ matrix.subdomain }} (${{ matrix.name }})
        continue-on-error: true
        run: |
          curl -X POST "https://make-page.com/test-posting" \
            -H "Content-Type: application/json" \
            -d '{"subdomain":"${{ matrix.subdomain }}"}' \
            --max-time 200

          echo "Refreshing cache for ${{ matrix.subdomain }}"
          curl -s "https://make-page.com/refresh?subdomain=${{ matrix.subdomain }}"

  notify:
    needs: posting
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Send notification
        env:
          GH_TOKEN: ${{ github.token }}
          BOT: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          JOBS=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs)

          TIME=$(date -u +"%Y-%m-%d %H:%M KST" -d "+9 hours")

          R1=$(echo "$JOBS" | jq -r '.jobs[] | select(.name | contains("00001")) | .conclusion')
          R2=$(echo "$JOBS" | jq -r '.jobs[] | select(.name | contains("00002")) | .conclusion')
          R3=$(echo "$JOBS" | jq -r '.jobs[] | select(.name | contains("00003")) | .conclusion')
          R4=$(echo "$JOBS" | jq -r '.jobs[] | select(.name | contains("00004")) | .conclusion')

          MSG="ì¼ì‹œ: ${TIME}%0A%0A"

          [ "$R1" = "success" ] && MSG="${MSG}âœ… 00001 (ìƒìƒí”¼ì•„ë…¸)%0A" || MSG="${MSG}ğŸ”´ 00001 (ìƒìƒí”¼ì•„ë…¸)%0A"
          [ "$R2" = "success" ] && MSG="${MSG}âœ… 00002 (ì œì´ê³µë°©)%0A" || MSG="${MSG}ğŸ”´ 00002 (ì œì´ê³µë°©)%0A"
          [ "$R3" = "success" ] && MSG="${MSG}âœ… 00003 (ìƒìƒí”¼ì•„ë…¸ Japan)%0A" || MSG="${MSG}ğŸ”´ 00003 (ìƒìƒí”¼ì•„ë…¸ Japan)%0A"
          [ "$R4" = "success" ] && MSG="${MSG}âœ… 00004 (ì œì´ê³µë°© Thailand)" || MSG="${MSG}ğŸ”´ 00004 (ì œì´ê³µë°© Thailand)"

          curl -X POST "https://api.telegram.org/bot${BOT}/sendMessage?chat_id=${CHAT}&text=${MSG}"
