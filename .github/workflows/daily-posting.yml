name: Daily Posting Cron

on:
  schedule:
    - cron: '1 15 * * *'  # ë§¤ì¼ 15:01 UTC = 00:01 KST (ë‹¤ìŒë‚ )
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  # ì‹¤ì œ í¬ë¡  í¬ìŠ¤íŒ… job
  posting:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - subdomain: '00001'
            name: 'ìƒìƒí”¼ì•„ë…¸'
          - subdomain: '00002'
            name: 'ì œì´ê³µë°©'
          - subdomain: '00003'
            name: 'ìƒìƒí”¼ì•„ë…¸ Japan'
          - subdomain: '00004'
            name: 'ì œì´ê³µë°© Thailand'
      max-parallel: 5  # ë™ì‹œ ìµœëŒ€ 5ê°œ ì‹¤í–‰
      fail-fast: false  # í•˜ë‚˜ ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ ê³„ì† ì‹¤í–‰

    steps:
      - name: Post ${{ matrix.subdomain }} (${{ matrix.name }})
        continue-on-error: true
        run: |
          RESPONSE=$(curl -X POST "https://make-page.com/test-posting" \
            -H "Content-Type: application/json" \
            -d '{"subdomain":"${{ matrix.subdomain }}"}' \
            --max-time 200 -w "\n%{http_code}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          if [ "$HTTP_CODE" != "200" ]; then
            echo "Error: HTTP $HTTP_CODE"
            exit 1
          fi

          SUCCESS=$(echo "$BODY" | jq -r '.success // false')
          if [ "$SUCCESS" != "true" ]; then
            echo "Error: Posting failed"
            exit 1
          fi

          # í¬ìŠ¤íŒ… ì„±ê³µ ì‹œ ì¦‰ì‹œ ìºì‹œ ì´ˆê¸°í™”
          echo "Refreshing cache for ${{ matrix.subdomain }}"
          curl -s "https://make-page.com/refresh?subdomain=${{ matrix.subdomain }}"

  # ì „ì²´ ê²°ê³¼ ìš”ì•½ ì•Œë¦¼
  notify-summary:
    needs: posting
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Send summary notification
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          export PYTHONIOENCODING=utf-8

          # í˜„ì¬ runì˜ ëª¨ë“  jobs ì¡°íšŒ
          gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs > /tmp/jobs.json

          python3 << 'EOF'
          import requests
          import json
          from datetime import datetime, timedelta

          bot_token = '8328468112:AAHcfkNgMXPR4hbc4b5g0G3K_oFnQurryqs'
          chat_id = '6857038085'

          # GitHub API ê²°ê³¼ íŒŒì‹±
          with open('/tmp/jobs.json', 'r') as f:
              jobs_data = json.load(f)

          # KST ì‹œê°„
          kst_now = datetime.utcnow() + timedelta(hours=9)
          timestamp = kst_now.strftime('%Y-%m-%d %H:%M KST')

          # posting jobë“¤ë§Œ í•„í„°ë§
          results = []
          failed_count = 0

          for job in jobs_data.get('jobs', []):
              job_name = job.get('name', '')
              if job_name.startswith('Post '):
                  conclusion = job.get('conclusion', 'unknown')
                  # "Post 00001 (ìƒìƒí”¼ì•„ë…¸)" í˜•ì‹ íŒŒì‹±
                  parts = job_name.replace('Post ', '').split(' (')
                  subdomain = parts[0]
                  name = parts[1].rstrip(')') if len(parts) > 1 else ''

                  if conclusion == 'success':
                      results.append(f"âœ… {subdomain} ({name})")
                  else:
                      results.append(f"ğŸ”´ {subdomain} ({name})")
                      failed_count += 1

          # ë©”ì‹œì§€ ìƒì„±
          if failed_count == 0:
              header = "âœ… ì¼ì¼ í¬ìŠ¤íŒ… ì™„ë£Œ"
          else:
              header = f"âš ï¸ ì¼ì¼ í¬ìŠ¤íŒ… ì™„ë£Œ (ì‹¤íŒ¨: {failed_count}ê°œ)"

          message = f'''{header}

ì¼ì‹œ: {timestamp}

ê²°ê³¼:
{chr(10).join(results)}'''

          if failed_count > 0:
              message += "\n\nâš ï¸ í™•ì¸ í•„ìš”"

          # í…”ë ˆê·¸ë¨ ì „ì†¡
          url = f'https://api.telegram.org/bot{bot_token}/sendMessage'
          requests.post(url, json={'chat_id': chat_id, 'text': message})
          EOF
