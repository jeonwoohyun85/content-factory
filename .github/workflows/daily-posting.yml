name: Daily Posting Cron

on:
  push:
  schedule:
    - cron: '1 15 * * *'  # ë§¤ì¼ 15:01 UTC = 00:01 KST (ë‹¤ìŒë‚ )
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  # push ì´ë²¤íŠ¸ ì‹œ ë¹ˆ job ì‹¤í–‰ (ì„±ê³µ í‘œì‹œìš©)
  check:
    if: ${{ github.event_name == 'push' }}
    runs-on: ubuntu-latest
    steps:
      - name: Push event check
        run: echo "Push event - workflow skipped (cron only)"

  # ì‹¤ì œ í¬ë¡  í¬ìŠ¤íŒ… job
  posting:
    if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - subdomain: '00001'
            name: 'ìƒìƒí”¼ì•„ë…¸'
          - subdomain: '00002'
            name: 'ì œì´ê³µë°©'
          - subdomain: '00003'
            name: 'ìƒìƒí”¼ì•„ë…¸ Japan'
          - subdomain: '00004'
            name: 'ì œì´ê³µë°© Thailand'
      max-parallel: 5  # ë™ì‹œ ìµœëŒ€ 5ê°œ ì‹¤í–‰
      fail-fast: false  # í•˜ë‚˜ ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ ê³„ì† ì‹¤í–‰

    steps:
      - name: Post ${{ matrix.subdomain }} (${{ matrix.name }})
        id: posting
        continue-on-error: true
        run: |
          RESPONSE=$(curl -X POST "https://make-page.com/test-posting" \
            -H "Content-Type: application/json" \
            -d '{"subdomain":"${{ matrix.subdomain }}"}' \
            --max-time 200 -w "\n%{http_code}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          if [ "$HTTP_CODE" != "200" ]; then
            echo "Error: HTTP $HTTP_CODE"
            exit 1
          fi

          SUCCESS=$(echo "$BODY" | jq -r '.success // false')
          if [ "$SUCCESS" != "true" ]; then
            echo "Error: Posting failed"
            exit 1
          fi

          # í¬ìŠ¤íŒ… ì„±ê³µ ì‹œ ì¦‰ì‹œ ìºì‹œ ì´ˆê¸°í™”
          echo "Refreshing cache for ${{ matrix.subdomain }}"
          curl -s "https://make-page.com/refresh?subdomain=${{ matrix.subdomain }}"

      - name: Notify failure
        if: failure()
        run: |
          export PYTHONIOENCODING=utf-8
          python3 << 'EOF'
          import requests
          import os
          from datetime import datetime, timedelta

          bot_token = '8328468112:AAHcfkNgMXPR4hbc4b5g0G3K_oFnQurryqs'
          chat_id = '6857038085'

          subdomain = '${{ matrix.subdomain }}'
          name = '${{ matrix.name }}'

          # KST ì‹œê°„
          kst_now = datetime.utcnow() + timedelta(hours=9)
          timestamp = kst_now.strftime('%Y-%m-%d %H:%M KST')

          message = f'''ğŸ”´ í¬ìŠ¤íŒ… ì‹¤íŒ¨

ì¼ì‹œ: {timestamp}

ê±°ë˜ì²˜: {subdomain} ({name})

í™•ì¸ í•„ìš”'''

          url = f'https://api.telegram.org/bot{bot_token}/sendMessage'
          requests.post(url, json={'chat_id': chat_id, 'text': message})
          EOF
