name: Daily Posting Cron

on:
  schedule:
    - cron: '1 15 * * *'
  workflow_dispatch:

jobs:
  posting:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - subdomain: '00001'
            name: 'ìƒìƒí”¼ì•„ë…¸'
          - subdomain: '00002'
            name: 'ì œì´ê³µë°©'
          - subdomain: '00003'
            name: 'ìƒìƒí”¼ì•„ë…¸ Japan'
          - subdomain: '00004'
            name: 'ì œì´ê³µë°© Thailand'
      max-parallel: 5
      fail-fast: false

    steps:
      - name: Post ${{ matrix.subdomain }} (${{ matrix.name }})
        continue-on-error: true
        run: |
          curl -X POST "https://make-page.com/test-posting" \
            -H "Content-Type: application/json" \
            -d '{"subdomain":"${{ matrix.subdomain }}"}' \
            --max-time 200

          echo "Refreshing cache for ${{ matrix.subdomain }}"
          curl -s "https://make-page.com/refresh?subdomain=${{ matrix.subdomain }}"

  notify:
    needs: posting
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Send notification
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          JOBS=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs)

          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M" -d "+9 hours")

          HEADER="âœ… ì¼ì¼ í¬ìŠ¤íŒ… ì™„ë£Œ"
          RESULTS=""

          echo "$JOBS" | jq -r '.jobs[] | select(.name | startswith("Post ")) | "\(.conclusion)|\(.name)"' | while IFS='|' read STATUS NAME; do
            SUB=$(echo "$NAME" | sed 's/Post \([0-9]*\) .*/\1/')
            CLIENT=$(echo "$NAME" | sed 's/Post [0-9]* (\(.*\))/\1/')

            if [ "$STATUS" = "success" ]; then
              RESULTS="${RESULTS}âœ… ${SUB} (${CLIENT})\n"
            else
              RESULTS="${RESULTS}ğŸ”´ ${SUB} (${CLIENT})\n"
              HEADER="âš ï¸ ì¼ì¼ í¬ìŠ¤íŒ… ì™„ë£Œ (ì¼ë¶€ ì‹¤íŒ¨)"
            fi
          done

          MESSAGE="${HEADER}\n\nì¼ì‹œ: ${TIMESTAMP} KST\n\nê²°ê³¼:\n${RESULTS}"

          curl -X POST "https://api.telegram.org/bot8328468112:AAHcfkNgMXPR4hbc4b5g0G3K_oFnQurryqs/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\":\"6857038085\",\"text\":\"${MESSAGE}\"}"
