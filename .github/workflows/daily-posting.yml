name: Daily Posting Cron

on:
  push:
  schedule:
    - cron: '1 15 * * *'  # 매일 15:01 UTC = 00:01 KST (다음날)
  workflow_dispatch:  # 수동 실행 가능

jobs:
  # push 이벤트 시 빈 job 실행 (성공 표시용)
  check:
    if: ${{ github.event_name == 'push' }}
    runs-on: ubuntu-latest
    steps:
      - name: Push event check
        run: echo "Push event - workflow skipped (cron only)"

  # 실제 크론 포스팅 job
  posting:
    if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - subdomain: '00001'
            name: '상상피아노'
          - subdomain: '00002'
            name: '제이공방'
          - subdomain: '00003'
            name: '상상피아노 Japan'
          - subdomain: '00004'
            name: '제이공방 Thailand'
      max-parallel: 5  # 동시 최대 5개 실행
      fail-fast: false  # 하나 실패해도 나머지 계속 실행

    steps:
      - name: Post ${{ matrix.subdomain }} (${{ matrix.name }})
        run: |
          curl -X POST "https://make-page.com/test-posting" \
            -H "Content-Type: application/json" \
            -d '{"subdomain":"${{ matrix.subdomain }}"}' \
            --max-time 200

          # 포스팅 성공 시 즉시 캐시 초기화
          echo "Refreshing cache for ${{ matrix.subdomain }}"
          curl -s "https://make-page.com/refresh?subdomain=${{ matrix.subdomain }}"
