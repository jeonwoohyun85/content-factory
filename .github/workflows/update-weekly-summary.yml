name: ì£¼ê°„ ìš”ì•½ ìë™ ì—…ë°ì´íŠ¸

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ 00:00 KST (ì¼ìš”ì¼ 15:00 UTC)
    - cron: '0 15 * * 0'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  update-weekly:
    runs-on: ubuntu-latest
    name: ì£¼ê°„ ìš”ì•½ ë° ì•„í‚¤í…ì²˜ ìë™ ì—…ë°ì´íŠ¸
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ì „ì²´ ë°°í¬ ì´ë ¥ ì¡°íšŒ
        run: |
          gh run list \
            --repo jeonwoohyun85/content-factory \
            --status success \
            --workflow "deploy-workers.yml" \
            --limit 10000 \
            --json displayTitle,createdAt,headSha,conclusion \
            > all-runs.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ì£¼ê°„ ìš”ì•½ ë° ì•„í‚¤í…ì²˜ ì„¹ì…˜ ìƒì„±
        run: |
          cat > update_all.py << 'SCRIPT_EOF'
          import json
          import sys
          from datetime import datetime, timedelta
          from collections import defaultdict

          # ë°°í¬ ë°ì´í„° ë¡œë“œ
          with open('all-runs.json', 'r', encoding='utf-8') as f:
              runs = json.load(f)

          # workflow_dispatch ì œì™¸
          runs = [r for r in runs if r['displayTitle'] != 'í´ë¼ìš°ë“œí”Œë ˆì–´ ì›Œì»¤ ìë™ ë°°í¬']

          # ========== 1. ì£¼ê°„ ìš”ì•½ ìƒì„± ==========
          deployments_by_date = defaultdict(list)

          for run in runs:
              timestamp = run['createdAt']
              title = run['displayTitle'].strip()

              utc_dt = datetime.fromisoformat(timestamp.replace('Z', '+00:00'))
              kst_dt = utc_dt + timedelta(hours=9)
              date_str = kst_dt.strftime('%Y-%m-%d')

              if ':' in title:
                  category = title.split(':')[0].strip()
                  text = title.split(':', 1)[1].strip()
              else:
                  category = 'other'
                  text = title

              deployments_by_date[date_str].append({
                  'category': category,
                  'title': text
              })

          # ì£¼ì°¨ë³„ ê·¸ë£¹í™”
          weekly_summary = defaultdict(lambda: defaultdict(list))

          for date_str, items in deployments_by_date.items():
              date_obj = datetime.strptime(date_str, '%Y-%m-%d')
              weekday = date_obj.weekday()
              monday = date_obj - timedelta(days=weekday)
              week_key = monday.strftime('%Y-%m-%d')

              weekday_names = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼']
              weekday_name = weekday_names[weekday]

              summary_items = []
              features = [item for item in items if item['category'] in ['feature', 'feat']]
              fixes = [item for item in items if item['category'] in ['fix', 'bugfix']]
              improvements = [item for item in items if item['category'] in ['improvement', 'performance']]

              if features:
                  for f in features[:2]:
                      summary_items.append(f['title'][:50])
              if fixes and len(summary_items) < 2:
                  for f in fixes[:1]:
                      summary_items.append(f['title'][:50])
              if improvements and len(summary_items) < 2:
                  for i in improvements[:1]:
                      summary_items.append(i['title'][:50])

              summary = ', '.join(summary_items) if summary_items else 'ìœ ì§€ë³´ìˆ˜'

              weekly_summary[week_key][date_str] = {
                  'weekday': weekday_name,
                  'summary': summary,
                  'count': len(items)
              }

          # ì£¼ì°¨ë³„ í° íë¦„ íŒŒì•…
          week_flows = {}
          for week_key in sorted(weekly_summary.keys()):
              dates = weekly_summary[week_key]
              all_titles = []
              for date_str, info in dates.items():
                  for item in deployments_by_date[date_str]:
                      all_titles.append(item['title'])

              if any('Google Sheets' in t or 'Supabase' in t for t in all_titles):
                  flow = "ì‹œìŠ¤í…œ êµ¬ì¶• â†’ ì¸í”„ë¼ ì „í™˜"
              elif any('Umami' in t for t in all_titles):
                  if any('ì œê±°' in t or 'íê¸°' in t for t in all_titles):
                      flow = "í†µê³„ ìë™í™” ì‹œë„ â†’ íê¸° â†’ ìˆ˜ë™ ì „í™˜"
                  else:
                      flow = "í†µê³„ ê¸°ëŠ¥ ì‹¤í—˜"
              elif any('Queue' in t or 'ë³‘ë ¬' in t for t in all_titles):
                  flow = "ì„±ëŠ¥ ìµœì í™” ë° ì•ˆì •í™”"
              elif any('ì¤‘ë³µ' in t or 'ì •í•©ì„±' in t for t in all_titles):
                  flow = "ë°ì´í„° ì•ˆì •í™”"
              else:
                  flow = "ê¸°ëŠ¥ ê°œë°œ ë° ê°œì„ "

              week_flows[week_key] = flow

          # ì£¼ê°„ ìš”ì•½ ì¶œë ¥
          weekly_output = []
          weekly_output.append("### ğŸ“… ì£¼ê°„ ìš”ì•½\n")

          week_num = 1
          for week_key in sorted(weekly_summary.keys()):
              dates = weekly_summary[week_key]
              monday = datetime.strptime(week_key, '%Y-%m-%d')
              sunday = monday + timedelta(days=6)

              weekly_output.append(f"#### {week_num}ì£¼ì°¨ ({monday.strftime('%m/%d')}-{sunday.strftime('%m/%d')})")
              weekly_output.append(f"**ì£¼ìš” íë¦„**: {week_flows[week_key]}\n")

              for date_str in sorted(dates.keys()):
                  info = dates[date_str]
                  date_obj = datetime.strptime(date_str, '%Y-%m-%d')
                  weekly_output.append(f"- **{info['weekday']} {date_obj.strftime('%m/%d')}**: {info['summary']} ({info['count']}ê±´)")

              weekly_output.append("")
              week_num += 1

          # íŒŒì¼ ì €ì¥
          with open('weekly-summary.txt', 'w', encoding='utf-8') as f:
              f.write('\n'.join(weekly_output))

          print(f"ì£¼ê°„ ìš”ì•½ ìƒì„± ì™„ë£Œ: {week_num - 1}ì£¼ì°¨")

          # ========== 2. ì´ì „ ì£¼ ì‹ ê·œ í•­ëª© ê°ì§€ ==========
          # ê°€ì¥ ìµœê·¼ ì›”ìš”ì¼ ì°¾ê¸°
          now_kst = datetime.now() + timedelta(hours=9)
          days_since_monday = now_kst.weekday()
          last_monday = now_kst - timedelta(days=days_since_monday)

          # ì´ì „ ì£¼ ë²”ìœ„ (ì§€ë‚œì£¼ ì›”~ì¼)
          prev_monday = last_monday - timedelta(days=7)
          prev_sunday = prev_monday + timedelta(days=6)

          # ì´ì „ ì£¼ ë°°í¬ë§Œ í•„í„°ë§
          prev_week_deployments = []
          for date_str, items in deployments_by_date.items():
              date_obj = datetime.strptime(date_str, '%Y-%m-%d')
              if prev_monday.date() <= date_obj.date() <= prev_sunday.date():
                  prev_week_deployments.extend(items)

          # ì‹ ê·œ í•­ëª© ê°ì§€
          new_arch = []
          new_deprecated = []
          new_stack = []

          all_titles = [d['title'] for d in prev_week_deployments]

          # ì•„í‚¤í…ì²˜ ê²°ì • ê°ì§€
          if any('Queue' in t or 'ë³‘ë ¬' in t for t in all_titles):
              new_arch.append("- Queue í™•ì¥ ë˜ëŠ” ìµœì í™”")
          if any('Sheets' in t or 'DB' in t for t in all_titles):
              new_arch.append("- ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡° ê°œì„ ")

          # íê¸° ê°ì§€
          if any('íê¸°' in t or 'ì œê±°' in t or 'Revert' in t for t in all_titles):
              for item in prev_week_deployments:
                  if any(kw in item['title'] for kw in ['íê¸°', 'ì œê±°', 'Revert', 'ì‚­ì œ']):
                      new_deprecated.append(f"- {item['title'][:60]} ({prev_monday.strftime('%m/%d')})")
                      break

          # ì‹ ê·œ í•­ëª© ì¶œë ¥
          with open('new-items.txt', 'w', encoding='utf-8') as f:
              if new_arch:
                  f.write("ARCH_NEW:\n")
                  f.write('\n'.join(new_arch) + '\n')
              if new_deprecated:
                  f.write("DEPRECATED_NEW:\n")
                  f.write('\n'.join(new_deprecated) + '\n')

          print("ì‹ ê·œ í•­ëª© ê°ì§€ ì™„ë£Œ")
          SCRIPT_EOF

          python3 update_all.py

      - name: PROJECT.md ì—…ë°ì´íŠ¸
        run: |
          python3 << 'UPDATE_EOF'
          with open('PROJECT.md', 'r', encoding='utf-8') as f:
              content = f.read()

          # ì‹ ê·œ í•­ëª© ì½ê¸°
          new_items = {}
          try:
              with open('new-items.txt', 'r', encoding='utf-8') as f:
                  lines = f.read().strip().split('\n')
                  current_section = None
                  for line in lines:
                      if line.startswith('ARCH_NEW:'):
                          current_section = 'arch'
                          new_items['arch'] = []
                      elif line.startswith('DEPRECATED_NEW:'):
                          current_section = 'deprecated'
                          new_items['deprecated'] = []
                      elif line.strip() and current_section:
                          new_items[current_section].append(line)
          except:
              new_items = {}

          # PROJECT.md íŒŒì‹±
          parts = content.split('## ë°°í¬ ì´ë ¥')
          before = parts[0]
          deploy_section = parts[1]

          # ë§ˆì¼ìŠ¤í†¤ ì¶”ì¶œ
          if '### ğŸ¯ ì£¼ìš” ë§ˆì¼ìŠ¤í†¤' in deploy_section:
              milestone_parts = deploy_section.split('### ğŸ¯ ì£¼ìš” ë§ˆì¼ìŠ¤í†¤')
              milestones = '### ğŸ¯ ì£¼ìš” ë§ˆì¼ìŠ¤í†¤' + milestone_parts[1].split('---')[0] + '---'
              after_milestone = '---' + milestone_parts[1].split('---', 1)[1] if '---' in milestone_parts[1] else ''
          else:
              milestones = ''
              after_milestone = deploy_section

          # ì•„í‚¤í…ì²˜ ì„¹ì…˜ ì¶”ì¶œ ë° ì—…ë°ì´íŠ¸
          if '### ğŸ’¡ ì£¼ìš” ì•„í‚¤í…ì²˜ ê²°ì •' in after_milestone:
              arch_parts = after_milestone.split('### ğŸ’¡ ì£¼ìš” ì•„í‚¤í…ì²˜ ê²°ì •')
              arch_header = '### ğŸ’¡ ì£¼ìš” ì•„í‚¤í…ì²˜ ê²°ì •\n'

              # ê¸°ì¡´ ë‚´ìš©
              arch_content_parts = arch_parts[1].split('---', 1)
              arch_content = arch_content_parts[0]

              # ì‹ ê·œ í•­ëª© ì¶”ê°€
              if 'arch' in new_items and new_items['arch']:
                  arch_content += '\n' + '\n'.join(new_items['arch']) + '\n'

              after_arch = '---' + arch_content_parts[1] if len(arch_content_parts) > 1 else ''
          else:
              arch_header = ''
              arch_content = ''
              after_arch = after_milestone

          # íê¸° ì„¹ì…˜ ì¶”ì¶œ ë° ì—…ë°ì´íŠ¸
          if '### ğŸ—‘ï¸ íê¸°ëœ ì‹œë„ë“¤' in after_arch:
              dep_parts = after_arch.split('### ğŸ—‘ï¸ íê¸°ëœ ì‹œë„ë“¤')
              dep_header = '### ğŸ—‘ï¸ íê¸°ëœ ì‹œë„ë“¤\n'

              dep_content_parts = dep_parts[1].split('---', 1)
              dep_content = dep_content_parts[0]

              # ì‹ ê·œ í•­ëª© ì¶”ê°€
              if 'deprecated' in new_items and new_items['deprecated']:
                  dep_content += '\n' + '\n'.join(new_items['deprecated']) + '\n'

              after_dep = '---' + dep_content_parts[1] if len(dep_content_parts) > 1 else ''
          else:
              dep_header = ''
              dep_content = ''
              after_dep = after_arch

          # ì£¼ê°„ ìš”ì•½
          if '### ğŸ“… ì£¼ê°„ ìš”ì•½' in after_dep:
              weekly_parts = after_dep.split('### ğŸ“… ì£¼ê°„ ìš”ì•½')
              weekly_header = '### ğŸ“… ì£¼ê°„ ìš”ì•½'

              # ìƒˆ ì£¼ê°„ ìš”ì•½ìœ¼ë¡œ êµì²´
              with open('weekly-summary.txt', 'r', encoding='utf-8') as f:
                  new_weekly = f.read().strip()

              # ì£¼ê°„ ìš”ì•½ ì´í›„ ë¶€ë¶„ (ìƒì„¸ íƒ€ì„ë¼ì¸)
              if '---' in weekly_parts[1]:
                  timeline = '---' + weekly_parts[1].split('---', 1)[1]
              else:
                  timeline = ''
          else:
              weekly_header = ''
              new_weekly = ''
              timeline = after_dep

          # ì¬ì¡°ë¦½
          with open('PROJECT.md', 'w', encoding='utf-8') as f:
              f.write(before.rstrip())
              f.write('\n\n## ë°°í¬ ì´ë ¥\n\n')

              if milestones:
                  f.write(milestones)
                  f.write('\n\n')

              if arch_header:
                  f.write(arch_header)
                  f.write(arch_content)
                  f.write('\n---\n\n')

              if dep_header:
                  f.write(dep_header)
                  f.write(dep_content)
                  f.write('\n---\n\n')

              # ê¸°ìˆ  ìŠ¤íƒ (ê¸°ì¡´ ìœ ì§€)
              if '### ğŸ”§ ê¸°ìˆ  ìŠ¤íƒ ì§„í™”' in content:
                  stack_start = content.find('### ğŸ”§ ê¸°ìˆ  ìŠ¤íƒ ì§„í™”')
                  stack_end = content.find('---', stack_start + 1)
                  if stack_end > stack_start:
                      f.write(content[stack_start:stack_end])
                      f.write('---\n\n')

              if new_weekly:
                  f.write(new_weekly)
                  f.write('\n\n---\n\n')

              f.write(timeline.strip())

          print('PROJECT.md ì—…ë°ì´íŠ¸ ì™„ë£Œ')
          UPDATE_EOF

      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add PROJECT.md
          git diff --staged --quiet || git commit -m "docs: ì£¼ê°„ ìš”ì•½ ë° ì•„í‚¤í…ì²˜ ìë™ ì—…ë°ì´íŠ¸ [skip ci]"

      - name: ë³€ê²½ì‚¬í•­ í‘¸ì‹œ
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
