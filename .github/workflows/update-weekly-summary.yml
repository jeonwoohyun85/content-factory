name: ì£¼ê°„ ìš”ì•½ ìë™ ì—…ë°ì´íŠ¸

on:
  schedule:
    # ë§¤ì£¼ ì¼ìš”ì¼ 23:00 KST (14:00 UTC)
    - cron: '0 14 * * 0'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  update-weekly:
    runs-on: ubuntu-latest
    name: ì£¼ê°„ ìš”ì•½ ì¬ìƒì„±
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ì „ì²´ ë°°í¬ ì´ë ¥ ì¡°íšŒ
        run: |
          gh run list \
            --repo jeonwoohyun85/content-factory \
            --status success \
            --workflow "deploy-workers.yml" \
            --limit 10000 \
            --json displayTitle,createdAt,headSha,conclusion \
            > all-runs.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ì£¼ê°„ ìš”ì•½ ìƒì„±
        run: |
          cat > generate_weekly.py << 'SCRIPT_EOF'
          import json
          import sys
          from datetime import datetime, timedelta
          from collections import defaultdict

          # ë°°í¬ ë°ì´í„° ë¡œë“œ
          with open('all-runs.json', 'r', encoding='utf-8') as f:
              runs = json.load(f)

          # workflow_dispatch ì œì™¸
          runs = [r for r in runs if r['displayTitle'] != 'í´ë¼ìš°ë“œí”Œë ˆì–´ ì›Œì»¤ ìë™ ë°°í¬']

          # ë‚ ì§œë³„ ë°°í¬ ê·¸ë£¹í™”
          deployments_by_date = defaultdict(list)

          for run in runs:
              timestamp = run['createdAt']
              title = run['displayTitle'].strip()

              # UTC to KST
              utc_dt = datetime.fromisoformat(timestamp.replace('Z', '+00:00'))
              kst_dt = utc_dt + timedelta(hours=9)

              date_str = kst_dt.strftime('%Y-%m-%d')

              # ì¹´í…Œê³ ë¦¬ ì¶”ì¶œ
              if ':' in title:
                  category = title.split(':')[0].strip()
                  text = title.split(':', 1)[1].strip()
              else:
                  category = 'other'
                  text = title

              deployments_by_date[date_str].append({
                  'category': category,
                  'title': text
              })

          # ì£¼ì°¨ë³„ ê·¸ë£¹í™” (ì›”ìš”ì¼ ì‹œì‘)
          weekly_summary = defaultdict(lambda: defaultdict(list))

          for date_str, items in deployments_by_date.items():
              date_obj = datetime.strptime(date_str, '%Y-%m-%d')

              # í•´ë‹¹ ì£¼ì˜ ì›”ìš”ì¼ ì°¾ê¸°
              weekday = date_obj.weekday()
              monday = date_obj - timedelta(days=weekday)
              week_key = monday.strftime('%Y-%m-%d')

              # ìš”ì¼ ì´ë¦„
              weekday_names = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼']
              weekday_name = weekday_names[weekday]

              # í•´ë‹¹ ë‚ ì§œì˜ ì£¼ìš” ì‘ì—… ìš”ì•½
              summary_items = []

              features = [item for item in items if item['category'] in ['feature', 'feat']]
              fixes = [item for item in items if item['category'] in ['fix', 'bugfix']]
              improvements = [item for item in items if item['category'] in ['improvement', 'performance']]

              if features:
                  for f in features[:2]:
                      summary_items.append(f['title'][:50])
              if fixes and len(summary_items) < 2:
                  for f in fixes[:1]:
                      summary_items.append(f['title'][:50])
              if improvements and len(summary_items) < 2:
                  for i in improvements[:1]:
                      summary_items.append(i['title'][:50])

              summary = ', '.join(summary_items) if summary_items else 'ìœ ì§€ë³´ìˆ˜'

              weekly_summary[week_key][date_str] = {
                  'weekday': weekday_name,
                  'summary': summary,
                  'count': len(items)
              }

          # ì£¼ì°¨ë³„ í° íë¦„ íŒŒì•…
          week_flows = {}
          for week_key in sorted(weekly_summary.keys()):
              dates = weekly_summary[week_key]

              all_titles = []
              for date_str, info in dates.items():
                  for item in deployments_by_date[date_str]:
                      all_titles.append(item['title'])

              if any('Google Sheets' in t or 'Supabase' in t for t in all_titles):
                  flow = "ì‹œìŠ¤í…œ êµ¬ì¶• â†’ ì¸í”„ë¼ ì „í™˜"
              elif any('Umami' in t for t in all_titles):
                  if any('ì œê±°' in t or 'íê¸°' in t for t in all_titles):
                      flow = "í†µê³„ ìë™í™” ì‹œë„ â†’ íê¸° â†’ ìˆ˜ë™ ì „í™˜"
                  else:
                      flow = "í†µê³„ ê¸°ëŠ¥ ì‹¤í—˜"
              elif any('Queue' in t or 'ë³‘ë ¬' in t for t in all_titles):
                  flow = "ì„±ëŠ¥ ìµœì í™” ë° ì•ˆì •í™”"
              elif any('ì¤‘ë³µ' in t or 'ì •í•©ì„±' in t for t in all_titles):
                  flow = "ë°ì´í„° ì•ˆì •í™”"
              else:
                  flow = "ê¸°ëŠ¥ ê°œë°œ ë° ê°œì„ "

              week_flows[week_key] = flow

          # ì¶œë ¥ ìƒì„±
          output = []
          output.append("### ğŸ“… ì£¼ê°„ ìš”ì•½\n")

          week_num = 1
          for week_key in sorted(weekly_summary.keys()):
              dates = weekly_summary[week_key]

              monday = datetime.strptime(week_key, '%Y-%m-%d')
              sunday = monday + timedelta(days=6)

              output.append(f"#### {week_num}ì£¼ì°¨ ({monday.strftime('%m/%d')}-{sunday.strftime('%m/%d')})")
              output.append(f"**ì£¼ìš” íë¦„**: {week_flows[week_key]}\n")

              for date_str in sorted(dates.keys()):
                  info = dates[date_str]
                  date_obj = datetime.strptime(date_str, '%Y-%m-%d')
                  output.append(f"- **{info['weekday']} {date_obj.strftime('%m/%d')}**: {info['summary']} ({info['count']}ê±´)")

              output.append("")
              week_num += 1

          # íŒŒì¼ ì €ì¥
          with open('weekly-summary-new.txt', 'w', encoding='utf-8') as f:
              f.write('\n'.join(output))

          print(f"ì£¼ê°„ ìš”ì•½ ìƒì„± ì™„ë£Œ: {week_num - 1}ì£¼ì°¨")
          SCRIPT_EOF

          python3 generate_weekly.py

      - name: PROJECT.md ì—…ë°ì´íŠ¸
        run: |
          python3 << 'UPDATE_EOF'
          with open('PROJECT.md', 'r', encoding='utf-8') as f:
              content = f.read()

          # '## ë°°í¬ ì´ë ¥' ìœ„ì¹˜ ì°¾ê¸°
          parts = content.split('## ë°°í¬ ì´ë ¥')
          before = parts[0]
          deploy_section = parts[1]

          # ë§ˆì¼ìŠ¤í†¤ ì¶”ì¶œ
          if '### ğŸ¯ ì£¼ìš” ë§ˆì¼ìŠ¤í†¤' in deploy_section:
              milestone_parts = deploy_section.split('### ğŸ¯ ì£¼ìš” ë§ˆì¼ìŠ¤í†¤')
              milestones = '### ğŸ¯ ì£¼ìš” ë§ˆì¼ìŠ¤í†¤' + milestone_parts[1].split('---')[0] + '---'

              if '### ğŸ“‹ ìƒì„¸ íƒ€ì„ë¼ì¸' in milestone_parts[1]:
                  timeline_start = milestone_parts[1].find('### ğŸ“‹ ìƒì„¸ íƒ€ì„ë¼ì¸')
                  timeline = milestone_parts[1][timeline_start:]
              else:
                  timeline = ''
          else:
              milestones = ''
              timeline = deploy_section

          # '## ë‹¤ìŒ ì‘ì—…' ì°¾ê¸°
          if '## ë‹¤ìŒ ì‘ì—…' in timeline:
              timeline_parts = timeline.split('## ë‹¤ìŒ ì‘ì—…')
              timeline = timeline_parts[0].rstrip()
              after = '## ë‹¤ìŒ ì‘ì—…' + timeline_parts[1]
          else:
              after = ''

          # ìƒˆ ì£¼ê°„ ìš”ì•½ ì½ê¸°
          with open('weekly-summary-new.txt', 'r', encoding='utf-8') as f:
              weekly = f.read().strip()

          # í•©ì¹˜ê¸°
          with open('PROJECT.md', 'w', encoding='utf-8') as f:
              f.write(before.rstrip())
              f.write('\n\n## ë°°í¬ ì´ë ¥\n\n')
              f.write(milestones)
              f.write('\n\n')
              f.write(weekly)
              f.write('\n\n---\n\n')
              f.write(timeline.strip())
              f.write('\n\n---\n\n')
              f.write(after)

          print('PROJECT.md ì—…ë°ì´íŠ¸ ì™„ë£Œ')
          UPDATE_EOF

      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add PROJECT.md
          git diff --staged --quiet || git commit -m "docs: ì£¼ê°„ ìš”ì•½ ìë™ ì—…ë°ì´íŠ¸ [skip ci]"

      - name: ë³€ê²½ì‚¬í•­ í‘¸ì‹œ
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
