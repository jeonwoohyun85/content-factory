name: ì›”ë³„ ìš”ì•½ ìë™ ì—…ë°ì´íŠ¸

on:
  schedule:
    # ë§¤ì›” 1ì¼ 09:00 KST (1ì¼ 00:00 UTC)
    - cron: '0 0 1 * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  update-monthly:
    runs-on: ubuntu-latest
    name: ì›”ë³„ ìš”ì•½ ë° ì•„í‚¤í…ì²˜ ìë™ ì—…ë°ì´íŠ¸
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ì „ì²´ ë°°í¬ ì´ë ¥ ì¡°íšŒ
        run: |
          gh run list \
            --repo jeonwoohyun85/content-factory \
            --status success \
            --workflow "deploy-workers.yml" \
            --limit 10000 \
            --json displayTitle,createdAt,headSha,conclusion \
            > all-runs.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ì›”ë³„ ìš”ì•½ ë° ì•„í‚¤í…ì²˜ ì„¹ì…˜ ìƒì„±
        run: |
          cat > update_monthly.py << 'SCRIPT_EOF'
          import json
          import sys
          from datetime import datetime, timedelta
          from collections import defaultdict

          # ë°°í¬ ë°ì´í„° ë¡œë“œ
          with open('all-runs.json', 'r', encoding='utf-8') as f:
              runs = json.load(f)

          # workflow_dispatch ì œì™¸
          runs = [r for r in runs if r['displayTitle'] != 'í´ë¼ìš°ë“œí”Œë ˆì–´ ì›Œì»¤ ìë™ ë°°í¬']

          # ========== 1. ì›”ë³„ ìš”ì•½ ìƒì„± ==========
          monthly_summary = defaultdict(lambda: defaultdict(list))

          for run in runs:
              timestamp = run['createdAt']
              title = run['displayTitle'].strip()

              utc_dt = datetime.fromisoformat(timestamp.replace('Z', '+00:00'))
              kst_dt = utc_dt + timedelta(hours=9)

              month_key = kst_dt.strftime('%Yë…„ %mì›”')
              date_str = kst_dt.strftime('%Y-%m-%d')

              if ':' in title:
                  category = title.split(':')[0].strip()
                  text = title.split(':', 1)[1].strip()
              else:
                  category = 'other'
                  text = title

              monthly_summary[month_key][date_str].append({
                  'category': category,
                  'title': text
              })

          # ì›”ë³„ ìš”ì•½ ì¶œë ¥
          monthly_output = []
          monthly_output.append("### ğŸ“… ì›”ë³„ ìš”ì•½\n")

          for month in sorted(monthly_summary.keys()):
              monthly_output.append(f"#### {month}")

              dates = monthly_summary[month]

              for date_str in sorted(dates.keys()):
                  items = dates[date_str]
                  date_obj = datetime.strptime(date_str, '%Y-%m-%d')

                  weekday_names = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼']
                  weekday = weekday_names[date_obj.weekday()]

                  summary_items = []
                  features = [item for item in items if item['category'] in ['feature', 'feat']]
                  fixes = [item for item in items if item['category'] in ['fix', 'bugfix']]
                  improvements = [item for item in items if item['category'] in ['improvement', 'performance']]

                  if features:
                      for f in features[:2]:
                          summary_items.append(f['title'][:50])
                  if fixes and len(summary_items) < 2:
                      for f in fixes[:1]:
                          summary_items.append(f['title'][:50])
                  if improvements and len(summary_items) < 2:
                      for i in improvements[:1]:
                          summary_items.append(i['title'][:50])

                  summary = ', '.join(summary_items) if summary_items else 'ìœ ì§€ë³´ìˆ˜'

                  monthly_output.append(f"- **{weekday} {date_obj.strftime('%m/%d')}**: {summary} ({len(items)}ê±´)")

              monthly_output.append("")

          # íŒŒì¼ ì €ì¥
          with open('monthly-summary.txt', 'w', encoding='utf-8') as f:
              f.write('\n'.join(monthly_output))

          print(f"ì›”ë³„ ìš”ì•½ ìƒì„± ì™„ë£Œ: {len(monthly_summary)}ê°œì›”")

          # ========== 2. ì´ì „ ë‹¬ ì‹ ê·œ í•­ëª© ê°ì§€ ==========
          now_kst = datetime.now() + timedelta(hours=9)

          # ì´ì „ ë‹¬ ê³„ì‚°
          first_day_this_month = now_kst.replace(day=1)
          last_day_prev_month = first_day_this_month - timedelta(days=1)
          first_day_prev_month = last_day_prev_month.replace(day=1)

          # ì´ì „ ë‹¬ ë°°í¬ë§Œ í•„í„°ë§
          prev_month_deployments = []
          for run in runs:
              timestamp = run['createdAt']
              utc_dt = datetime.fromisoformat(timestamp.replace('Z', '+00:00'))
              kst_dt = utc_dt + timedelta(hours=9)

              if first_day_prev_month.date() <= kst_dt.date() <= last_day_prev_month.date():
                  title = run['displayTitle'].strip()
                  if ':' in title:
                      category = title.split(':')[0].strip()
                      text = title.split(':', 1)[1].strip()
                  else:
                      category = 'other'
                      text = title

                  prev_month_deployments.append({
                      'category': category,
                      'title': text
                  })

          # ì‹ ê·œ í•­ëª© ê°ì§€
          new_arch = []
          new_deprecated = []
          all_titles = [d['title'] for d in prev_month_deployments]

          # ì•„í‚¤í…ì²˜ ê²°ì • ê°ì§€
          if any('Queue' in t or 'ë³‘ë ¬' in t for t in all_titles):
              new_arch.append(f"- Queue í™•ì¥ ë˜ëŠ” ìµœì í™” ({last_day_prev_month.strftime('%m/%d')})")
          if any('Sheets' in t or 'DB' in t for t in all_titles):
              new_arch.append(f"- ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡° ê°œì„  ({last_day_prev_month.strftime('%m/%d')})")

          # íê¸° ê°ì§€
          if any('íê¸°' in t or 'ì œê±°' in t or 'Revert' in t for t in all_titles):
              for item in prev_month_deployments:
                  if any(kw in item['title'] for kw in ['íê¸°', 'ì œê±°', 'Revert', 'ì‚­ì œ']):
                      new_deprecated.append(f"- {item['title'][:60]} ({last_day_prev_month.strftime('%m/%d')})")
                      break

          # ì‹ ê·œ í•­ëª© ì¶œë ¥
          with open('new-items.txt', 'w', encoding='utf-8') as f:
              if new_arch:
                  f.write("ARCH_NEW:\n")
                  f.write('\n'.join(new_arch) + '\n')
              if new_deprecated:
                  f.write("DEPRECATED_NEW:\n")
                  f.write('\n'.join(new_deprecated) + '\n')

          print("ì‹ ê·œ í•­ëª© ê°ì§€ ì™„ë£Œ")
          SCRIPT_EOF

          python3 update_monthly.py

      - name: PROJECT.md ì—…ë°ì´íŠ¸
        run: |
          python3 << 'UPDATE_EOF'
          with open('PROJECT.md', 'r', encoding='utf-8') as f:
              content = f.read()

          # ì‹ ê·œ í•­ëª© ì½ê¸°
          new_items = {}
          try:
              with open('new-items.txt', 'r', encoding='utf-8') as f:
                  lines = f.read().strip().split('\n')
                  current_section = None
                  for line in lines:
                      if line.startswith('ARCH_NEW:'):
                          current_section = 'arch'
                          new_items['arch'] = []
                      elif line.startswith('DEPRECATED_NEW:'):
                          current_section = 'deprecated'
                          new_items['deprecated'] = []
                      elif line.strip() and current_section:
                          new_items[current_section].append(line)
          except:
              new_items = {}

          # PROJECT.md íŒŒì‹±
          parts = content.split('## ë°°í¬ ì´ë ¥')
          before = parts[0]
          deploy_section = parts[1]

          # ë§ˆì¼ìŠ¤í†¤ ì¶”ì¶œ
          if '### ğŸ¯ ì£¼ìš” ë§ˆì¼ìŠ¤í†¤' in deploy_section:
              milestone_parts = deploy_section.split('### ğŸ¯ ì£¼ìš” ë§ˆì¼ìŠ¤í†¤')
              milestones = '### ğŸ¯ ì£¼ìš” ë§ˆì¼ìŠ¤í†¤' + milestone_parts[1].split('---')[0] + '---'
              after_milestone = '---' + milestone_parts[1].split('---', 1)[1] if '---' in milestone_parts[1] else ''
          else:
              milestones = ''
              after_milestone = deploy_section

          # ì•„í‚¤í…ì²˜ ì„¹ì…˜ ì¶”ì¶œ ë° ì—…ë°ì´íŠ¸
          if '### ğŸ’¡ ì£¼ìš” ì•„í‚¤í…ì²˜ ê²°ì •' in after_milestone:
              arch_parts = after_milestone.split('### ğŸ’¡ ì£¼ìš” ì•„í‚¤í…ì²˜ ê²°ì •')
              arch_header = '### ğŸ’¡ ì£¼ìš” ì•„í‚¤í…ì²˜ ê²°ì •\n'
              arch_content_parts = arch_parts[1].split('---', 1)
              arch_content = arch_content_parts[0]

              if 'arch' in new_items and new_items['arch']:
                  arch_content += '\n' + '\n'.join(new_items['arch']) + '\n'

              after_arch = '---' + arch_content_parts[1] if len(arch_content_parts) > 1 else ''
          else:
              arch_header = ''
              arch_content = ''
              after_arch = after_milestone

          # íê¸° ì„¹ì…˜
          if '### ğŸ—‘ï¸ íê¸°ëœ ì‹œë„ë“¤' in after_arch:
              dep_parts = after_arch.split('### ğŸ—‘ï¸ íê¸°ëœ ì‹œë„ë“¤')
              dep_header = '### ğŸ—‘ï¸ íê¸°ëœ ì‹œë„ë“¤\n'
              dep_content_parts = dep_parts[1].split('---', 1)
              dep_content = dep_content_parts[0]

              if 'deprecated' in new_items and new_items['deprecated']:
                  dep_content += '\n' + '\n'.join(new_items['deprecated']) + '\n'

              after_dep = '---' + dep_content_parts[1] if len(dep_content_parts) > 1 else ''
          else:
              dep_header = ''
              dep_content = ''
              after_dep = after_arch

          # ê¸°ìˆ  ìŠ¤íƒ
          stack_section = ''
          if '### ğŸ”§ ê¸°ìˆ  ìŠ¤íƒ ì§„í™”' in after_dep:
              stack_parts = after_dep.split('### ğŸ”§ ê¸°ìˆ  ìŠ¤íƒ ì§„í™”')
              stack_section = '### ğŸ”§ ê¸°ìˆ  ìŠ¤íƒ ì§„í™”' + stack_parts[1].split('---')[0] + '---'
              after_stack = '---' + stack_parts[1].split('---', 1)[1] if '---' in stack_parts[1] else ''
          else:
              after_stack = after_dep

          # ì›”ë³„ ìš”ì•½ (ìƒˆë¡œ ìƒì„±ëœ ê²ƒìœ¼ë¡œ êµì²´)
          with open('monthly-summary.txt', 'r', encoding='utf-8') as f:
              new_monthly = f.read().strip()

          # ìƒì„¸ íƒ€ì„ë¼ì¸ ì°¾ê¸°
          if '### ğŸ“‹ ìƒì„¸ íƒ€ì„ë¼ì¸' in after_stack:
              timeline = '### ğŸ“‹ ìƒì„¸ íƒ€ì„ë¼ì¸' + after_stack.split('### ğŸ“‹ ìƒì„¸ íƒ€ì„ë¼ì¸')[1]
          else:
              timeline = after_stack

          # ì¬ì¡°ë¦½
          with open('PROJECT.md', 'w', encoding='utf-8') as f:
              f.write(before.rstrip())
              f.write('\n\n## ë°°í¬ ì´ë ¥\n\n')

              if milestones:
                  f.write(milestones)
                  f.write('\n\n')

              if arch_header:
                  f.write(arch_header)
                  f.write(arch_content)
                  f.write('\n---\n\n')

              if dep_header:
                  f.write(dep_header)
                  f.write(dep_content)
                  f.write('\n---\n\n')

              if stack_section:
                  f.write(stack_section)
                  f.write('\n\n')

              f.write(new_monthly)
              f.write('\n\n---\n\n')

              f.write(timeline.strip())

          print('PROJECT.md ì—…ë°ì´íŠ¸ ì™„ë£Œ')
          UPDATE_EOF

      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add PROJECT.md
          git diff --staged --quiet || git commit -m "docs: ì›”ë³„ ìš”ì•½ ë° ì•„í‚¤í…ì²˜ ìë™ ì—…ë°ì´íŠ¸ [skip ci]"

      - name: ë³€ê²½ì‚¬í•­ í‘¸ì‹œ
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
