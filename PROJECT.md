# Content Factory 프로젝트

## 📍 현재 상태 (한눈에)

**거래처**: 2개 활성 | **병렬**: 5개 | **최대**: 4604개/일

**최근 작업**: docs: 시스템 상태 자동 동기화 스크립트 추가

**다음 단계**: 에러 로깅 추가 (Slack 또는 Sheets)

---

## 시스템 구조 (한눈에 보기)

```
┌─────────┐     ┌─────────┐     ┌──────────┐
│  Cron   │────▶│  Queue  │────▶│  Worker  │
│ (09:00) │     │ (병렬5) │     │          │
└─────────┘     └─────────┘     └────┬─────┘
                                     │
                    ┌────────────────┼────────────────┐
                    ▼                ▼                ▼
              ┌─────────┐      ┌──────────┐    ┌─────────┐
              │ Gemini  │      │  Sheets  │    │  Drive  │
              │   API   │      │   (DB)   │    │ (Image) │
              └─────────┘      └──────────┘    └─────────┘
```

### 데이터 흐름

1. Cron 트리거 (매일 09:00 KST)
2. Sheets '관리자' 조회 (구독='활성')
3. Queue에 거래처 등록 (병렬 5개)
4. Gemini API 호출 (검색 + 글 작성)
5. Drive에서 최신 이미지 조회
6. Sheets '최신포스팅' 저장
7. '크론', '상태' 컬럼 업데이트

---

## 포스팅 생성 규칙

### 콘텐츠 작성
- **본문 전체**: 2800~3200자 (공백 포함)
- **각 문단**: 280~320자
- **문단 개수**: 이미지 개수와 동일 (없으면 8~10개)
- **문단 구분**: 빈 줄 2개 (`\n\n`)

### 금지 사항
- **금지어**: 최고, 1등, 유일, 검증된
- **금지 창작**: 경력, 학력, 자격증, 수상
- **업체명**: 그대로 사용 금지

### 작성 원칙
- **핵심**: `description` 컬럼 중심
- **표현**: 간결, 핵심만
- **이미지 묘사**: 각 문단은 해당 이미지 설명
- **트렌드**: 문단당 1~2문장만

### 언어 처리
- **하드코딩**: ko, en, ja, zh-CN, zh-TW
- **기타**: Gemini API 실시간 번역
- **캐싱**: Worker 메모리 (재시작 시 초기화)

### AI 모델 설정
**Gemini 2.5 Flash (웹 검색)**:
- Temperature: 0.7
- Max Tokens: 600
- Timeout: 120초
- 출력: 500자 이내

**Gemini 3.0 Pro (포스팅)**:
- Temperature: 0.8
- Max Tokens: 8000
- Timeout: 120초
- 출력: JSON (title, body)

---

## 구글 드라이브 규칙

### 폴더 검색
1. 우선순위: 시트 `폴더명` 컬럼 정확 매칭
2. 폴백: `subdomain` 포함 검색
3. **제외**: Info, Video 폴더

### 폴더 순환
1. 오늘 날짜 폴더 (YYYY-MM-DD)
2. 알파벳순 정렬 후 순환
3. 마지막 사용: 저장소 시트 조회

### 이미지 처리
- **최대**: 10개 (초과 시 랜덤)
- **썸네일**: w400 (다운로드)
- **표시**: w800 (최종 URL)
- **포맷**: Base64 (Gemini 전송)
- **병렬**: Promise.all
- **저장**: 쉼표 구분 URL 문자열

---

## 자동 포스팅 스케줄

### KV 락
- **이름**: `cron_posting_lock`
- **TTL**: 23시간 59분 (86340초)
- **용도**: 동시 실행 방지

### 배치 처리
- **크기**: 10개씩
- **대기**: 배치 간 1초
- **필터**: `subscription = '활성'`

---

## 데이터 저장

### 저장소 시트 (전체 보관)
- **모든 포스팅 영구 보관**
- **행 높이**: 21px
- **줄바꿈**: CLIP
- **열 너비**: 관리자 시트 복사

### 최신 포스팅 시트
- **거래처당 1개만**
- **기존 행 삭제** 후 append
- **트랜잭션**: 최신포스팅 성공 → 저장소 저장

### 저장 데이터
```
도메인, 상호명, 제목, URL, 생성일시, 언어, 업종, 폴더명, 본문, 이미지
```

---

## 예외 처리

- **이미지 없음**: 텍스트만 8~10문단 생성
- **폴더 없음**: "No folders found" 에러, 중단
- **최신포스팅 실패**: 전체 중단
- **저장소 실패**: 로그만, 계속 진행
- **관리자 업데이트 실패**: 로그만

---

## 주요 기능

### 자동 포스팅 ✅

**워크플로우**: Cron(09:00) → Queue(병렬5) → Gemini API → Sheets 업데이트

**설명**: 매일 09:00 자동으로 거래처별 블로그 포스팅 생성

**핵심 함수**: scheduled(), queue()

**사용 컴포넌트**: Cron Trigger, Queue, Gemini 2.5 Flash, Gemini 3.0 Pro, Google Sheets, Google Drive

### 거래처 페이지 ✅

**워크플로우**: Request → Sheets 조회 → 동적 페이지 생성

**설명**: *.make-page.com 서브도메인으로 거래처 정보 페이지 제공

**핵심 함수**: fetch()

**사용 컴포넌트**: Cloudflare Workers, Google Sheets, Google Drive

### 포스팅 관리 ✅

**워크플로우**: API 요청 → Sheets 조회/삭제

**설명**: 포스팅 목록 조회 및 삭제 (비밀번호 인증)

**핵심 함수**: fetch()

**사용 컴포넌트**: API Endpoint, Google Sheets

### 통계 (Umami) ✅

**워크플로우**: 페이지 방문 → Umami 추적 스크립트 → Umami Cloud → 공유 URL

**설명**: 거래처별 방문 통계 제공 (로그인 없이 공개)

**구현 방식**:
- **추적**: 각 페이지에 Umami 스크립트 자동 설치
- **수집**: 방문 데이터 자동 수집 (URL, 시간, 국가 등)
- **조회**: Google Sheets 바로가기에 공유 URL 수동 등록
- **표시**: URL에 'umami' 포함 시 📊 통계 버튼으로 표시

**핵심 함수**: generateClientPage(), getLinkInfo()

**사용 컴포넌트**: Umami Cloud Analytics, Google Sheets


---

## 시스템 현황 (자동 생성)

**마지막 업데이트**: 2026-01-31 03:06:44 KST

### Cloudflare Workers 설정

- **Worker**: make-page-subdomain (2941줄)
- **Cron**: `0 0 * * *` (매일 09:00 KST)
- **Queue 병렬**: 5개 동시 처리
- **재시도**: 1회
- **Timeout**: 30초
- **TTL**: 86340초 (23.98시간)

### Google Sheets 구조

#### 📋 관리자 시트
```
도메인, 상호명, 폴더명, 성함, 주소, 언어, 연락처, 영업시간, 거래처_정보, 바로가기, info, video, 업종, 크론, 상태, 구독 (16개 컬럼)
```
- **통계ID 컬럼 제거됨**: Umami 공유 URL은 바로가기 컬럼에 수동 등록

#### 📝 최신포스팅 시트
```

```

### 환경변수 (Worker에서 사용 중)

- `ARCHIVE_SHEET_NAME`
- `DELETE_PASSWORD`
- `DRIVE_FOLDER_ID`
- `GEMINI_API_KEY`
- `GOOGLE_SERVICE_ACCOUNT_JSON`
- `GOOGLE_SHEETS_CSV_URL`
- `LATEST_POSTING_SHEET_NAME`
- `POSTING_KV`
- `POSTING_QUEUE`
- `SHEETS_ID`

### Gemini API

- **Tier**: 1 (Paid)
- **gemini-2.5-flash**: 300 RPM
- **gemini-3-pro-preview**: 150 RPM

---

## 성능 예상 (병렬 5개 기준)

- **100개 거래처**: 25분
- **1000개 거래처**: 4.2시간
- **최대 안전 처리량**: 4604개/일

---

## 배포 이력

### 2026-01-29
**15:30** ⚡ [improvement] Queue 병렬 5개 처리 + 재시도 1회 추가
**15:26** ⚡ [improvement] TTL 23시간 59분으로 변경 (크론 타이밍 충돌 방지)

### 2026-01-27
**23:30** ✨ [feature] 자동 포스팅 시스템 완성 (Scheduled Trigger)

---

## 다음 작업

- [ ] 에러 로깅 강화 (Slack 알림 또는 에러 시트)
- [ ] 거래처 1000개 이상 확장 대비 (분산 포스팅)
- [ ] Umami 통계 연동

