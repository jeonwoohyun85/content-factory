# Content Factory 프로젝트

## 📍 현재 상태 (한눈에)

**거래처**: 2개 활성 | **병렬**: 5개 | **최대**: 4604개/일

**최근 작업**: docs: 시스템 상태 자동 동기화 스크립트 추가

**다음 단계**: 에러 로깅 추가 (Slack 또는 Sheets)

---

## 시스템 구조 (한눈에 보기)

```

┌─────────┐     ┌─────────┐     ┌──────────┐

│  Cron   │────▶│  Queue  │────▶│  Worker  │

│ (09:00) │     │ (병렬5) │     │          │

└─────────┘     └─────────┘     └────┬─────┘

                                     │

                    ┌────────────────┼────────────────┐

                    ▼                ▼                ▼

              ┌─────────┐      ┌──────────┐    ┌─────────┐

              │ Gemini  │      │  Sheets  │    │  Drive  │

              │   API   │      │   (DB)   │    │ (Image) │

              └─────────┘      └──────────┘    └─────────┘

```

### 데이터 흐름

1. Cron 트리거 (매일 09:00 KST)

2. Sheets '관리자' 조회 (구독='활성')

3. Queue에 거래처 등록 (병렬 5개)

4. Gemini API 호출 (검색 + 글 작성)

5. Drive에서 최신 이미지 조회

6. Sheets '최신포스팅' 저장

7. '크론', '상태' 컬럼 업데이트

---

## 포스팅 생성 규칙

### 콘텐츠 작성

- **본문 전체**: 2800~3200자 (공백 포함)

- **각 문단**: 280~320자

- **문단 개수**: 이미지 개수와 동일 (없으면 8~10개)

- **문단 구분**: 빈 줄 2개 (`\n\n`)

### 금지 사항

- **금지어**: 최고, 1등, 유일, 검증된

- **금지 창작**: 경력, 학력, 자격증, 수상

- **업체명**: 그대로 사용 금지

### 작성 원칙

- **핵심**: `description` 컬럼 중심

- **표현**: 간결, 핵심만

- **이미지 묘사**: 각 문단은 해당 이미지 설명

- **트렌드**: 문단당 1~2문장만

### 언어 처리

- **하드코딩**: ko, en, ja, zh-CN, zh-TW

- **기타**: Gemini API 실시간 번역

- **캐싱**: Worker 메모리 (재시작 시 초기화)

### AI 모델 설정

**Gemini 2.5 Flash (웹 검색)**:

- Temperature: 0.7

- Max Tokens: 600

- Timeout: 120초

- 출력: 500자 이내

**Gemini 3.0 Pro (포스팅)**:

- Temperature: 0.8

- Max Tokens: 8000

- Timeout: 120초

- 출력: JSON (title, body)

---

## 구글 드라이브 규칙

### 폴더 검색

1. 우선순위: 시트 `폴더명` 컬럼 정확 매칭

2. 폴백: `subdomain` 포함 검색

3. **제외**: Info, Video 폴더

### 폴더 순환

1. 오늘 날짜 폴더 (YYYY-MM-DD)

2. 알파벳순 정렬 후 순환

3. 마지막 사용: 저장소 시트 조회

### 이미지 처리

- **최대**: 10개 (초과 시 랜덤)

- **썸네일**: w400 (다운로드)

- **표시**: w800 (최종 URL)

- **포맷**: Base64 (Gemini 전송)

- **병렬**: Promise.all

- **저장**: 쉼표 구분 URL 문자열

---

## 자동 포스팅 스케줄

### KV 락

- **이름**: `cron_posting_lock`

- **TTL**: 23시간 59분 (86340초)

- **용도**: 동시 실행 방지

### 배치 처리

- **크기**: 10개씩

- **대기**: 배치 간 1초

- **필터**: `subscription = '활성'`

---

## 데이터 저장

### 저장소 시트 (전체 보관)

- **모든 포스팅 영구 보관**

- **행 높이**: 21px

- **줄바꿈**: CLIP

- **열 너비**: 관리자 시트 복사

### 최신 포스팅 시트

- **거래처당 1개만**

- **기존 행 삭제** 후 append

- **트랜잭션**: 최신포스팅 성공 → 저장소 저장

### 저장 데이터

```

도메인, 상호명, 제목, URL, 생성일시, 언어, 업종, 폴더명, 본문, 이미지

```

---

## 예외 처리

- **이미지 없음**: 텍스트만 8~10문단 생성

- **폴더 없음**: "No folders found" 에러, 중단

- **최신포스팅 실패**: 전체 중단

- **저장소 실패**: 로그만, 계속 진행

- **관리자 업데이트 실패**: 로그만

---

## 주요 기능

### 자동 포스팅 ✅

**워크플로우**: Cron(09:00) → Queue(병렬5) → Gemini API → Sheets 업데이트

**설명**: 매일 09:00 자동으로 거래처별 블로그 포스팅 생성

**핵심 함수**: scheduled(), queue()

**사용 컴포넌트**: Cron Trigger, Queue, Gemini 2.5 Flash, Gemini 3.0 Pro, Google Sheets, Google Drive

### 거래처 페이지 ✅

**워크플로우**: Request → Sheets 조회 → 동적 페이지 생성

**설명**: *.make-page.com 서브도메인으로 거래처 정보 페이지 제공

**핵심 함수**: fetch()

**사용 컴포넌트**: Cloudflare Workers, Google Sheets, Google Drive

### 포스팅 관리 ✅

**워크플로우**: API 요청 → Sheets 조회/삭제

**설명**: 포스팅 목록 조회 및 삭제 (비밀번호 인증)

**핵심 함수**: fetch()

**사용 컴포넌트**: API Endpoint, Google Sheets

### 통계 (Umami) ✅

**워크플로우**: 페이지 방문 → Umami 추적 스크립트 → Umami Cloud → 공유 URL

**설명**: 거래처별 방문 통계 제공 (로그인 없이 공개)

**구현 방식**:

- **추적**: 각 페이지에 Umami 스크립트 자동 설치

- **수집**: 방문 데이터 자동 수집 (URL, 시간, 국가 등)

- **조회**: Google Sheets 바로가기에 공유 URL 수동 등록

- **표시**: URL에 'umami' 포함 시 📊 통계 버튼으로 표시

**핵심 함수**: generateClientPage(), getLinkInfo()

**사용 컴포넌트**: Umami Cloud Analytics, Google Sheets

---

## 시스템 현황 (자동 생성)

**마지막 업데이트**: 2026-01-31 03:06:44 KST

### Cloudflare Workers 설정

- **Worker**: make-page-subdomain (2941줄)

- **Cron**: `0 0 * * *` (매일 09:00 KST)

- **Queue 병렬**: 5개 동시 처리

- **재시도**: 1회

- **Timeout**: 30초

- **TTL**: 86340초 (23.98시간)

### Google Sheets 구조

#### 📋 관리자 시트

```

도메인, 상호명, 폴더명, 성함, 주소, 언어, 연락처, 영업시간, 거래처_정보, 바로가기, info, video, 업종, 크론, 상태, 구독 (16개 컬럼)

```

- **통계ID 컬럼 제거됨**: Umami 공유 URL은 바로가기 컬럼에 수동 등록

#### 📝 최신포스팅 시트

```

```

### 환경변수 (Worker에서 사용 중)

- `ARCHIVE_SHEET_NAME`

- `DELETE_PASSWORD`

- `DRIVE_FOLDER_ID`

- `GEMINI_API_KEY`

- `GOOGLE_SERVICE_ACCOUNT_JSON`

- `GOOGLE_SHEETS_CSV_URL`

- `LATEST_POSTING_SHEET_NAME`

- `POSTING_KV`

- `POSTING_QUEUE`

- `SHEETS_ID`

### Gemini API

- **Tier**: 1 (Paid)

- **gemini-2.5-flash**: 300 RPM

- **gemini-3-pro-preview**: 150 RPM

---

## 성능 예상 (병렬 5개 기준)

- **100개 거래처**: 25분

- **1000개 거래처**: 4.2시간

- **최대 안전 처리량**: 4604개/일

---

## 배포 이력

### 📋 주간 히스토리 (1/26~1/31)

#### 2026-01-26 (일)
Cloudflare Workers 기반 서브도메인 시스템을 구축하고 00001 서브도메인 UI를 개선했다. Supabase 신규 프로젝트를 연동하여 동적 페이지 생성 기능을 구현했으며, GitHub Actions 워크플로우를 추가하고 자동 배포 환경을 구성했다. 갤러리 섹션을 Info로 변경하고 모바일/PC 레이아웃을 통일했다. 헤더 텍스트와 이모지를 정리하여 UI를 간소화했으며, 사용하지 않는 Deploy Preview 워크플로우를 삭제했다. PROJECT.md를 업데이트하고 자동화 워크플로우를 추가했다.

#### 2026-01-27 (화)
Worker 코드를 대폭 간소화하여 5540줄에서 526줄로 축소했다. 자동 포스팅 시스템을 완성하고 Scheduled handler를 적용했으며, Google Drive에서 Sheets로 자동화하는 Worker를 추가했다. 포스트 상세 페이지와 삭제 기능을 구현하고 비밀번호 인증을 추가했다. Retention Policy를 변경하여 1개 포스트 유지 정책을 적용한 후 모든 포스팅 보관으로 전환했다. GitHub Actions 워크플로우 이름을 한글로 완전히 현지화했다. Sheet1 이름 변경 프록시 엔드포인트를 추가하고, 이미지 조회 로그와 Drive API 디버깅을 강화했다. posting-generator Worker를 폐기하고 make-page-subdomain에 통합했으며, 폐기된 설정 파일들을 삭제했다. Gemini API 모델을 1.5-pro로 업데이트하고 /generate-post 엔드포인트를 추가했다.

#### 2026-01-28 (수)
Posts 시트를 폐기하고 저장소+최신포스팅 3개 탭 구조로 확정했다. 최신 포스팅 시트 자동 저장 기능을 추가하고 거래처당 2개만 유지하도록 동적 관리를 구현했다. 모든 시트 컬럼을 동적 매핑으로 전환하여 순서 무관하게 처리하도록 개선했다. Posts 시트 역순 검색과 subdomain 정규화를 적용했으며, 포스트 삭제 로직을 강화하여 날짜 비교 오차를 허용하고 시간 차이가 가장 적은 포스트를 검색하도록 했다. 이미지 다운로드를 병렬화하여 속도를 3-5배 향상시켰다. Info 섹션에 구글 드라이브 URL 썸네일 변환을 추가하고, 유효하지 않은 바로가기 링크를 필터링했다. drive-to-sheets를 폐기하고 wrangler.toml gid를 수정했다. 포스트 목록 그리드 레이아웃을 최적화하여 PC 2열, 모바일 1열을 적용했다.

#### 2026-01-29 (목)
Queue 병렬 처리를 5개로 확장하고 재시도를 3회로 증가시켰다. TTL을 23시간 59분으로 변경하여 크론 타이밍 충돌을 방지했으며, Workers Unbound 모드를 활성화하여 CPU 제한을 30초로 확장했다. 구독/상태 컬럼을 분리하고 자동 상태 업데이트 기능을 구현했다. 크론 예정 시간 자동 업데이트를 추가하고, 스마트스토어 링크 아이콘을 추가했다. 포스트 본문과 이미지 저장 및 표시 기능을 구현했으며, 포스팅 언어 설정 누락을 수정했다. Gemini API timeout을 120초로 증가시키고, Queue consumer 에러 로깅을 강화했다. test-sheet 엔드포인트를 추가하여 시트 데이터 디버깅을 개선했다. 저장소 시트 중복 읽기를 제거하여 성능을 향상시켰으며, post1/post2 로직을 완전히 삭제했다. 시스템 상태 자동 동기화 스크립트를 추가했다.

#### 2026-01-30 (금)
D1 기반 통계 기능을 추가하고 데이터베이스 설정 워크플로우를 구현했다. D1 스키마를 생성하고 analytics 데이터베이스 바인딩을 추가했다. 통계 첫 방문 시 자동 생성 기능을 구현하고, Umami Website를 크론으로 자동 생성하도록 했다. Google Sheets '통계ID' 컬럼 연동을 추가했으며, 통계ID가 없으면 무조건 재생성하도록 개선했다. SPA 방식 통계 구현을 시도했으나 파일 분할 방식을 되돌렸다. 포스트 표시를 2개에서 1개로 변경했다. Worker 파일 손상을 수정하고 이름을 make-page-subdomain으로 변경했다. 워크플로우 환경 지정을 제거하고 umami credentials 파일을 gitignore에 추가했다.

#### 2026-01-31 (토)
Cron 중복 실행 방지를 위해 날짜별 락 키를 적용하고 KV 락 TTL을 48시간으로 설정했다. Google Sheets 텍스트 줄바꿈을 WRAP으로 강제 적용하여 가독성을 개선했다. 최신포스팅 시트 도메인 비교 정규화를 추가하고 전체 삭제 후 append 방식으로 변경했으며, 저장소 시트에 KST 시간 표시를 적용했다. 최신 포스팅과 저장소 시트 간 데이터 정합성을 개선하여 중복 저장 및 누락 문제를 해결했다. PROJECT.md 구조를 대폭 개편하여 배포 이력 전체 230개를 날짜별로 분류하고 주간 요약 섹션을 추가했다. 자동 업데이트 워크플로우를 추가하여 배포 이력과 시스템 현황을 자동으로 관리하도록 했으며, 아키텍처 결정 및 폐기 이력 섹션을 추가했다. 이후 주간 요약을 월별 요약으로 변경하고 기술 스택 진화 섹션을 제거했다. 배포일지 일괄 업로드 워크플로우를 추가했으나 곧바로 폐기했다. Umami 통계 연동을 개선하여 '우마미'와 '우마미공유' 컬럼을 추가하고 동적 Website ID 매핑을 구현했다. 다국어 번역 기능을 대폭 강화하여 모든 UI 텍스트에 postImage와 galleryImage 다국어 지원을 추가하고, 상호명에서 언어 표시를 자동 제거하는 기능을 구현했다. Gemini 2.5 Flash API를 활용한 동적 번역 시스템을 구축하여 business_name, address, business_hours를 자동 번역하도록 했다. 번역 과정에서 템플릿 리터럴 줄바꿈 오류와 변수명 충돌 문제를 수정했으며, getClientFromSheetsForPosting 함수에도 번역 로직을 추가했다. 번역 API 토큰 부족 문제를 발견하여 maxOutputTokens를 500에서 8000으로 증가시켰다. 캐싱 기능 추가를 시도했으나 코드 복잡도로 인해 실패하여 번역 정상 작동 버전으로 롤백했다.

